<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tamer Educational Activities - Complete Version</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    // Pre-declare all global functions to avoid ReferenceError
    window.selectTemplate = function() {};
    window.toggleMode = function() {};
    window.resetActivity = function() {};
    window.updateActivityTitle = function() {};
    window.removeMCQQuestion = function() {};
    window.updateMCQQuestion = function() {};
    window.updateMCQOption = function() {};
    window.updateMCQCorrectIndex = function() {};
    window.checkTrueFalseAnswer = function() {};
    window.removeTrueFalseItem = function() {};
    window.updateTrueFalseStatement = function() {};
    window.updateTrueFalseAnswer = function() {};
    window.removeFlipCard = function() {};
    window.updateFlipCard = function() {};
    window.removeDragDropPair = function() {};
    window.updateDragDropPair = function() {};
    window.checkDragDropAnswers = function() {};
    window.checkMCQAnswer = function() {};
    window.saveActivity = function() {};
    window.loadActivity = function() {};
    window.updateStatus = function() {};
    window.loadDummyData = function() {};
    window.updateActivityDisplay = function() {};
    window.renderPlayMode = function() {};
    window.renderEditMode = function() {};
    window.renderMCQPlayMode = function() {};
    window.renderMCQEditMode = function() {};
    window.renderTrueFalsePlayMode = function() {};
    window.renderTrueFalseEditMode = function() {};
    window.renderFlipCardsPlayMode = function() {};
    window.renderFlipCardsEditMode = function() {};
    window.renderDragDropPlayMode = function() {};
    window.renderDragDropEditMode = function() {};
    window.toggleTheme = function() {};
    window.initTheme = function() {};
    
    // Theme configuration - Comprehensive Education Palette
    const themeConfig = {
      dark: {
        background: '#0f1419',
        backgroundGradient: '#1a1f2e',
        card: '#1e2433',
        cardBorder: '#2d3548',
        buttonBg: '#252d3d',
        buttonBorder: '#3d4a5f',
        text: '#f8fafc',
        muted: '#94a3b8',
        divider: '#334155',
        dragBorder: '#475569',
        dropBorder: '#64748b',
        dragBg: '#1e293b',
        dropBg: '#1e293b',
        hoverBg: '#334155',
        // Semantic colors
        primary: '#2563eb',
        secondary: '#6366f1',
        accent: '#14b8a6',
        success: '#10b981',
        warn: '#f59e0b',
        error: '#f43f5e'
      },
      light: {
        background: '#f8fafc',
        backgroundGradient: '#f1f5f9',
        card: '#ffffff',
        cardBorder: '#e2e8f0',
        buttonBg: '#ffffff',
        buttonBorder: '#cbd5e1',
        text: '#0f172a',
        muted: '#64748b',
        divider: '#e2e8f0',
        dragBorder: '#94a3b8',
        dropBorder: '#94a3b8',
        dragBg: '#f8fafc',
        dropBg: '#f8fafc',
        hoverBg: '#f1f5f9',
        // Semantic colors (same for both modes)
        primary: '#2563eb',
        secondary: '#6366f1',
        accent: '#14b8a6',
        success: '#10b981',
        warn: '#f59e0b',
        error: '#f43f5e'
      }
    };
    
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            // Custom Color Palette
            jasmine: {
              DEFAULT: '#ffe588',
              100: '#4f3e00',
              200: '#9d7b00',
              300: '#ecb900',
              400: '#ffd53b',
              500: '#ffe588',
              600: '#ffeba1',
              700: '#fff0b9',
              800: '#fff5d0',
              900: '#fffae8'
            },
            atomic_tangerine: {
              DEFAULT: '#f79d65',
              100: '#421b03',
              200: '#843707',
              300: '#c6520a',
              400: '#f37222',
              500: '#f79d65',
              600: '#f8b083',
              700: '#fac4a2',
              800: '#fcd8c1',
              900: '#fdebe0'
            },
            imperial_red: {
              DEFAULT: '#f35252',
              100: '#3d0404',
              200: '#7a0808',
              300: '#b70d0d',
              400: '#ef1616',
              500: '#f35252',
              600: '#f57676',
              700: '#f89898',
              800: '#fababa',
              900: '#fddddd'
            },
            aquamarine: {
              DEFAULT: '#5ef2d5',
              100: '#053e33',
              200: '#0a7d66',
              300: '#0fbb98',
              400: '#20edc4',
              500: '#5ef2d5',
              600: '#7ff5dd',
              700: '#9ff7e6',
              800: '#bffaee',
              900: '#dffcf7'
            },
            argentinian_blue: {
              DEFAULT: '#60b5ff',
              100: '#002646',
              200: '#004b8d',
              300: '#0071d3',
              400: '#1b94ff',
              500: '#60b5ff',
              600: '#81c4ff',
              700: '#a0d3ff',
              800: '#c0e1ff',
              900: '#dff0ff'
            },
            // Primary - Blue (Trust, Learning)
            primary: {
              50: '#eff6ff',
              100: '#dbeafe',
              200: '#bfdbfe',
              300: '#93c5fd',
              400: '#60a5fa',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8',
              800: '#1e40af',
              900: '#1e3a8a',
              DEFAULT: '#2563eb'
            },
            // Secondary - Indigo (Creativity)
            secondary: {
              50: '#eef2ff',
              100: '#e0e7ff',
              200: '#c7d2fe',
              300: '#a5b4fc',
              400: '#818cf8',
              500: '#6366f1',
              600: '#4f46e5',
              700: '#4338ca',
              800: '#3730a3',
              900: '#312e81',
              DEFAULT: '#6366f1'
            },
            // Accent - Teal (Innovation, Fresh)
            accent: {
              50: '#f0fdfa',
              100: '#ccfbf1',
              200: '#99f6e4',
              300: '#5eead4',
              400: '#2dd4bf',
              500: '#14b8a6',
              600: '#0d9488',
              700: '#0f766e',
              800: '#115e59',
              900: '#134e4a',
              DEFAULT: '#14b8a6'
            },
            // Success - Emerald
            success: {
              50: '#ecfdf5',
              100: '#d1fae5',
              200: '#a7f3d0',
              300: '#6ee7b7',
              400: '#34d399',
              500: '#10b981',
              600: '#059669',
              700: '#047857',
              800: '#065f46',
              900: '#064e3b',
              DEFAULT: '#10b981'
            },
            // Warning - Amber (Energy, Attention)
            warn: {
              50: '#fffbeb',
              100: '#fef3c7',
              200: '#fde68a',
              300: '#fcd34d',
              400: '#fbbf24',
              500: '#f59e0b',
              600: '#d97706',
              700: '#b45309',
              800: '#92400e',
              900: '#78350f',
              DEFAULT: '#f59e0b'
            },
            // Error - Rose (Alerts)
            err: {
              50: '#fff1f2',
              100: '#ffe4e6',
              200: '#fecdd3',
              300: '#fda4af',
              400: '#fb7185',
              500: '#f43f5e',
              600: '#e11d48',
              700: '#be123c',
              800: '#9f1239',
              900: '#881337',
              DEFAULT: '#f43f5e'
            },
            // Neutrals
            card: '#1e2433',
            background: '#0f1419',
            text: '#e8f0f2',
            muted: '#a2b5cd'
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer base {
      body {
        @apply text-text min-h-screen;
        background: linear-gradient(to bottom, var(--background), var(--background-gradient));
      }
      
      /* Theme variables - Comprehensive Education Colors */
      :root {
        --background: #0f1419;
        --background-gradient: #1a1f2e;
        --card: #1e2433;
        --card-border: #2d3548;
        --button-bg: #252d3d;
        --button-border: #3d4a5f;
        --text: #f8fafc;
        --muted: #94a3b8;
        --divider: #334155;
        --drag-border: #475569;
        --drop-border: #64748b;
        --drag-bg: #1e293b;
        --drop-bg: #1e293b;
        --hover-bg: #334155;
        
        /* Semantic colors */
        --primary: #2563eb;
        --primary-hover: #1d4ed8;
        --secondary: #6366f1;
        --secondary-hover: #4f46e5;
        --accent: #14b8a6;
        --accent-hover: #0d9488;
        --success: #10b981;
        --success-hover: #059669;
        --success-bg: rgba(16, 185, 129, 0.2);
        --success-bg-hover: rgba(16, 185, 129, 0.3);
        --warn: #f59e0b;
        --warn-hover: #d97706;
        --error: #f43f5e;
        --error-hover: #e11d48;
        --error-bg: rgba(244, 63, 94, 0.2);
        --error-bg-hover: rgba(244, 63, 94, 0.3);
        --warn-bg: rgba(245, 158, 11, 0.2);
      }
      
      .theme-light {
        --background: #f8fafc;
        --background-gradient: #f1f5f9;
        --card: #ffffff;
        --card-border: #e2e8f0;
        --button-bg: #ffffff;
        --button-border: #cbd5e1;
        --text: #0f172a;
        --muted: #64748b;
        --divider: #e2e8f0;
        --drag-border: #94a3b8;
        --drop-border: #94a3b8;
        --drag-bg: #f8fafc;
        --drop-bg: #f8fafc;
        --hover-bg: #f1f5f9;
        
        /* Semantic colors */
        --primary: #2563eb;
        --primary-hover: #1d4ed8;
        --secondary: #6366f1;
        --secondary-hover: #4f46e5;
        --accent: #14b8a6;
        --accent-hover: #0d9488;
        --success: #10b981;
        --success-hover: #059669;
        --success-bg: rgba(16, 185, 129, 0.2);
        --success-bg-hover: rgba(16, 185, 129, 0.3);
        --warn: #f59e0b;
        --warn-hover: #d97706;
        --error: #f43f5e;
        --error-hover: #e11d48;
        --error-bg: rgba(244, 63, 94, 0.2);
        --error-bg-hover: rgba(244, 63, 94, 0.3);
        --warn-bg: rgba(245, 158, 11, 0.2);
      }
      
      body.theme-light {
        background: linear-gradient(to bottom, var(--background), var(--background-gradient));
        color: var(--text);
      }
      
      body {
        background: linear-gradient(to bottom, var(--background), var(--background-gradient));
        color: var(--text);
      }
    }
    
    @layer components {
      .card {
        @apply rounded-xl p-6 shadow-lg transition-all hover:shadow-xl;
        background-color: var(--card);
        border: 1px solid var(--card-border);
      }
      .btn {
        @apply px-6 py-3 rounded-lg cursor-pointer transition-colors font-medium;
        background-color: var(--button-bg);
        border: 1px solid var(--button-border);
        color: var(--text);
      }
      .btn-primary {
        background: var(--primary);
        @apply border-transparent text-white font-bold transition-all shadow-md hover:shadow-lg;
      }
      .btn-primary:hover {
        background: var(--primary-hover);
      }
      .btn-secondary {
        background: var(--secondary);
        @apply border-transparent text-white font-bold transition-all shadow-md hover:shadow-lg;
      }
      .btn-secondary:hover {
        background: var(--secondary-hover);
      }
      .btn-accent {
        background: var(--accent);
        @apply border-transparent text-white font-bold transition-all shadow-md hover:shadow-lg;
      }
      .btn-accent:hover {
        background: var(--accent-hover);
      }
      .btn-success {
        background: var(--success);
        @apply border-transparent text-white font-bold transition-all shadow-md hover:shadow-lg;
      }
      .btn-success:hover {
        background: var(--success-hover);
      }
      .btn-warn {
        background: var(--warn);
        @apply border-transparent text-white font-bold transition-all shadow-md hover:shadow-lg;
      }
      .btn-warn:hover {
        background: var(--warn-hover);
      }
      .btn-error {
        background: var(--error);
        @apply border-transparent text-white font-bold transition-all shadow-md hover:shadow-lg;
      }
      .btn-error:hover {
        background: var(--error-hover);
      }
      .btn-ghost {
        @apply bg-transparent;
        background-color: transparent;
      }
      .btn-ghost:hover {
        background-color: var(--hover-bg);
      }
      .pill {
        @apply px-3 py-1 rounded-full text-sm;
        border: 1px solid var(--button-border);
        color: var(--muted);
      }
      .divider {
        @apply h-px my-6;
        background-color: var(--divider);
      }
      .flip-card {
        @apply rounded-lg p-6 cursor-pointer min-h-[120px] flex items-center justify-center transition-all hover:scale-105;
        background-color: var(--button-bg);
        border: 1px solid var(--button-border);
      }
      .flip-card:hover {
        border-color: var(--primary);
      }
      .drag-item {
        @apply p-3 border border-dashed rounded-lg my-2 cursor-move transition-all;
        border-color: var(--drag-border);
        background-color: var(--drag-bg);
      }
      .drag-item:hover {
        border-color: var(--primary);
        background-color: var(--hover-bg);
      }
      .drop-zone {
        @apply min-h-[50px] border border-dashed rounded-lg p-3 transition-all;
        border-color: var(--drop-border);
        background-color: var(--drop-bg);
      }
      .drop-zone:hover {
        border-color: var(--primary);
      }
      .template-card {
        @apply border rounded-xl p-6 transition-all hover:scale-[1.02] cursor-pointer;
        border: 1px solid var(--card-border);
        background: linear-gradient(135deg, var(--button-bg) 0%, var(--card) 100%);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .template-card:hover {
        border-color: var(--primary);
        box-shadow: 0 8px 24px rgba(37, 99, 235, 0.2);
        transform: translateY(-2px);
      }
      .stat-card {
        @apply border rounded-xl p-6 text-center;
        background: linear-gradient(135deg, var(--button-bg) 0%, var(--card) 100%);
        border: 1px solid var(--card-border);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      .template-icon {
        @apply w-12 h-12 rounded-lg flex items-center justify-center transition-all;
        background: linear-gradient(135deg, var(--drag-bg) 0%, var(--button-bg) 100%);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .template-icon.icon-primary {
        color: var(--primary);
      }
      .template-icon.icon-secondary {
        color: var(--secondary);
      }
      .template-icon.icon-accent {
        color: var(--accent);
      }
      .template-icon.icon-success {
        color: var(--success);
      }
      .template-icon.icon-warn {
        color: var(--warn);
      }
      .template-card:hover .template-icon {
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      .content-reveal-panel {
        @apply p-6 rounded-lg cursor-pointer transition-all duration-300 min-h-[120px] text-white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .content-reveal-panel:hover {
        @apply scale-105;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
      }
      .content-reveal-panel.expanded {
        @apply min-h-[200px];
      }
      
      .mental-drag-item {
        @apply p-4 border-2 border-dashed rounded-lg cursor-move transition-all text-white;
        background-color: #FD7505;
        border-color: #FF7300;
      }
      .mental-drag-item:hover {
        @apply scale-105;
      }
      
      .mental-drop-zone {
        @apply p-4 border-2 rounded-lg min-h-[80px] transition-all text-white;
        background-color: #53C67F;
        border-color: #34C26B;
      }
      .mental-drop-zone:hover {
        @apply shadow-lg;
      }
      .mental-drop-zone.correct {
        background-color: #59C984;
        border-color: #34C26B;
      }
      .mental-drop-zone.incorrect {
        background-color: #D11F31;
        border-color: #C81628;
      }
      
      .pick-many-item {
        @apply p-4 rounded-2xl cursor-pointer transition-all duration-300 text-white;
        background-color: #9F75D4;
      }
      .pick-many-item:hover {
        box-shadow: 0 0 24px rgba(159, 117, 212, 0.5);
      }
      .pick-many-item.selected {
        box-shadow: 0 0 15px rgba(93, 202, 135, 0.8);
      }
      .pick-many-item.correct {
        background-color: #5DCA87;
      }
      .pick-many-item.incorrect {
        background-color: #C81628;
      }
      
      .info-card {
        @apply rounded-xl p-8 transition-all text-white;
        background: linear-gradient(135deg, #5EA2E3 0%, #4a8bc2 100%);
      }
      
      /* Swivel animation */
      @keyframes swivel {
        0% { transform: rotate(0deg) scale(0); opacity: 0; }
        50% { transform: rotate(180deg) scale(1.1); }
        100% { transform: rotate(360deg) scale(1); opacity: 1; }
      }
      .swivel-enter {
        animation: swivel 0.75s ease-out;
      }
      
      /* Float animation */
      @keyframes float-up {
        0% { transform: translateY(30px); opacity: 0; }
        100% { transform: translateY(0); opacity: 1; }
      }
      .float-enter {
        animation: float-up 0.75s ease-out;
      }
      
      /* Fade animation */
      @keyframes fade-in {
        0% { opacity: 0; }
        100% { opacity: 1; }
      }
      .fade-enter {
        animation: fade-in 0.75s ease-out;
      }
      
      /* Sidebar Layout Styles */
      .app-container {
        display: flex;
        min-height: calc(100vh - 80px);
      }
      
      .sidebar {
        width: 280px;
        position: sticky;
        top: 80px;
        height: calc(100vh - 80px);
        overflow-y: auto;
        padding: 1.5rem;
        border-right: 1px solid var(--divider);
        background-color: var(--card);
      }
      
      .sidebar::-webkit-scrollbar {
        width: 6px;
      }
      
      .sidebar::-webkit-scrollbar-track {
        background: var(--button-bg);
      }
      
      .sidebar::-webkit-scrollbar-thumb {
        background: var(--button-border);
        border-radius: 3px;
      }
      
      .sidebar::-webkit-scrollbar-thumb:hover {
        background: var(--muted);
      }
      
      .sidebar-section {
        margin-bottom: 2rem;
      }
      
      .sidebar-title {
        font-size: 0.75rem;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--muted);
        margin-bottom: 0.75rem;
      }
      
      .sidebar-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
        background-color: transparent;
        border: 1px solid transparent;
      }
      
      .sidebar-item:hover {
        background-color: var(--hover-bg);
        border-color: var(--card-border);
      }
      
      .sidebar-item.active {
        background-color: var(--button-bg);
        border-color: var(--primary);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      
      .sidebar-icon {
        width: 2rem;
        height: 2rem;
        display: flex;
        align-items: center;
      }
      
      /* Interactive Video Overlay */
      .video-question-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 75%;
        max-width: 600px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        z-index: 10;
        text-align: center;
      }
      
      .video-question-overlay .video-option {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        transition: all 0.3s ease;
      }
      
      .video-question-overlay .video-option:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.6);
      }
      
      .video-question-overlay .video-option:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }
      
      /* CSS-only icons */
      .icon {
        display: inline-block;
        width: 16px;
        height: 16px;
        position: relative;
      }
      
      .icon-fullscreen {
        width: 14px;
        height: 14px;
      }
      
      .icon-fullscreen::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 6px;
        height: 6px;
        border: 2px solid currentColor;
        border-right: none;
        border-bottom: none;
      }
      
      .icon-fullscreen::after {
        content: '';
        position: absolute;
        bottom: 0;
        right: 0;
        width: 6px;
        height: 6px;
        border: 2px solid currentColor;
        border-left: none;
        border-top: none;
      }
      
      .icon-volume {
        width: 16px;
        height: 16px;
        position: relative;
        display: inline-block;
        color: var(--text);
        vertical-align: middle;
      }
      
      .icon-volume::before {
        content: '';
        position: absolute;
        top: 4px;
        left: 2px;
        width: 6px;
        height: 8px;
        background: currentColor;
        clip-path: polygon(0 0, 100% 20%, 100% 80%, 0 100%);
      }
      
      .icon-volume::after {
        content: '';
        position: absolute;
        top: 5px;
        left: 8px;
        width: 2px;
        height: 6px;
        background: currentColor;
        border-radius: 1px;
      }
      
      .icon-volume-mute {
        width: 16px;
        height: 16px;
        position: relative;
        display: inline-block;
        color: var(--text);
        vertical-align: middle;
      }
      
      .icon-volume-mute::before {
        content: '';
        position: absolute;
        top: 4px;
        left: 2px;
        width: 6px;
        height: 8px;
        background: currentColor;
        clip-path: polygon(0 0, 100% 20%, 100% 80%, 0 100%);
      }
      
      .icon-volume-mute::after {
        content: '';
        position: absolute;
        top: 5px;
        left: 8px;
        width: 2px;
        height: 6px;
        background: currentColor;
        border-radius: 1px;
        opacity: 0.3;
      }
      
      .icon-volume-mute::before {
        content: '';
        position: absolute;
        top: 4px;
        left: 2px;
        width: 6px;
        height: 8px;
        background: currentColor;
        clip-path: polygon(0 0, 100% 20%, 100% 80%, 0 100%);
      }
      
      .icon-volume-mute::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 2px;
        width: 12px;
        height: 2px;
        background: currentColor;
        transform: rotate(45deg);
        transform-origin: center;
        border-radius: 1px;
      }
      
      .btn-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        font-size: 1rem;
        flex-shrink: 0;
      }
      
      .sidebar-content {
        flex: 1;
        min-width: 0;
      }
      
      .sidebar-item-name {
        font-weight: 600;
        font-size: 0.875rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .sidebar-item-desc {
        font-size: 0.75rem;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .main-content {
        flex: 1;
        padding: 2rem;
        overflow-x: hidden;
      }
      
      @media (max-width: 1024px) {
        .sidebar {
          position: fixed;
          left: -280px;
          top: 80px;
          z-index: 20;
          transition: left 0.3s;
          box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar.open {
          left: 0;
        }
        
        .sidebar-overlay {
          position: fixed;
          inset: 0;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 19;
          display: none;
        }
        
        .sidebar-overlay.open {
          display: block;
        }
      }
      
      /* Theme Variants */
      
      /* Minimal Theme */
      body.theme-minimal {
        --background: #ffffff;
        --background-gradient: #f8f9fa;
        --card: #ffffff;
        --text: #000000;
        --muted: #6c757d;
        --primary: #000000;
        --primary-hover: #333333;
        --secondary: #495057;
        --button-bg: #f8f9fa;
        --button-border: #dee2e6;
        --card-border: #e9ecef;
      }
      
      /* Chalkboard Theme */
      body.theme-chalkboard {
        --background: #2d3e2f;
        --background-gradient: #1f2b20;
        --card: #3d4e3f;
        --text: #f0f0e8;
        --muted: #a8b5a3;
        --primary: #88cc88;
        --primary-hover: #66aa66;
        --secondary: #ffcc66;
        --accent: #ff9966;
        --success: #88dd88;
        --warn: #ffbb55;
        --error: #ff6666;
        --button-bg: #4d5e4f;
        --button-border: #5d6e5f;
        --card-border: #5d6e5f;
        font-family: 'Courier New', monospace;
      }
      
      body.theme-chalkboard .card,
      body.theme-chalkboard .template-card,
      body.theme-chalkboard .stat-card {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }
      
      /* Neon Theme */
      body.theme-neon {
        --background: #0a0e27;
        --background-gradient: #1a1e47;
        --card: #1a1e47;
        --text: #ffffff;
        --muted: #8892b0;
        --primary: #00ffff;
        --primary-hover: #00dddd;
        --secondary: #ff00ff;
        --accent: #00ff00;
        --success: #00ff88;
        --warn: #ffff00;
        --error: #ff0066;
        --button-bg: #2a2e67;
        --button-border: #3a3e87;
        --card-border: #3a3e87;
      }
      
      body.theme-neon .card,
      body.theme-neon .template-card,
      body.theme-neon .stat-card {
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        border: 1px solid rgba(0, 255, 255, 0.3);
      }
      
      body.theme-neon .btn-primary {
        box-shadow: 0 0 10px var(--primary);
      }
      
      body.theme-neon .btn-secondary {
        box-shadow: 0 0 10px var(--secondary);
      }
      
      body.theme-neon .btn-accent {
        box-shadow: 0 0 10px var(--accent);
      }
      
      /* Vibrant Theme - Custom Color Palette */
      body.theme-vibrant {
        --background: #ffffff;
        --background-gradient: #fffae8;
        --card: #ffffff;
        --text: #0f172a;
        --muted: #64748b;
        --primary: #60b5ff;        /* Argentinian Blue */
        --primary-hover: #81c4ff;
        --secondary: #f79d65;      /* Atomic Tangerine */
        --accent: #5ef2d5;         /* Aquamarine */
        --success: #5ef2d5;        /* Aquamarine */
        --warn: #ffe588;           /* Jasmine */
        --error: #f35252;          /* Imperial Red */
        --button-bg: #fffae8;
        --button-border: #ffe588;
        --card-border: #ffeba1;
        --drag-bg: #fff5d0;
        --drop-bg: #dffcf7;
      }
      
      body.theme-vibrant .card,
      body.theme-vibrant .template-card,
      body.theme-vibrant .stat-card {
        box-shadow: 0 4px 12px rgba(96, 181, 255, 0.15);
        border: 2px solid var(--card-border);
        transition: all 0.3s ease;
      }
      
      body.theme-vibrant .card:hover,
      body.theme-vibrant .template-card:hover,
      body.theme-vibrant .stat-card:hover {
        box-shadow: 0 8px 24px rgba(94, 242, 213, 0.25);
        transform: translateY(-2px);
      }
      
      body.theme-vibrant .btn-primary {
        background: linear-gradient(135deg, #60b5ff 0%, #5ef2d5 100%);
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(96, 181, 255, 0.3);
      }
      
      body.theme-vibrant .btn-primary:hover {
        background: linear-gradient(135deg, #81c4ff 0%, #7ff5dd 100%);
        box-shadow: 0 6px 16px rgba(96, 181, 255, 0.4);
        transform: translateY(-1px);
      }
      
      body.theme-vibrant .btn-secondary {
        background: linear-gradient(135deg, #f79d65 0%, #ffe588 100%);
        color: #421b03;
        border: none;
        box-shadow: 0 4px 12px rgba(247, 157, 101, 0.3);
      }
      
      body.theme-vibrant .btn-secondary:hover {
        background: linear-gradient(135deg, #f8b083 0%, #ffeba1 100%);
        box-shadow: 0 6px 16px rgba(247, 157, 101, 0.4);
      }
      
      body.theme-vibrant .btn-accent {
        background: #5ef2d5;
        color: #053e33;
        border: 2px solid #0fbb98;
      }
      
      body.theme-vibrant .btn-accent:hover {
        background: #7ff5dd;
        border-color: #20edc4;
      }
      
      body.theme-vibrant .sidebar {
        background: linear-gradient(180deg, #ffffff 0%, #fffae8 100%);
        border-right: 2px solid #ffe588;
      }
      
      body.theme-vibrant .sidebar-item.active {
        background: linear-gradient(135deg, #dff0ff 0%, #dffcf7 100%);
        border-left: 4px solid #60b5ff;
      }
      
      body.theme-vibrant .pill {
        background: linear-gradient(135deg, #ffe588 0%, #ffeba1 100%);
        color: #4f3e00;
        border: 2px solid #ffd53b;
      }
    }
    
    /* Crossword Puzzle Styles */
    .crossword-container {
      display: flex;
      flex-wrap: wrap;
    }
    
    .crossword-grid {
      display: grid;
      gap: 0;
      border: 2px solid var(--text);
      max-width: 100%;
      overflow: auto;
    }
    
    .crossword-cell {
      aspect-ratio: 1;
      border-right: 1px solid var(--text);
      border-bottom: 1px solid var(--text);
      text-align: center;
      vertical-align: middle;
      font-weight: bold;
      font-size: 1.2em;
      position: relative;
      background-color: var(--card);
      outline: none;
      user-select: none;
    }
    
    /* Add borders to the top row and left column to complete the grid */
    .crossword-grid > .crossword-cell:nth-child(-n+10) { /* Top row */
      border-top: 1px solid var(--text);
    }
    
    .crossword-grid > .crossword-cell:nth-child(10n+1) { /* Left column */
      border-left: 1px solid var(--text);
    }
    
    .crossword-cell:focus {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary-hover);
    }
    
    .crossword-cell[data-solution] {
      background-color: var(--drag-bg);
    }
    
    .crossword-clues {
      flex: 1;
      min-width: 250px;
    }
    
    .crossword-across, .crossword-down {
      margin-bottom: 1.5rem;
    }
    
    .crossword-clues div {
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 0.25rem;
      transition: background-color 0.2s;
    }
    
    .crossword-clues div:hover {
      background-color: var(--hover-bg);
    }
    
    @media (max-width: 768px) {
      .crossword-container {
        flex-direction: column;
      }
    }
  </style>
</head>
<body class="font-sans">
  <!-- Header -->
  <header class="sticky top-0 z-10 p-4 border-b flex items-center justify-between backdrop-blur-sm bg-opacity-80" style="background-color: var(--background); border-color: var(--divider);">
    <div class="flex items-center gap-2">
      <h1 class="text-xl lg:text-2xl font-bold flex items-center gap-2">
        <i class="fas fa-graduation-cap text-primary"></i>
        <span class="hidden sm:inline">Tamer Educational Activities</span>
        <span class="sm:hidden">Tamer</span>
      </h1>
    </div>
    
    <!-- Navigation Links -->
    <nav class="hidden lg:flex items-center gap-1">
      <button class="btn btn-ghost text-sm px-3" onclick="showHomePage()">
        <i class="fas fa-home mr-1"></i>
        Home
      </button>
      <button class="btn btn-ghost text-sm px-3" onclick="showPricePlans()">
        <i class="fas fa-tag mr-1"></i>
        Price Plans
      </button>
      <button class="btn btn-ghost text-sm px-3" onclick="showPublicGallery()">
        <i class="fas fa-users mr-1"></i>
        Community
      </button>
    </nav>
    
    <div class="flex items-center gap-2">
      <button id="theme-toggle" class="btn btn-ghost p-2" onclick="toggleTheme()">
        <i class="fas fa-moon"></i>
      </button>
      <select id="theme-variant-selector-header" class="px-2 py-1 rounded-lg outline-none transition-colors text-xs hidden xl:block" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" onchange="switchThemeVariant(this.value)">
        <option value="default">Default</option>
        <option value="minimal">Minimal</option>
        <option value="chalkboard">Chalkboard</option>
        <option value="neon">Neon</option>
        <option value="vibrant">Vibrant</option>
      </select>
      <div id="auth-buttons" class="flex gap-2">
        <button class="btn btn-primary text-sm px-3 py-2" onclick="showAuthModal('signup')">Sign Up</button>
        <button class="btn text-sm px-3 py-2" onclick="showAuthModal('login')">Log In</button>
      </div>
      <div id="user-menu" class="hidden flex items-center gap-2">
        <span class="text-xs lg:text-sm">Hi, <span id="user-display-name" class="font-bold">User</span></span>
        <button class="btn btn-ghost text-sm px-3 py-2" onclick="handleLogout()">
          <i class="fas fa-sign-out-alt"></i>
          <span class="hidden lg:inline ml-1">Logout</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Mobile Sidebar Toggle -->
  <button id="sidebar-toggle" class="lg:hidden fixed bottom-4 left-4 z-30 btn btn-primary rounded-full w-14 h-14 flex items-center justify-center shadow-lg">
    <i class="fas fa-bars"></i>
  </button>
  
  <!-- Sidebar Overlay (Mobile) -->
  <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

  <!-- Main App Container -->
  <div class="app-container">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">      
      <!-- Templates Section (Collapsible) -->
      <div class="sidebar-section">
        <div class="sidebar-title" style="cursor: pointer; user-select: none;" onclick="toggleTemplatesSection()">
          Templates
          <i class="fas fa-chevron-down" id="templates-chevron" style="float: right; transition: transform 0.3s;"></i>
        </div>
        <div id="templates-list">
          <div class="sidebar-item" onclick="selectTemplate('mcq')" data-template="mcq">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--primary);">
              <i class="fas fa-list"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">Quiz</div>
              <div class="sidebar-item-desc">Multiple choice</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('truefalse')" data-template="truefalse">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--secondary);">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">True or False</div>
              <div class="sidebar-item-desc">Binary choice</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('flipcards')" data-template="flipcards">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--accent);">
              <i class="fas fa-clone"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">Flash Cards</div>
              <div class="sidebar-item-desc">Front & back</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('dragdrop')" data-template="dragdrop">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--primary);">
              <i class="fas fa-hand-pointer"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">Match Up</div>
              <div class="sidebar-item-desc">Drag & drop</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('contentreveal')" data-template="contentreveal">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--warn);">
              <i class="fas fa-window-restore"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">Content Reveal</div>
              <div class="sidebar-item-desc">Click to expand</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('mentaldrag')" data-template="mentaldrag">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--secondary);">
              <i class="fas fa-brain"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">Mental Health</div>
              <div class="sidebar-item-desc">Symptom matching</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('pickmany')" data-template="pickmany">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--accent);">
              <i class="fas fa-tasks"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">Pick Many</div>
              <div class="sidebar-item-desc">Multiple select</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('infocard')" data-template="infocard">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--primary);">
              <i class="fas fa-info-circle"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">Info Card</div>
              <div class="sidebar-item-desc">Visual info</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('scormviewer')" data-template="scormviewer">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--secondary);">
              <i class="fas fa-play-circle"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">SCORM Viewer</div>
              <div class="sidebar-item-desc">Package embed</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('interactivevideo')" data-template="interactivevideo">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--accent);">
              <i class="fas fa-video"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">Interactive Video</div>
              <div class="sidebar-item-desc">Video + Quiz</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('gamearena')" data-template="gamearena">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--warn);">
              <i class="fas fa-gamepad"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">Game Arena</div>
              <div class="sidebar-item-desc">Interactive game</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('crossword')" data-template="crossword">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--primary);">
              <i class="fas fa-th"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">Crossword</div>
              <div class="sidebar-item-desc">Word puzzle</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('timeline')" data-template="timeline">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--secondary);">
              <i class="fas fa-stream"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">Timeline</div>
              <div class="sidebar-item-desc">Chronological events</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('matchingpairs')" data-template="matchingpairs">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--accent);">
              <i class="fas fa-copy"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">Matching Pairs</div>
              <div class="sidebar-item-desc">Memory game</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('sorting')" data-template="sorting">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--success);">
              <i class="fas fa-sort-amount-down"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">Sorting</div>
              <div class="sidebar-item-desc">Categorize items</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('labeldiagram')" data-template="labeldiagram">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--warn);">
              <i class="fas fa-map-pin"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">Label Diagram</div>
              <div class="sidebar-item-desc">Interactive labels</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('wordsearch')" data-template="wordsearch">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--primary);">
              <i class="fas fa-search"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">Word Search</div>
              <div class="sidebar-item-desc">Find hidden words</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('survey')" data-template="survey">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--secondary);">
              <i class="fas fa-poll"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">Survey</div>
              <div class="sidebar-item-desc">Collect feedback</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('accordion')" data-template="accordion">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--accent);">
              <i class="fas fa-list-ul"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">Accordion FAQ</div>
              <div class="sidebar-item-desc">Expandable Q&A</div>
            </div>
          </div>
          
          <div class="sidebar-item" onclick="selectTemplate('imagehotspot')" data-template="imagehotspot">
            <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--success);">
              <i class="fas fa-crosshairs"></i>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-item-name">Image Hotspot</div>
              <div class="sidebar-item-desc">Interactive image</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- User Dashboard -->
      <div class="sidebar-section">
        <div class="sidebar-title">User Dashboard</div>
        <div class="sidebar-item" onclick="showUserDashboard()">
          <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--primary);">
            <i class="fas fa-user-circle"></i>
          </div>
          <div class="sidebar-content">
            <div class="sidebar-item-name">My Profile</div>
            <div class="sidebar-item-desc">Account & stats</div>
          </div>
        </div>
      </div>
      
      <!-- My Templates -->
      <div class="sidebar-section" id="sidebar-my-templates" style="display: none;">
        <div class="sidebar-title">My Templates</div>
        <div class="sidebar-item" onclick="showMyTemplatesDashboard()">
          <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--success);">
            <i class="fas fa-folder-open"></i>
          </div>
          <div class="sidebar-content">
            <div class="sidebar-item-name">Saved Templates</div>
            <div class="sidebar-item-desc">View & manage</div>
          </div>
        </div>
      </div>
      
      <!-- Public Gallery -->
      <div class="sidebar-section">
        <div class="sidebar-title">Discover</div>
        <div class="sidebar-item" onclick="showPublicGallery()">
          <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--accent);">
            <i class="fas fa-globe"></i>
          </div>
          <div class="sidebar-content">
            <div class="sidebar-item-name">Public Gallery</div>
            <div class="sidebar-item-desc">Community templates</div>
          </div>
        </div>
      </div>
      
      <!-- Admin Section (Only visible for admins) -->
      <div class="sidebar-section" id="sidebar-admin" style="display: none;">
        <div class="sidebar-title">Administration</div>
        <div class="sidebar-item" onclick="showAdminDashboard()">
          <div class="sidebar-icon" style="background-color: var(--drag-bg); color: var(--warn);">
            <i class="fas fa-shield-alt"></i>
          </div>
          <div class="sidebar-content">
            <div class="sidebar-item-name">Admin Panel</div>
            <div class="sidebar-item-desc">Manage platform</div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">
      <!-- Home / Landing Page (shown by default) -->
      <section id="home-page">
        <!-- Hero Section with Resource Counter -->
        <!-- Hero Section with Vector Image -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center mb-12">
          <div class="text-center lg:text-left">
            <div class="inline-block px-4 py-2 rounded-full mb-4" style="background-color: var(--primary); background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white;">
              <span class="font-bold text-lg" id="resource-counter">0</span>
              <span class="text-sm ml-2">resources created</span>
            </div>
            <h1 class="text-5xl font-bold mb-4">Create better lessons quicker</h1>
            <p class="text-xl text-muted mb-8">The easy way to create your own teaching resources. Make custom activities for your classroom. Quizzes, match ups, word games, and much more.</p>
          </div>
          
          <!-- Hero Vector Illustration -->
          <div class="hidden lg:flex justify-center">
            <svg viewBox="0 0 500 400" class="w-full max-w-md" xmlns="http://www.w3.org/2000/svg">
              <!-- Teacher figure -->
              <ellipse cx="250" cy="380" rx="150" ry="15" fill="currentColor" opacity="0.1"/>
              
              <!-- Desk -->
              <rect x="150" y="280" width="200" height="15" rx="5" fill="currentColor" opacity="0.2"/>
              <rect x="140" y="295" width="220" height="10" rx="5" fill="currentColor" opacity="0.15"/>
              
              <!-- Laptop -->
              <rect x="180" y="240" width="140" height="90" rx="8" fill="var(--primary)" opacity="0.3"/>
              <rect x="185" y="245" width="130" height="70" rx="4" fill="var(--background)"/>
              <rect x="190" y="250" width="120" height="60" rx="2" fill="var(--primary)" opacity="0.6"/>
              <line x1="245" y1="330" x2="255" y2="350" stroke="var(--primary)" stroke-width="3"/>
              <rect x="200" y="350" width="100" height="5" rx="2" fill="var(--primary)" opacity="0.4"/>
              
              <!-- Person -->
              <circle cx="350" cy="170" r="30" fill="var(--secondary)"/>
              <path d="M 350 200 Q 320 220 320 280 L 340 280 L 340 350 L 360 350 L 360 280 L 380 280 Q 380 220 350 200" fill="var(--accent)"/>
              <rect x="335" y="230" width="30" height="50" rx="5" fill="var(--primary)" opacity="0.3"/>
              
              <!-- Floating educational icons -->
              <g opacity="0.6">
                <circle cx="100" cy="100" r="25" fill="var(--success)" opacity="0.3"/>
                <text x="100" y="110" text-anchor="middle" font-size="24" fill="var(--success)"></text>
                
                <circle cx="420" cy="80" r="25" fill="var(--warn)" opacity="0.3"/>
                <text x="420" y="90" text-anchor="middle" font-size="24" fill="var(--warn)"></text>
                
                <circle cx="80" cy="250" r="20" fill="var(--error)" opacity="0.3"/>
                <text x="80" y="258" text-anchor="middle" font-size="20" fill="var(--error)"></text>
                
                <circle cx="450" cy="220" r="20" fill="var(--primary)" opacity="0.3"/>
                <text x="450" y="228" text-anchor="middle" font-size="20" fill="var(--primary)"></text>
              </g>
            </svg>
          </div>
        </div>
        
        <div class="text-center mb-12">
          <button class="btn btn-primary text-lg px-8 py-4" id="signup-cta-home" onclick="showAuthModal('signup')">
            <i class="fas fa-rocket mr-2"></i>
            Sign Up To Start Creating
          </button>
          <button class="btn btn-secondary text-lg px-8 py-4 ml-4" onclick="selectTemplate('mcq')">
            <i class="fas fa-play mr-2"></i>
            Try Quiz Template Now
          </button>
        </div>

        
        <!-- How We Help Teachers Save Time -->
        <div class="mb-16">
          <h2 class="text-4xl font-bold text-center mb-12">How Tamer helps teachers save time</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Feature 1: Quick Creation -->
            <div class="card text-center">
              <svg viewBox="0 0 120 120" class="w-24 h-24 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg">
                <circle cx="60" cy="60" r="50" fill="var(--primary)" opacity="0.2"/>
                <circle cx="60" cy="60" r="40" fill="var(--primary)" opacity="0.4"/>
                <circle cx="60" cy="60" r="5" fill="var(--primary)"/>
                <line x1="60" y1="60" x2="60" y2="35" stroke="var(--primary)" stroke-width="3" stroke-linecap="round"/>
                <line x1="60" y1="60" x2="80" y2="60" stroke="var(--secondary)" stroke-width="3" stroke-linecap="round"/>
                <text x="60" y="100" text-anchor="middle" font-size="14" font-weight="bold" fill="var(--primary)">1 MIN</text>
              </svg>
              <h3 class="text-2xl font-bold mb-3">Create an activity in 1 minute</h3>
              <p class="text-muted">Just enter your content and press play. It's that simple. No complex setup or learning curve required.</p>
            </div>
            
            <!-- Feature 2: Multiple Templates -->
            <div class="card text-center">
              <svg viewBox="0 0 120 120" class="w-24 h-24 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg">
                <rect x="15" y="25" width="90" height="70" rx="5" fill="var(--secondary)" opacity="0.2"/>
                <rect x="25" y="20" width="70" height="70" rx="5" fill="var(--accent)" opacity="0.3"/>
                <rect x="30" y="30" width="60" height="50" rx="5" fill="var(--primary)" opacity="0.5"/>
                <circle cx="45" cy="50" r="8" fill="var(--success)"/>
                <circle cx="75" cy="50" r="8" fill="var(--warn)"/>
                <rect x="40" y="65" width="40" height="4" rx="2" fill="var(--text)" opacity="0.3"/>
                <rect x="40" y="72" width="30" height="4" rx="2" fill="var(--text)" opacity="0.3"/>
                <text x="60" y="105" text-anchor="middle" font-size="14" font-weight="bold" fill="var(--primary)">20+</text>
              </svg>
              <h3 class="text-2xl font-bold mb-3">20+ activity types in one platform</h3>
              <p class="text-muted">Quiz, match up, flash cards, drag and drop, timelines, crosswords, and many more interactive templates.</p>
            </div>
            
            <!-- Feature 3: Export Options -->
            <div class="card text-center">
              <svg viewBox="0 0 120 120" class="w-24 h-24 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg">
                <rect x="30" y="25" width="60" height="70" rx="5" fill="var(--accent)" opacity="0.2"/>
                <path d="M 60 45 L 60 75 M 50 65 L 60 75 L 70 65" stroke="var(--success)" stroke-width="4" stroke-linecap="round" fill="none"/>
                <line x1="35" y1="85" x2="85" y2="85" stroke="var(--accent)" stroke-width="3" stroke-linecap="round"/>
                <text x="60" y="105" text-anchor="middle" font-size="10" font-weight="bold" fill="var(--success)">EXPORT</text>
              </svg>
              <h3 class="text-2xl font-bold mb-3">Export to any format</h3>
              <p class="text-muted">Download as SCORM for LMS, Storyline for advanced editing, or HTML for offline use and homework.</p>
            </div>
            
            <!-- Feature 4: Share & Embed -->
            <div class="card text-center">
              <svg viewBox="0 0 120 120" class="w-24 h-24 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg">
                <circle cx="35" cy="50" r="15" fill="var(--success)" opacity="0.5"/>
                <circle cx="85" cy="50" r="15" fill="var(--success)" opacity="0.5"/>
                <circle cx="60" cy="80" r="15" fill="var(--success)" opacity="0.5"/>
                <line x1="47" y1="55" x2="73" y2="55" stroke="var(--success)" stroke-width="3"/>
                <line x1="45" y1="60" x2="60" y2="73" stroke="var(--success)" stroke-width="3"/>
                <line x1="75" y1="60" x2="65" y2="73" stroke="var(--success)" stroke-width="3"/>
                <circle cx="35" cy="50" r="8" fill="var(--background)"/>
                <circle cx="85" cy="50" r="8" fill="var(--background)"/>
                <circle cx="60" cy="80" r="8" fill="var(--background)"/>
              </svg>
              <h3 class="text-2xl font-bold mb-3">Share instantly</h3>
              <p class="text-muted">Share via link, social media, or embed on your website. Students can access activities on any device.</p>
            </div>
            
            <!-- Feature 5: Template Conversion -->
            <div class="card text-center">
              <svg viewBox="0 0 120 120" class="w-24 h-24 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg">
                <rect x="20" y="40" width="35" height="40" rx="5" fill="var(--warn)" opacity="0.4"/>
                <rect x="65" y="40" width="35" height="40" rx="5" fill="var(--error)" opacity="0.4"/>
                <path d="M 45 60 L 60 60 M 55 55 L 60 60 L 55 65" stroke="var(--primary)" stroke-width="3" fill="none" stroke-linecap="round"/>
                <circle cx="30" cy="55" r="5" fill="var(--warn)"/>
                <circle cx="80" cy="60" r="8" fill="var(--error)"/>
                <rect x="75" y="67" width="10" height="3" rx="1" fill="var(--error)" opacity="0.6"/>
              </svg>
              <h3 class="text-2xl font-bold mb-3">Activity customization</h3>
              <p class="text-muted">Switch your content to an entirely different activity with just one click. Change colors and themes instantly.</p>
            </div>
            
            <!-- Feature 6: Cloud Storage -->
            <div class="card text-center">
              <svg viewBox="0 0 120 120" class="w-24 h-24 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg">
                <path d="M 30 70 Q 30 50 50 50 Q 50 35 65 35 Q 80 35 80 50 Q 100 50 100 70 Q 100 85 85 85 L 35 85 Q 30 85 30 70" fill="var(--primary)" opacity="0.3"/>
                <circle cx="60" cy="55" r="3" fill="var(--primary)"/>
                <circle cx="50" cy="63" r="2" fill="var(--primary)" opacity="0.6"/>
                <circle cx="70" cy="63" r="2" fill="var(--primary)" opacity="0.6"/>
                <circle cx="60" cy="70" r="2" fill="var(--primary)" opacity="0.6"/>
                <text x="60" y="100" text-anchor="middle" font-size="10" font-weight="bold" fill="var(--primary)">CLOUD</text>
              </svg>
              <h3 class="text-2xl font-bold mb-3">Cloud-based storage</h3>
              <p class="text-muted">Access your activities from anywhere. All your templates are saved securely in the cloud with Firebase.</p>
            </div>
          </div>
        </div>
        
        <!-- Easy as 1-2-3 Section with Vector Illustrations -->
        <div class="card max-w-6xl mx-auto mb-12">
          <h2 class="text-3xl font-bold mb-8 text-center">Easy as 1-2-3</h2>
          <p class="text-center text-muted mb-12">Create a customized resource with just a few words and a few clicks.</p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-12">
            <div class="text-center">
              <!-- Step 1 Illustration -->
              <svg viewBox="0 0 200 200" class="w-32 h-32 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg">
                <rect x="40" y="40" width="120" height="140" rx="10" fill="var(--primary)" opacity="0.2"/>
                <rect x="50" y="50" width="100" height="20" rx="5" fill="var(--primary)" opacity="0.6"/>
                <rect x="50" y="80" width="100" height="20" rx="5" fill="var(--primary)" opacity="0.4"/>
                <rect x="50" y="110" width="100" height="20" rx="5" fill="var(--primary)" opacity="0.6"/>
                <rect x="50" y="140" width="100" height="20" rx="5" fill="var(--primary)" opacity="0.4"/>
                <circle cx="30" cy="30" r="25" fill="var(--primary)"/>
                <text x="30" y="40" text-anchor="middle" font-size="24" font-weight="bold" fill="white">1</text>
              </svg>
              <h3 class="text-xl font-bold mb-2">Pick a template</h3>
              <p class="text-muted">Choose from 20+ interactive templates below</p>
            </div>
            <div class="text-center">
              <!-- Step 2 Illustration -->
              <svg viewBox="0 0 200 200" class="w-32 h-32 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg">
                <rect x="30" y="50" width="140" height="100" rx="10" fill="var(--secondary)" opacity="0.2"/>
                <rect x="40" y="60" width="120" height="15" rx="3" fill="var(--secondary)" opacity="0.5"/>
                <rect x="40" y="85" width="120" height="15" rx="3" fill="var(--secondary)" opacity="0.3"/>
                <rect x="40" y="110" width="90" height="15" rx="3" fill="var(--secondary)" opacity="0.5"/>
                <rect x="145" y="110" width="15" height="15" rx="3" fill="var(--success)"/>
                <path d="M 147 117 L 152 122 L 158 112" stroke="white" stroke-width="2" fill="none"/>
                <circle cx="30" cy="30" r="25" fill="var(--secondary)"/>
                <text x="30" y="40" text-anchor="middle" font-size="24" font-weight="bold" fill="white">2</text>
              </svg>
              <h3 class="text-xl font-bold mb-2">Enter your content</h3>
              <p class="text-muted">Add your questions, words, or educational content</p>
            </div>
            <div class="text-center">
              <!-- Step 3 Illustration -->
              <svg viewBox="0 0 200 200" class="w-32 h-32 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg">
                <rect x="50" y="40" width="100" height="120" rx="10" fill="var(--accent)" opacity="0.2"/>
                <circle cx="100" cy="90" r="30" fill="var(--accent)" opacity="0.6"/>
                <path d="M 85 90 L 95 100 L 115 75" stroke="white" stroke-width="4" fill="none" stroke-linecap="round"/>
                <rect x="65" y="130" width="70" height="15" rx="7" fill="var(--success)"/>
                <text x="100" y="141" text-anchor="middle" font-size="10" font-weight="bold" fill="white">PLAY</text>
                <circle cx="30" cy="30" r="25" fill="var(--accent)"/>
                <text x="30" y="40" text-anchor="middle" font-size="24" font-weight="bold" fill="white">3</text>
              </svg>
              <h3 class="text-xl font-bold mb-2">Play, share, or export</h3>
              <p class="text-muted">Use in play mode, share with students, or export as SCORM/Storyline/HTML</p>
            </div>
          </div>
        </div>
        
        <!-- Find out about our templates -->
        <div class="mb-8">
          <h2 class="text-3xl font-bold text-center mb-4">Find out about our templates</h2>
          <p class="text-center text-muted mb-8">Select a template to learn more and start creating</p>
        </div>
        
        <!-- Templates Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
          <!-- Template 1: Quiz -->
          <div class="template-card" onclick="selectTemplate('mcq')">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 rounded-lg flex items-center justify-center text-primary" style="background-color: var(--drag-bg);">
                <i class="fas fa-list"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold mb-2">Quiz</h3>
                <p class="text-muted">A series of multiple choice questions. Tap the correct answer to proceed.</p>
              </div>
            </div>
          </div>
          
          <!-- Template 2: True/False -->
          <div class="template-card" onclick="selectTemplate('truefalse')">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 rounded-lg flex items-center justify-center text-secondary" style="background-color: var(--drag-bg);">
                <i class="fas fa-check-circle"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold mb-2">True or False</h3>
                <p class="text-muted">Statements with true or false answers. Perfect for quick assessments.</p>
              </div>
            </div>
          </div>
          
          <!-- Template 3: Flash Cards -->
          <div class="template-card" onclick="selectTemplate('flipcards')">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 rounded-lg flex items-center justify-center text-accent" style="background-color: var(--drag-bg);">
                <i class="fas fa-clone"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold mb-2">Flash Cards</h3>
                <p class="text-muted">Test yourself using cards with prompts on the front and answers on the back.</p>
              </div>
            </div>
          </div>
          
          <!-- Template 4: Match Up -->
          <div class="template-card" onclick="selectTemplate('dragdrop')">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 rounded-lg flex items-center justify-center text-primary" style="background-color: var(--drag-bg);">
                <i class="fas fa-hand-pointer"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold mb-2">Match Up</h3>
                <p class="text-muted">Drag and drop each keyword next to its definition.</p>
              </div>
            </div>
          </div>
          
          <!-- Template 5: Content Reveal -->
          <div class="template-card" onclick="selectTemplate('contentreveal')">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 rounded-lg flex items-center justify-center text-warn" style="background-color: var(--drag-bg);">
                <i class="fas fa-window-restore"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold mb-2">Content Reveal Panels</h3>
                <p class="text-muted">Click colorful panels to reveal educational content with swivel animations.</p>
              </div>
            </div>
          </div>
          
          <!-- Template 6: Mental Health -->
          <div class="template-card" onclick="selectTemplate('mentaldrag')">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 rounded-lg flex items-center justify-center text-secondary" style="background-color: var(--drag-bg);">
                <i class="fas fa-brain"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold mb-2">Mental Health Drag & Drop</h3>
                <p class="text-muted">Drag mental health symptoms to matching drop zones with color-coded feedback.</p>
              </div>
            </div>
          </div>
          
          <!-- Template 7: Pick Many -->
          <div class="template-card" onclick="selectTemplate('pickmany')">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 rounded-lg flex items-center justify-center text-accent" style="background-color: var(--drag-bg);">
                <i class="fas fa-tasks"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold mb-2">Pick Many Quiz</h3>
                <p class="text-muted">Select multiple correct answers from a list with hover effects and feedback.</p>
              </div>
            </div>
          </div>
          
          <!-- Template 8: Info Card -->
          <div class="template-card" onclick="selectTemplate('infocard')">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 rounded-lg flex items-center justify-center text-primary" style="background-color: var(--drag-bg);">
                <i class="fas fa-info-circle"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold mb-2">Info Card Display</h3>
                <p class="text-muted">Beautiful information cards with floating animations and visual elements.</p>
              </div>
            </div>
          </div>
          
          <!-- Template 9: SCORM Viewer -->
          <div class="template-card" onclick="selectTemplate('scormviewer')">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 rounded-lg flex items-center justify-center text-secondary" style="background-color: var(--drag-bg);">
                <i class="fas fa-play-circle"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold mb-2">SCORM Package Viewer</h3>
                <p class="text-muted">Embed and play SCORM packages directly in your learning activities.</p>
              </div>
            </div>
          </div>
          
          <!-- Template 10: Interactive Video -->
          <div class="template-card" onclick="selectTemplate('interactivevideo')">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 rounded-lg flex items-center justify-center text-accent" style="background-color: var(--drag-bg);">
                <i class="fas fa-video"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold mb-2">Interactive Video</h3>
                <p class="text-muted">Embed YouTube/Vimeo videos with timeline questions and quiz pauses.</p>
              </div>
            </div>
          </div>
          
          <!-- Template 11: Game Arena -->
          <div class="template-card" onclick="selectTemplate('gamearena')">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 rounded-lg flex items-center justify-center text-warn" style="background-color: var(--drag-bg);">
                <i class="fas fa-gamepad"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold mb-2">Game Arena</h3>
                <p class="text-muted">Interactive game-based learning experience with challenges and quizzes.</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- User Dashboard -->
      <section id="user-dashboard" class="hidden">
        <div class="mb-8">
          <h1 class="text-4xl font-bold mb-2">My Profile</h1>
          <p class="text-muted">Account information and activity statistics</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="card">
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 rounded-full flex items-center justify-center text-white text-2xl" style="background: var(--primary);">
                <i class="fas fa-user"></i>
              </div>
              <div>
                <div class="text-sm text-muted">Username</div>
                <div class="text-xl font-bold" id="dashboard-username">Loading...</div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 rounded-full flex items-center justify-center text-white text-2xl" style="background: var(--success);">
                <i class="fas fa-folder"></i>
              </div>
              <div>
                <div class="text-sm text-muted">Total Templates</div>
                <div class="text-xl font-bold" id="dashboard-template-count">0</div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 rounded-full flex items-center justify-center text-white text-2xl" style="background: var(--accent);">
                <i class="fas fa-play-circle"></i>
              </div>
              <div>
                <div class="text-sm text-muted">Total Plays</div>
                <div class="text-xl font-bold" id="dashboard-total-plays">0</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card mb-8">
          <h2 class="text-2xl font-bold mb-4">Account Details</h2>
          <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-muted mb-2">Email</label>
                <div class="px-4 py-2 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border);" id="dashboard-email">Loading...</div>
              </div>
              <div>
                <label class="block text-sm text-muted mb-2">User ID</label>
                <div class="px-4 py-2 rounded-lg font-mono text-sm" style="background-color: var(--button-bg); border: 1px solid var(--button-border);" id="dashboard-uid">Loading...</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <h2 class="text-2xl font-bold mb-4">Quick Actions</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button class="btn btn-primary" onclick="showMyTemplatesDashboard()">
              <i class="fas fa-folder-open mr-2"></i>
              View My Templates
            </button>
            <button class="btn btn-secondary" onclick="selectTemplate('mcq')">
              <i class="fas fa-plus-circle mr-2"></i>
              Create New Activity
            </button>
            <button class="btn btn-accent" onclick="showPublicGallery()">
              <i class="fas fa-globe mr-2"></i>
              Browse Gallery
            </button>
          </div>
        </div>
      </section>

      <!-- Welcome Section (old, kept for compatibility but hidden) -->
      <section id="welcome-section" class="hidden">
      </section>

      <!-- Activity Creator (Hidden by default) -->
      <section id="activity-creator" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h2 class="text-3xl font-bold" id="activity-display-title">Untitled Activity</h2>
            <p class="text-muted mt-1">Edit your content or switch to play mode to test</p>
          </div>
          <div class="flex gap-3">
            <button class="btn btn-ghost" onclick="toggleMode()">
              <i class="fas fa-exchange-alt mr-2"></i>
              <span id="mode-toggle-text">Switch to Play Mode</span>
            </button>
          </div>
        </div>
        
        <!-- Activity Title Input -->
        <div class="card mb-6">
          <label class="block text-sm text-muted mb-2">Activity Title</label>
          <input id="activity-title" type="text" placeholder="My Awesome Activity" class="w-full px-4 py-3 rounded-lg outline-none focus:border-primary transition-colors text-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
        </div>
        
        <!-- Play Mode -->
        <div id="play-mode">
          <!-- Enhanced Controls Toolbar -->
          <div id="enhanced-controls" class="mb-4 p-3 rounded-lg flex flex-wrap gap-2 items-center justify-between" style="background-color: var(--button-bg); border: 1px solid var(--button-border);">
            <div class="flex flex-wrap gap-2">
              <button class="btn btn-sm" onclick="shareActivity()" title="Share this activity">
                <i class="fas fa-share-alt mr-1"></i>
                Share
              </button>
              <button class="btn btn-sm" onclick="showEmbedCode()" title="Get embed code">
                <i class="fas fa-code mr-1"></i>
                Embed
              </button>
              <button class="btn btn-sm" onclick="toggleFullscreen()" title="Fullscreen mode">
                <div class="icon-fullscreen mr-1"></div>
                <span id="fullscreen-text">Fullscreen</span>
              </button>
              <button class="btn btn-sm" onclick="toggleTimer()" title="Start/Stop timer">
                <i class="fas fa-stopwatch mr-1"></i>
                <span id="timer-display">00:00</span>
              </button>
              <button class="btn btn-sm" onclick="toggleSound()" title="Toggle sound" id="sound-btn">
                <div class="icon-volume" id="sound-icon"></div>
              </button>
            </div>
            <div class="text-xs text-muted" id="save-status">Not saved yet</div>
          </div>
          
          <div class="card">
            <div id="play-area" class="mb-6 min-h-[400px]"></div>
            <div class="flex flex-wrap gap-3" id="play-controls"></div>
          </div>
        </div>
        
        <!-- Edit Mode -->
        <div id="edit-mode" class="hidden">
          <div class="card">
            <div class="text-muted text-sm mb-4">Edit your content, then click Save Activity to store your changes.</div>
            <div id="editor" class="space-y-6 mb-6"></div>
            <div class="flex justify-between">
              <button id="add-item-btn" class="btn">
                <i class="fas fa-plus mr-2"></i>
                Add Item
              </button>
              <button id="save-changes-btn" class="btn btn-accent">
                <i class="fas fa-save mr-2"></i>
                Save Changes
              </button>
            </div>
          </div>
        </div>
      </section>
      
      <!-- My Templates Dashboard (Moved above other sections, hidden by default) -->
      <section id="my-templates-dashboard" class="max-w-6xl mx-auto px-4 py-8 hidden">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h2 class="text-3xl font-bold">My Saved Templates</h2>
            <p class="text-muted mt-1">Manage and preview your saved activities</p>
          </div>
          <button class="btn btn-ghost" onclick="refreshMyTemplates()">
            <i class="fas fa-sync-alt mr-2"></i>
            Refresh
          </button>
        </div>
        
        <div id="my-templates-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
          <div class="text-center py-12 text-muted col-span-full">Loading your templates...</div>
        </div>
      </section>
      
      <!-- Price Plans Section -->
      <section id="price-plans" class="hidden">
        <div class="text-center mb-12">
          <h1 class="text-5xl font-bold mb-4">Price Plans</h1>
          <p class="text-xl text-muted mb-8 max-w-3xl mx-auto">Choose the plan that works best for you</p>
          
          <!-- Monthly/Annual Toggle -->
          <div class="inline-flex items-center gap-3 p-2 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border);">
            <button id="billing-monthly" class="px-6 py-2 rounded-lg font-bold transition-all" style="background-color: var(--primary); color: white;" onclick="switchBillingCycle('monthly')">
              Pay Monthly
            </button>
            <button id="billing-annual" class="px-6 py-2 rounded-lg font-bold transition-all" onclick="switchBillingCycle('annual')">
              Pay Annually
              <span class="ml-2 px-2 py-1 text-xs rounded-full" style="background-color: var(--success); color: white;">25% off</span>
            </button>
          </div>
        </div>
        
        <!-- Pricing Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
          <!-- Basic Plan -->
          <div class="card text-center">
            <h3 class="text-2xl font-bold mb-2">Basic</h3>
            <div class="my-6">
              <div class="text-5xl font-bold mb-2">
                <span id="price-basic">Free</span>
              </div>
            </div>
            <button class="btn btn-secondary w-full mb-6" onclick="showAuthModal('signup')">
              <i class="fas fa-rocket mr-2"></i>
              Free Sign Up
            </button>
            <div class="text-left space-y-3">
              <div class="flex items-start gap-2">
                <i class="fas fa-check text-success mt-1"></i>
                <span class="text-sm">Create up to 3 activities</span>
              </div>
              <div class="flex items-start gap-2">
                <i class="fas fa-check text-success mt-1"></i>
                <span class="text-sm">12 standard templates</span>
              </div>
              <div class="flex items-start gap-2">
                <i class="fas fa-check text-success mt-1"></i>
                <span class="text-sm">Basic sharing options</span>
              </div>
            </div>
          </div>
          
          <!-- Standard Plan (Recommended) -->
          <div class="card text-center" style="border: 2px solid var(--primary); box-shadow: 0 8px 24px rgba(37, 99, 235, 0.2);">
            <div class="inline-block px-3 py-1 rounded-full text-xs font-bold mb-2" style="background-color: var(--primary); color: white;">
              RECOMMENDED
            </div>
            <h3 class="text-2xl font-bold mb-2">Standard</h3>
            <div class="my-6">
              <div class="text-5xl font-bold mb-2">
                <span>$<span id="standard-price">10</span></span>
                <span class="text-xl"> / month</span>
              </div>
              <div class="text-sm text-muted" id="standard-billing">Billed monthly</div>
            </div>
            <button class="btn btn-primary w-full mb-6" onclick="handleSubscribe('standard')">
              <i class="fas fa-crown mr-2"></i>
              Subscribe
            </button>
            <div class="text-left space-y-3">
              <div class="flex items-start gap-2">
                <i class="fas fa-check text-success mt-1"></i>
                <span class="text-sm">Create and edit unlimited activities</span>
              </div>
              <div class="flex items-start gap-2">
                <i class="fas fa-check text-success mt-1"></i>
                <span class="text-sm">Edit activity options</span>
              </div>
              <div class="flex items-start gap-2">
                <i class="fas fa-check text-success mt-1"></i>
                <span class="text-sm">Unlimited community search</span>
              </div>
              <div class="flex items-start gap-2">
                <i class="fas fa-check text-success mt-1"></i>
                <span class="text-sm">Export as SCORM/HTML</span>
              </div>
              <div class="flex items-start gap-2">
                <i class="fas fa-check text-success mt-1"></i>
                <span class="text-sm">12 standard templates</span>
              </div>
            </div>
          </div>
          
          <!-- Pro Plan -->
          <div class="card text-center">
            <h3 class="text-2xl font-bold mb-2">Pro</h3>
            <div class="my-6">
              <div class="text-5xl font-bold mb-2">
                <span>$<span id="pro-price">15</span></span>
                <span class="text-xl"> / month</span>
              </div>
              <div class="text-sm text-muted" id="pro-billing">Billed monthly</div>
            </div>
            <button class="btn btn-accent w-full mb-6" onclick="handleSubscribe('pro')">
              <i class="fas fa-star mr-2"></i>
              Subscribe
            </button>
            <div class="text-left space-y-3">
              <div class="flex items-start gap-2">
                <i class="fas fa-check text-success mt-1"></i>
                <span class="text-sm font-bold">Everything in Standard, plus:</span>
              </div>
              <div class="flex items-start gap-2">
                <i class="fas fa-check text-success mt-1"></i>
                <span class="text-sm">20+ templates (all templates)</span>
              </div>
              <div class="flex items-start gap-2">
                <i class="fas fa-check text-success mt-1"></i>
                <span class="text-sm">Export to Storyline (.story)</span>
              </div>
              <div class="flex items-start gap-2">
                <i class="fas fa-check text-success mt-1"></i>
                <span class="text-sm">Early access to new templates</span>
              </div>
              <div class="flex items-start gap-2">
                <i class="fas fa-check text-success mt-1"></i>
                <span class="text-sm">Priority support</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- FAQs -->
        <div class="card max-w-4xl mx-auto">
          <h2 class="text-3xl font-bold mb-8 text-center">Frequently Asked Questions</h2>
          <div class="space-y-6">
            <div>
              <h3 class="text-lg font-bold mb-2">What happens to my activities if I cancel?</h3>
              <p class="text-muted">You will still have access to your activities folder. You can play, export, or share your resources. However, you won't be able to create new resources or edit existing ones.</p>
            </div>
            <div>
              <h3 class="text-lg font-bold mb-2">Can I cancel anytime?</h3>
              <p class="text-muted">Yes! There is no contract. You can cancel at any point and no further payments will be taken.</p>
            </div>
            <div>
              <h3 class="text-lg font-bold mb-2">Can I switch between Standard and Pro later?</h3>
              <p class="text-muted">Yes, you can upgrade or downgrade your plan at any time from your account settings.</p>
            </div>
            <div>
              <h3 class="text-lg font-bold mb-2">What payment methods do you support?</h3>
              <p class="text-muted">We accept Visa, MasterCard, American Express, Apple Pay, and PayPal.</p>
            </div>
          </div>
        </div>
      </section>
      
      <!-- Public Gallery -->
      <!-- Admin Dashboard (Hidden by default, only for admins) -->
      <section id="admin-dashboard" class="hidden">
        <div class="mb-8">
          <h2 class="text-3xl font-bold">Admin Dashboard</h2>
          <p class="text-muted mt-1">Manage users, templates, and view analytics</p>
        </div>
        
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div class="stat-card">
            <div class="flex items-center justify-between mb-2">
              <i class="fas fa-users text-2xl" style="color: var(--primary);"></i>
              <span id="admin-total-users" class="text-3xl font-bold">0</span>
            </div>
            <div class="text-sm text-muted">Total Users</div>
          </div>
          
          <div class="stat-card">
            <div class="flex items-center justify-between mb-2">
              <i class="fas fa-file-alt text-2xl" style="color: var(--secondary);"></i>
              <span id="admin-total-templates" class="text-3xl font-bold">0</span>
            </div>
            <div class="text-sm text-muted">Total Templates</div>
          </div>
          
          <div class="stat-card">
            <div class="flex items-center justify-between mb-2">
              <i class="fas fa-eye text-2xl" style="color: var(--accent);"></i>
              <span id="admin-total-views" class="text-3xl font-bold">0</span>
            </div>
            <div class="text-sm text-muted">Total Views</div>
          </div>
          
          <div class="stat-card">
            <div class="flex items-center justify-between mb-2">
              <i class="fas fa-clock text-2xl" style="color: var(--success);"></i>
              <span id="admin-active-today" class="text-3xl font-bold">0</span>
            </div>
            <div class="text-sm text-muted">Active Today</div>
          </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="card mb-6">
          <div class="flex gap-2 border-b" style="border-color: var(--card-border);">
            <button class="px-6 py-3 font-bold border-b-2 transition-all" id="admin-tab-users" style="border-color: var(--primary); color: var(--primary);" onclick="switchAdminTab('users')">
              <i class="fas fa-users mr-2"></i>Users
            </button>
            <button class="px-6 py-3 font-bold border-b-2 border-transparent transition-all text-muted hover:text-primary" id="admin-tab-templates" onclick="switchAdminTab('templates')">
              <i class="fas fa-file-alt mr-2"></i>Templates
            </button>
            <button class="px-6 py-3 font-bold border-b-2 border-transparent transition-all text-muted hover:text-primary" id="admin-tab-analytics" onclick="switchAdminTab('analytics')">
              <i class="fas fa-chart-bar mr-2"></i>Analytics
            </button>
            <button class="px-6 py-3 font-bold border-b-2 border-transparent transition-all text-muted hover:text-primary" id="admin-tab-pricing" onclick="switchAdminTab('pricing')">
              <i class="fas fa-dollar-sign mr-2"></i>Pricing
            </button>
            <button class="px-6 py-3 font-bold border-b-2 border-transparent transition-all text-muted hover:text-primary" id="admin-tab-reports" onclick="switchAdminTab('reports')">
              <i class="fas fa-file-download mr-2"></i>Reports
            </button>
          </div>
        </div>
        
        <!-- Users Tab -->
        <div id="admin-content-users" class="card">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold">User Management</h3>
            <div class="flex gap-3">
              <input type="text" id="admin-user-search" placeholder="Search users..." class="px-4 py-2 rounded-lg outline-none" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" oninput="filterAdminUsers()">
              <button class="btn btn-ghost" onclick="refreshAdminUsers()">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
          </div>
          
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b" style="border-color: var(--card-border);">
                  <th class="text-left p-3 text-sm text-muted">User</th>
                  <th class="text-left p-3 text-sm text-muted">Email</th>
                  <th class="text-left p-3 text-sm text-muted">Templates</th>
                  <th class="text-left p-3 text-sm text-muted">Joined</th>
                  <th class="text-left p-3 text-sm text-muted">Status</th>
                  <th class="text-left p-3 text-sm text-muted">Actions</th>
                </tr>
              </thead>
              <tbody id="admin-users-table">
                <tr>
                  <td colspan="6" class="text-center py-8 text-muted">Loading users...</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="flex justify-between items-center mt-6">
            <div class="text-sm text-muted">Showing <span id="admin-users-count">0</span> users</div>
            <div class="flex gap-2">
              <button class="btn btn-ghost btn-sm" onclick="loadAdminUsers(adminUserPage - 1)" id="admin-users-prev">Previous</button>
              <button class="btn btn-ghost btn-sm" onclick="loadAdminUsers(adminUserPage + 1)" id="admin-users-next">Next</button>
            </div>
          </div>
        </div>
        
        <!-- Templates Tab -->
        <div id="admin-content-templates" class="card hidden">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold">Template Overview</h3>
            <select id="admin-template-filter" class="px-4 py-2 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" onchange="filterAdminTemplates()">
              <option value="all">All Types</option>
              <option value="mcq">Quiz</option>
              <option value="truefalse">True/False</option>
              <option value="flipcards">Flash Cards</option>
              <option value="dragdrop">Match Up</option>
            </select>
          </div>
          
          <div id="admin-templates-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="text-center py-8 text-muted col-span-full">Loading templates...</div>
          </div>
        </div>
        
        <!-- Analytics Tab -->
        <div id="admin-content-analytics" class="hidden">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="card">
              <h3 class="text-lg font-bold mb-4">Template Usage</h3>
              <canvas id="admin-chart-templates" height="200"></canvas>
            </div>
            
            <div class="card">
              <h3 class="text-lg font-bold mb-4">User Activity</h3>
              <canvas id="admin-chart-activity" height="200"></canvas>
            </div>
          </div>
          
          <div class="card">
            <h3 class="text-lg font-bold mb-4">Popular Templates</h3>
            <div id="admin-popular-templates" class="space-y-3">
              <div class="text-center py-8 text-muted">Loading analytics...</div>
            </div>
          </div>
        </div>
        
        <!-- Pricing Tab -->
        <div id="admin-content-pricing" class="card hidden">
          <h3 class="text-lg font-bold mb-6">Manage Pricing Plans</h3>
          
          <div class="mb-8">
            <div class="inline-block px-4 py-2 rounded-lg mb-4" style="background-color: var(--warn); background: linear-gradient(135deg, var(--warn) 0%, var(--error) 100%); color: white;">
              <i class="fas fa-info-circle mr-2"></i>
              <span class="font-bold">Note:</span> Changes will update prices on the public pricing page immediately
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Standard Plan Pricing -->
            <div class="p-6 rounded-lg" style="background-color: var(--drag-bg); border: 2px solid var(--primary);">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: var(--primary); color: white;">
                  <i class="fas fa-crown text-xl"></i>
                </div>
                <h4 class="text-xl font-bold">Standard Plan</h4>
              </div>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm text-muted mb-2">Monthly Price ($)</label>
                  <input type="number" id="admin-standard-monthly" value="10" min="0" step="0.01" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
                </div>
                
                <div>
                  <label class="block text-sm text-muted mb-2">Annual Price ($)</label>
                  <input type="number" id="admin-standard-annual" value="7.50" min="0" step="0.01" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
                  <p class="text-xs text-muted mt-1">Per month (billed annually)</p>
                </div>
                
                <div>
                  <label class="block text-sm text-muted mb-2">Annual Total ($)</label>
                  <input type="number" id="admin-standard-annual-total" value="90" min="0" step="0.01" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
                  <p class="text-xs text-muted mt-1">Total billed annually</p>
                </div>
                
                <button class="btn btn-primary w-full" onclick="saveStandardPricing()">
                  <i class="fas fa-save mr-2"></i>
                  Save Standard Pricing
                </button>
              </div>
            </div>
            
            <!-- Pro Plan Pricing -->
            <div class="p-6 rounded-lg" style="background-color: var(--drag-bg); border: 2px solid var(--accent);">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: var(--accent); color: white;">
                  <i class="fas fa-star text-xl"></i>
                </div>
                <h4 class="text-xl font-bold">Pro Plan</h4>
              </div>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm text-muted mb-2">Monthly Price ($)</label>
                  <input type="number" id="admin-pro-monthly" value="15" min="0" step="0.01" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
                </div>
                
                <div>
                  <label class="block text-sm text-muted mb-2">Annual Price ($)</label>
                  <input type="number" id="admin-pro-annual" value="11.25" min="0" step="0.01" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
                  <p class="text-xs text-muted mt-1">Per month (billed annually)</p>
                </div>
                
                <div>
                  <label class="block text-sm text-muted mb-2">Annual Total ($)</label>
                  <input type="number" id="admin-pro-annual-total" value="135" min="0" step="0.01" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
                  <p class="text-xs text-muted mt-1">Total billed annually</p>
                </div>
                
                <button class="btn btn-accent w-full" onclick="saveProPricing()">
                  <i class="fas fa-save mr-2"></i>
                  Save Pro Pricing
                </button>
              </div>
            </div>
          </div>
          
          <!-- Pricing History -->
          <div class="mt-8 p-6 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--card-border);">
            <h4 class="text-lg font-bold mb-4">Pricing Change History</h4>
            <div id="admin-pricing-history" class="space-y-2">
              <div class="text-sm text-muted">No pricing changes recorded yet</div>
            </div>
          </div>
        </div>
        
        <!-- Reports Tab -->
        <div id="admin-content-reports" class="card hidden">
          <h3 class="text-lg font-bold mb-6">Generate Reports</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="p-4 rounded-lg" style="background-color: var(--drag-bg); border: 1px solid var(--card-border);">
              <h4 class="font-bold mb-3">User Activity Report</h4>
              <p class="text-sm text-muted mb-4">Export user login and activity data</p>
              <button class="btn btn-primary w-full" onclick="generateAdminReport('users')">
                <i class="fas fa-download mr-2"></i>Download CSV
              </button>
            </div>
            
            <div class="p-4 rounded-lg" style="background-color: var(--drag-bg); border: 1px solid var(--card-border);">
              <h4 class="font-bold mb-3">Template Statistics</h4>
              <p class="text-sm text-muted mb-4">Export template usage and performance data</p>
              <button class="btn btn-primary w-full" onclick="generateAdminReport('templates')">
                <i class="fas fa-download mr-2"></i>Download CSV
              </button>
            </div>
            
            <div class="p-4 rounded-lg" style="background-color: var(--drag-bg); border: 1px solid var(--card-border);">
              <h4 class="font-bold mb-3">Analytics Summary</h4>
              <p class="text-sm text-muted mb-4">Comprehensive analytics report</p>
              <button class="btn btn-primary w-full" onclick="generateAdminReport('analytics')">
                <i class="fas fa-download mr-2"></i>Download PDF
              </button>
            </div>
            
            <div class="p-4 rounded-lg" style="background-color: var(--drag-bg); border: 1px solid var(--card-border);">
              <h4 class="font-bold mb-3">Custom Report</h4>
              <p class="text-sm text-muted mb-4">Configure and export custom data</p>
              <button class="btn btn-primary w-full" onclick="showCustomReportBuilder()">
                <i class="fas fa-cog mr-2"></i>Configure
              </button>
            </div>
          </div>
        </div>
      </section>
      
      <!-- Public Gallery -->
      <section id="public-gallery" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h2 class="text-3xl font-bold">Public Gallery</h2>
            <p class="text-muted mt-1">Discover and use community-created templates</p>
          </div>
          <button class="btn btn-ghost" onclick="refreshPublicGallery()">
            <i class="fas fa-sync-alt mr-2"></i>
            Refresh
          </button>
        </div>
        
        <!-- Search and Filter -->
        <div class="card mb-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
              <input type="text" id="gallery-search" placeholder="Search templates..." class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" oninput="filterGallery()">
            </div>
            <div>
              <select id="gallery-filter" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" onchange="filterGallery()">
                <option value="all">All Types</option>
                <option value="mcq">Quiz</option>
                <option value="truefalse">True or False</option>
                <option value="flipcards">Flash Cards</option>
                <option value="dragdrop">Match Up</option>
                <option value="contentreveal">Content Reveal</option>
                <option value="mentaldrag">Mental Health</option>
                <option value="pickmany">Pick Many</option>
                <option value="infocard">Info Card</option>
                <option value="scormviewer">SCORM Viewer</option>
                <option value="interactivevideo">Interactive Video</option>
              </select>
            </div>
          </div>
        </div>
        
        <div id="gallery-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
          <div class="text-center py-12 text-muted col-span-full">Loading public templates...</div>
        </div>
      </section>
    </main>
  </div>

  <!-- Authentication Modal -->
  <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeAuthModal(event)">
    <div class="card max-w-md w-full mx-4" onclick="event.stopPropagation()">
      <div class="flex justify-between items-center mb-6">
        <h2 id="auth-modal-title" class="text-2xl font-bold">Sign Up</h2>
        <button onclick="closeAuthModal()" class="btn btn-ghost p-2">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div id="auth-error" class="hidden p-3 mb-4 rounded-lg bg-red-500 bg-opacity-20 border border-red-500 text-red-500"></div>
      
      <!-- Sign Up Form -->
      <div id="signup-form">
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-muted mb-2">Full Name</label>
            <input id="signup-name" type="text" placeholder="John Doe" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
          </div>
          <div>
            <label class="block text-sm text-muted mb-2">Email</label>
            <input id="signup-email" type="email" placeholder="you@example.com" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
          </div>
          <div>
            <label class="block text-sm text-muted mb-2">Password</label>
            <input id="signup-password" type="password" placeholder="" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
          </div>
          <div>
            <label class="block text-sm text-muted mb-2">Confirm Password</label>
            <input id="signup-confirm-password" type="password" placeholder="" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
          </div>
          <button id="signup-btn" class="btn btn-primary w-full" onclick="handleSignup()">
            <i class="fas fa-user-plus mr-2"></i>
            Create Account
          </button>
        </div>
        
        <div class="divider"></div>
        
        <button class="btn w-full flex items-center justify-center gap-2" onclick="handleGoogleSignIn()">
          <svg class="w-5 h-5" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Continue with Google
        </button>
        
        <p class="text-center text-sm text-muted mt-4">
          Already have an account? 
          <a href="#" class="text-primary hover:underline" onclick="switchToLogin(event)">Log In</a>
        </p>
      </div>
      
      <!-- Login Form -->
      <div id="login-form" class="hidden">
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-muted mb-2">Email</label>
            <input id="login-email" type="email" placeholder="you@example.com" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
          </div>
          <div>
            <label class="block text-sm text-muted mb-2">Password</label>
            <input id="login-password" type="password" placeholder="" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
          </div>
          <div class="flex justify-between items-center">
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" id="remember-me" class="rounded">
              <span class="text-muted">Remember me</span>
            </label>
            <a href="#" class="text-sm text-primary hover:underline" onclick="handleForgotPassword(event)">Forgot Password?</a>
          </div>
          <button id="login-btn" class="btn btn-primary w-full" onclick="handleLogin()">
            <i class="fas fa-sign-in-alt mr-2"></i>
            Log In
          </button>
        </div>
        
        <div class="divider"></div>
        
        <button class="btn w-full flex items-center justify-center gap-2" onclick="handleGoogleSignIn()">
          <svg class="w-5 h-5" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Continue with Google
        </button>
        
        <p class="text-center text-sm text-muted mt-4">
          Don't have an account? 
          <a href="#" class="text-primary hover:underline" onclick="switchToSignup(event)">Sign Up</a>
        </p>
      </div>
    </div>
  </div>

  <!-- My Templates Dashboard (Moved above other sections, hidden by default) -->
  <section id="my-templates-dashboard" class="max-w-6xl mx-auto px-4 py-8 hidden">
    <div class="flex justify-between items-center mb-8">
      <h2 class="text-3xl font-bold">My Saved Templates</h2>
      <button class="btn btn-ghost" onclick="refreshMyTemplates()">
        <i class="fas fa-sync-alt mr-2"></i>
        Refresh
      </button>
    </div>
    
    <div id="my-templates-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="text-center py-12 text-muted col-span-full">Loading your templates...</div>
    </div>
  </section>

  <div class="divider max-w-6xl mx-auto"></div>

  <!-- Activity Creator (Hidden by default) -->
  <section id="activity-creator" class="max-w-6xl mx-auto px-4 py-8 hidden">
    <div class="flex justify-between items-center mb-8">
      <h2 class="text-3xl font-bold">Create Your Activity</h2>
      <div class="flex gap-3">
        <button class="btn btn-ghost" onclick="toggleMode()">
          <i class="fas fa-exchange-alt mr-2"></i>
          <span id="mode-toggle-text">Switch to Play Mode</span>
        </button>
        <button class="btn btn-accent" onclick="toggleActivitySettings()">
          <i class="fas fa-cog mr-2"></i>
          <span id="settings-toggle-text">Hide Settings</span>
        </button>
        <button class="btn btn-secondary" onclick="resetActivity()">
          <i class="fas fa-redo mr-2"></i>
          Reset
        </button>
      </div>
    </div>
    
    <!-- Activity Settings Panel (Visible by default) -->
    <div id="activity-settings-panel" class="card mb-6" style="border: 2px solid var(--primary);">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">Activity Settings</h3>
        <button class="btn btn-ghost btn-sm" onclick="toggleActivitySettings()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm text-muted mb-2">Activity Title</label>
          <input id="activity-title-dashboard" type="text" placeholder="My Awesome Activity" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
        </div>
        
        <div>
          <label class="block text-sm text-muted mb-2">Template</label>
          <select id="template-selector" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" onchange="changeTemplate(this.value)">
            <option value="mcq">Quiz</option>
            <option value="truefalse">True or False</option>
            <option value="flipcards">Flash Cards</option>
            <option value="dragdrop">Match Up</option>
            <option value="contentreveal">Content Reveal Panels</option>
            <option value="mentaldrag">Mental Health Drag & Drop</option>
            <option value="pickmany">Pick Many Quiz</option>
            <option value="infocard">Info Card Display</option>
            <option value="scormviewer">SCORM Package Viewer</option>
            <option value="interactivevideo">Interactive Video</option>
            <option value="gamearena">Game Arena</option>
            <option value="crossword">Crossword Puzzle</option>
            <option value="timeline">Timeline</option>
            <option value="matchingpairs">Matching Pairs</option>
            <option value="sorting">Sorting Activity</option>
            <option value="labeldiagram">Label Diagram</option>
            <option value="wordsearch">Word Search</option>
            <option value="survey">Survey/Poll</option>
            <option value="accordion">Accordion FAQ</option>
            <option value="imagehotspot">Image Hotspot</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm text-muted mb-2">Game ID</label>
          <input id="game-id" type="text" value="demo" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
        </div>
        
        <div>
          <label class="block text-sm text-muted mb-2">Colors & Theme</label>
          <button class="btn btn-primary w-full" onclick="toggleColorCustomization()">
            <i class="fas fa-palette mr-2"></i>
            <span id="color-toggle-text">Customize Colors</span>
          </button>
        </div>
      </div>
      
      <!-- Color Customization Panel -->
      <div id="color-customization-panel" class="hidden mt-4 p-4 rounded-lg" style="background-color: var(--drag-bg); border: 1px solid var(--card-border);">
        <h4 class="text-lg font-bold mb-3">Color Customization</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm text-muted mb-2">Primary Color</label>
            <div class="flex gap-2">
              <input id="custom-primary-color" type="color" value="#2563eb" class="w-16 h-10 rounded cursor-pointer">
              <input type="text" id="custom-primary-hex" value="#2563eb" class="flex-1 px-3 py-2 rounded text-sm" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" oninput="updateCustomColor('primary', this.value)">
            </div>
          </div>
          
          <div>
            <label class="block text-sm text-muted mb-2">Background Color</label>
            <div class="flex gap-2">
              <input id="custom-bg-color" type="color" value="#0f1419" class="w-16 h-10 rounded cursor-pointer">
              <input type="text" id="custom-bg-hex" value="#0f1419" class="flex-1 px-3 py-2 rounded text-sm" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" oninput="updateCustomColor('background', this.value)">
            </div>
          </div>
          
          <div>
            <label class="block text-sm text-muted mb-2">Accent Color</label>
            <div class="flex gap-2">
              <input id="custom-accent-color" type="color" value="#14b8a6" class="w-16 h-10 rounded cursor-pointer">
              <input type="text" id="custom-accent-hex" value="#14b8a6" class="flex-1 px-3 py-2 rounded text-sm" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" oninput="updateCustomColor('accent', this.value)">
            </div>
          </div>
        </div>
        
        <div class="flex gap-3 mt-4">
          <button class="btn btn-primary" onclick="applyCustomColors()">
            <i class="fas fa-check mr-2"></i>
            Apply Colors
          </button>
          <button class="btn btn-ghost" onclick="resetCustomColors()">
            <i class="fas fa-undo mr-2"></i>
            Reset to Default
          </button>
        </div>
      </div>
      
      <div class="flex gap-3 mt-4">
        <button id="load-btn" class="btn btn-ghost" onclick="loadActivity(true)">
          <i class="fas fa-download mr-2"></i>
          Load Activity
        </button>
        <button id="save-btn" class="btn btn-primary" onclick="saveActivity()">
          <i class="fas fa-save mr-2"></i>
          Save Activity
        </button>
        <button id="publish-btn" class="btn btn-accent" onclick="publishToPublicGallery()" title="Share this template with the community">
          <i class="fas fa-globe mr-2"></i>
          Publish to Gallery
        </button>
        <div class="text-sm text-muted flex items-center" id="save-status">Not saved yet</div>
      </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="card">
      <h3 id="activity-display-title" class="text-2xl font-bold mb-6">Untitled Activity</h3>
          
          <!-- Play Mode -->
          <div id="play-mode">
            <!-- Enhanced Controls Toolbar -->
            <div id="enhanced-controls" class="mb-4 p-3 rounded-lg flex flex-wrap gap-2 items-center justify-between" style="background-color: var(--button-bg); border: 1px solid var(--button-border);">
              <div class="flex flex-wrap gap-2">
                <button class="btn btn-sm" onclick="shareActivity()" title="Share this activity">
                  <i class="fas fa-share-alt mr-1"></i>
                  Share
                </button>
                <button class="btn btn-sm" onclick="showEmbedCode()" title="Get embed code">
                  <i class="fas fa-code mr-1"></i>
                  Embed
                </button>
                <button class="btn btn-sm" onclick="toggleFullscreen()" title="Fullscreen mode">
                  <div class="icon-fullscreen mr-1"></div>
                  <span id="fullscreen-text">Fullscreen</span>
                </button>
                <button class="btn btn-sm" onclick="toggleTimer()" title="Start/Stop timer">
                  <i class="fas fa-stopwatch mr-1"></i>
                  <span id="timer-display">00:00</span>
                </button>
                <button class="btn btn-sm" onclick="toggleSound()" title="Toggle sound" id="sound-btn">
                  <div class="icon-volume" id="sound-icon"></div>
                </button>
              </div>
              <div class="text-xs text-muted hidden md:block">Activity Controls</div>
            </div>
            
            <div id="play-area" class="mb-8 min-h-[300px]"></div>
            <div class="flex flex-wrap gap-3" id="play-controls"></div>
          </div>
          
          <!-- Edit Mode -->
          <div id="edit-mode" class="hidden">
            <div class="text-muted text-sm mb-4">Edit your content, then click Save Activity to store your changes.</div>
            <div id="editor" class="space-y-6"></div>
            <div class="divider my-6"></div>
            <div class="flex justify-between">
              <button id="add-item-btn" class="btn">
                <i class="fas fa-plus mr-2"></i>
                Add Item
              </button>
              <button id="save-changes-btn-dashboard" class="btn btn-accent">
                <i class="fas fa-save mr-2"></i>
                Save Changes
              </button>
              <button id="publish-btn-dashboard" class="btn btn-secondary" onclick="publishToPublicGallery()" title="Share this template with the community">
                <i class="fas fa-globe mr-2"></i>
                Publish
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Share Modal -->
  <div id="share-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeShareModal(event)">
    <div class="card max-w-md w-full mx-4" onclick="event.stopPropagation()">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Share Activity</h2>
        <button onclick="closeShareModal()" class="btn btn-ghost p-2">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-muted mb-2">Share Link</label>
          <div class="flex gap-2">
            <input id="share-link-input" type="text" readonly class="flex-1 px-4 py-2 rounded-lg outline-none" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
            <button class="btn btn-primary" onclick="copyShareLink()">
              <i class="fas fa-copy"></i>
            </button>
          </div>
          <p class="text-xs text-muted mt-1">Copy and share this link with your students</p>
        </div>
        
        <div class="divider"></div>
        
        <div class="flex justify-center gap-3">
          <button class="btn btn-ghost" onclick="shareToSocial('twitter')" title="Share on Twitter">
            <i class="fab fa-twitter text-xl"></i>
          </button>
          <button class="btn btn-ghost" onclick="shareToSocial('facebook')" title="Share on Facebook">
            <i class="fab fa-facebook text-xl"></i>
          </button>
          <button class="btn btn-ghost" onclick="shareToSocial('linkedin')" title="Share on LinkedIn">
            <i class="fab fa-linkedin text-xl"></i>
          </button>
          <button class="btn btn-ghost" onclick="shareToSocial('whatsapp')" title="Share on WhatsApp">
            <i class="fab fa-whatsapp text-xl"></i>
          </button>
          <button class="btn btn-ghost" onclick="shareToSocial('email')" title="Share via Email">
            <i class="fas fa-envelope text-xl"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Embed Modal -->
  <div id="embed-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeEmbedModal(event)">
    <div class="card max-w-2xl w-full mx-4" onclick="event.stopPropagation()">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Embed Code</h2>
        <button onclick="closeEmbedModal()" class="btn btn-ghost p-2">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-muted mb-2">Embed Options</label>
          <div class="grid grid-cols-2 gap-3 mb-4">
            <div>
              <label class="block text-xs text-muted mb-1">Width</label>
              <input id="embed-width" type="text" value="800" class="w-full px-3 py-2 rounded-lg outline-none" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" oninput="updateEmbedCode()">
            </div>
            <div>
              <label class="block text-xs text-muted mb-1">Height</label>
              <input id="embed-height" type="text" value="600" class="w-full px-3 py-2 rounded-lg outline-none" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" oninput="updateEmbedCode()">
            </div>
          </div>
        </div>
        
        <div>
          <label class="block text-sm text-muted mb-2">HTML Code</label>
          <div class="relative">
            <textarea id="embed-code-textarea" rows="6" readonly class="w-full px-4 py-3 rounded-lg outline-none font-mono text-sm" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"></textarea>
            <button class="absolute top-2 right-2 btn btn-sm btn-primary" onclick="copyEmbedCode()">
              <i class="fas fa-copy mr-1"></i>
              Copy
            </button>
          </div>
          <p class="text-xs text-muted mt-1">Paste this code into your website or LMS</p>
        </div>
        
        <div class="p-4 rounded-lg" style="background-color: var(--drag-bg); border: 1px solid var(--card-border);">
          <p class="text-sm mb-2"><strong>Preview:</strong></p>
          <div id="embed-preview" class="rounded overflow-hidden" style="background-color: var(--background);"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Template Conversion Modal -->
  <div id="convert-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeConvertModal(event)">
    <div class="card max-w-md w-full mx-4" onclick="event.stopPropagation()">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Convert Template</h2>
        <button onclick="closeConvertModal()" class="btn btn-ghost p-2">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="space-y-4">
        <div class="p-4 rounded-lg" style="background-color: var(--drag-bg); border: 1px solid var(--card-border);">
          <p class="text-sm mb-2"><strong>Current Template:</strong></p>
          <p class="text-muted" id="convert-current-type">Quiz</p>
        </div>
        
        <div>
          <label class="block text-sm text-muted mb-2">Convert To:</label>
          <select id="convert-target-type" class="w-full px-4 py-2 rounded-lg outline-none" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
            <option value="">Select template type...</option>
            <option value="mcq">Quiz</option>
            <option value="truefalse">True or False</option>
            <option value="flipcards">Flash Cards</option>
            <option value="dragdrop">Match Up</option>
            <option value="contentreveal">Content Reveal</option>
            <option value="accordion">Accordion FAQ</option>
            <option value="survey">Survey</option>
          </select>
        </div>
        
        <div class="p-3 rounded-lg" style="background-color: rgba(251, 191, 36, 0.1); border: 1px solid rgb(251, 191, 36);">
          <p class="text-sm" style="color: rgb(251, 191, 36);">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <strong>Note:</strong> Converting will attempt to preserve your content, but some data may be lost due to template differences.
          </p>
        </div>
        
        <div class="flex gap-3">
          <button class="btn btn-ghost flex-1" onclick="closeConvertModal()">
            Cancel
          </button>
          <button class="btn btn-primary flex-1" onclick="confirmTemplateConversion()">
            <i class="fas fa-exchange-alt mr-2"></i>
            Convert
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="max-w-6xl mx-auto px-4 py-12 mt-16">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
      <div>
        <h3 class="text-xl font-bold mb-4">Tamer Educational Activities</h3>
        <p class="text-muted">Create better lessons quicker with our interactive learning platform.</p>
      </div>
      <div>
        <h4 class="font-bold mb-4">Templates</h4>
        <ul class="space-y-2 text-muted">
          <li><a href="#" class="hover:text-primary">Quiz</a></li>
          <li><a href="#" class="hover:text-primary">Flash Cards</a></li>
          <li><a href="#" class="hover:text-primary">Match Up</a></li>
          <li><a href="#" class="hover:text-primary">Group Sort</a></li>
        </ul>
      </div>
      <div>
        <h4 class="font-bold mb-4">Resources</h4>
        <ul class="space-y-2 text-muted">
          <li><a href="#" class="hover:text-primary">Blog</a></li>
          <li><a href="#" class="hover:text-primary">Community</a></li>
          <li><a href="#" class="hover:text-primary">Help Center</a></li>
          <li><a href="#" class="hover:text-primary">Tutorials</a></li>
        </ul>
      </div>
      <div>
        <h4 class="font-bold mb-4">Company</h4>
        <ul class="space-y-2 text-muted">
          <li><a href="#" class="hover:text-primary">About</a></li>
          <li><a href="#" class="hover:text-primary">Careers</a></li>
          <li><a href="#" class="hover:text-primary">Contact</a></li>
          <li><a href="#" class="hover:text-primary">Privacy Policy</a></li>
        </ul>
      </div>
    </div>
    <div class="divider"></div>
    <div class="text-center text-muted text-sm">
       2025 Tamer Educational Activities. All rights reserved.
    </div>
  </footer>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // Make Firebase modules available globally
    window.firebase = {
      initializeApp,
      getAuth,
      signInAnonymously,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signInWithPopup,
      GoogleAuthProvider,
      signOut,
      updateProfile,
      sendPasswordResetEmail,
      getFirestore,
      doc,
      getDoc,
      setDoc,
      deleteDoc,
      collection,
      getDocs
    };

    // Firebase setup
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyCoNkRv0Tyhfxq2kGzcz_F2QuhOdfgFl2Q",
      authDomain: "tamer-educational-activities.firebaseapp.com",
      projectId: "tamer-educational-activities",
      storageBucket: "tamer-educational-activities.firebasestorage.app",
      messagingSenderId: "828282449605",
      appId: "1:828282449605:web:92e0b97fdbe9b3a0efcaac",
      measurementId: "G-DN12CF8L0G"
    };
    
    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.getAuth(app);
    const db = firebase.getFirestore(app);
    
    // State management
    let currentMode = 'play'; // 'play' or 'edit'
    let currentTemplate = 'mcq';
    let activityData = null;
    let uid = null;
    
    // Enhanced controls state
    let timerInterval = null;
    let timerSeconds = 0;
    let timerRunning = false;
    let soundEnabled = true;
    let backgroundMusic = null;
    
    // DOM Elements
    const playMode = document.getElementById('play-mode');
    const editMode = document.getElementById('edit-mode');
    const playArea = document.getElementById('play-area');
    const playControls = document.getElementById('play-controls');
    const editor = document.getElementById('editor');
    const activityTitle = document.getElementById('activity-title');
    const activityDisplayTitle = document.getElementById('activity-display-title');
    const modeToggleText = document.getElementById('mode-toggle-text');
    const addItemBtn = document.getElementById('add-item-btn');
    const saveChangesBtn = document.getElementById('save-changes-btn');
    console.log('Save button found:', saveChangesBtn);
    const saveStatus = document.getElementById('save-status');
    const authButtons = document.getElementById('auth-buttons');
    const userMenu = document.getElementById('user-menu');
    const userDisplayName = document.getElementById('user-display-name');
    
    // Dummy data
    const DUMMIES = {
      mcq: {
        template: "mcq",
        title: "Quiz Activity",
        questions: [
          {q: "What is the capital of France?", options: ["London", "Berlin", "Paris", "Madrid"], correctIndex: 2},
          {q: "What is 2 + 2?", options: ["3", "4", "5", "6"], correctIndex: 1}
        ]
      },
      truefalse: {
        template: "truefalse",
        title: "True or False Activity",
        items: [
          {q: "The Earth is flat.", isTrue: false},
          {q: "Water boils at 100C.", isTrue: true}
        ]
      },
      flipcards: {
        template: "flipcards",
        title: "Flash Cards Activity",
        cards: [
          {front: "Photosynthesis", back: "Process by which plants make food using light"},
          {front: "Osmosis", back: "Movement of water through a semipermeable membrane"}
        ]
      },
      dragdrop: {
        template: "dragdrop",
        title: "Match Up Activity",
        pairs: [
          {left: "France", right: "Paris"},
          {left: "Germany", right: "Berlin"}
        ]
      },
      contentreveal: {
        template: "contentreveal",
        title: "Nutrition Education",
        panels: [
          {title: "Vegetables", content: "Vegetables includes garlic, broccoli, cauliflower, celery, asparagus, okra, lettuce, spinach, onion, carrots, kale, yams, and potatoes.", color: "#F2B565"},
          {title: "Fruits", content: "Fruits includes apples, pears, plums, peaches, oranges, raspberries, blackberries, strawberries, pineapples, figs, tomatoes, cucumbers, and pumpkins.", color: "#F86263"},
          {title: "Grains", content: "Grains includes foods made from wheat, rice, oats, cornmeal, barley, etc., such as bread, pasta, oatmeal, cereals, tortillas, and grits.", color: "#F2B565"},
          {title: "Meats and Proteins", content: "Meats and Proteins includes beans, beef, lamb, pork, chicken, turkey, duck, fish, crab, and lobster.", color: "#F86263"},
          {title: "Dairy", content: "Dairy includes butter, cheese, yogurt, sour cream, ice cream, and milk.", color: "#F2B565"}
        ]
      },
      mentaldrag: {
        template: "mentaldrag",
        title: "Mental Health Awareness",
        dragItems: [
          {text: "Overthinking", id: 1},
          {text: "Feeling like nothing really matters", id: 2},
          {text: "Being distracted or lacking focus", id: 3},
          {text: "Becoming bossy or aggressive", id: 4},
          {text: "Making poor decisions", id: 5}
        ],
        dropZones: [
          {label: "Mental Health Symptom 1", correctId: 1},
          {label: "Mental Health Symptom 2", correctId: 2},
          {label: "Mental Health Symptom 3", correctId: 3},
          {label: "Mental Health Symptom 4", correctId: 4},
          {label: "Mental Health Symptom 5", correctId: 5}
        ]
      },
      pickmany: {
        template: "pickmany",
        title: "The Healthy vs. Unhealthy Relationships Vibe Check",
        question: "Select all signs of a healthy relationship:",
        items: [
          {text: "Get jealous of your successes", isCorrect: false},
          {text: "Respect your boundaries", isCorrect: true},
          {text: "Support your goals", isCorrect: true},
          {text: "Try to control your decisions", isCorrect: false},
          {text: "Listen to your feelings", isCorrect: true},
          {text: "Make you feel guilty", isCorrect: false}
        ]
      },
      infocard: {
        template: "infocard",
        title: "YOUR MENTAL HEALTH",
        subtitle: "Understanding Mental Wellness",
        description: "Mental health includes our emotional, psychological, and social well-being. It affects how we think, feel, and act.",
        colorBars: [
          {color: "#BCD659", label: "Emotional"},
          {color: "#9F76D7", label: "Psychological"},
          {color: "#F86263", label: "Social"},
          {color: "#F2B565", label: "Physical"}
        ]
      },
      scormviewer: {
        template: "scormviewer",
        title: "Tamer Educational Activities SCORM Package",
        scormUrl: "scorm/story.html",
        description: "Interactive SCORM content from Storyline 360",
        width: "100%",
        height: "600px"
      },
      interactivevideo: {
        template: "interactivevideo",
        title: "Interactive Video Lesson",
        videoUrl: "https://www.youtube.com/embed/dQw4w9WgXcQ",
        videoType: "youtube",
        description: "Watch the video and answer questions at specific timestamps",
        questions: [
          {
            timestamp: 30,
            question: "What concept was just explained?",
            options: ["Photosynthesis", "Respiration", "Digestion"],
            correctIndex: 0
          },
          {
            timestamp: 60,
            question: "Which statement is correct?",
            options: ["Plants produce oxygen", "Plants produce carbon dioxide", "Plants don't breathe"],
            correctIndex: 0
          }
        ],
        score: 0,
        totalQuestions: 2
      },
      gamearena: {
        template: "gamearena",
        title: "Game Arena Activity",
        packagePath: "Game Arena",
        description: "Interactive game-based learning experience",
        width: "100%",
        height: "700px",
        instructions: "Complete the game challenges to test your knowledge"
      },
      crossword: {
        template: "crossword",
        title: "Crossword Puzzle",
        description: "Solve the crossword using the clues provided",
        gridSize: 10,
        words: [
          {word: "SCIENCE", clue: "The study of the natural world", startX: 0, startY: 0, direction: "across"},
          {word: "HISTORY", clue: "The study of past events", startX: 0, startY: 2, direction: "across"},
          {word: "MATH", clue: "Numbers and calculations", startX: 0, startY: 4, direction: "across"}
        ]
      },
      timeline: {
        template: "timeline",
        title: "Historical Timeline",
        description: "Explore key events in chronological order",
        events: [
          {year: 1969, title: "Moon Landing", description: "First human steps on the moon", color: "#2563eb"},
          {year: 1989, title: "Fall of Berlin Wall", description: "End of Cold War symbol", color: "#14b8a6"},
          {year: 2001, title: "First iPod", description: "Revolutionary music player", color: "#f59e0b"}
        ]
      },
      matchingpairs: {
        template: "matchingpairs",
        title: "Memory Matching Game",
        description: "Find all matching pairs",
        pairs: [
          {id: 1, content: "Apple", imageUrl: ""},
          {id: 2, content: "Banana", imageUrl: ""},
          {id: 3, content: "Cherry", imageUrl: ""},
          {id: 4, content: "Grape", imageUrl: ""}
        ]
      },
      sorting: {
        template: "sorting",
        title: "Sorting Activity",
        description: "Sort items into the correct categories",
        categories: [
          {name: "Fruits", color: "#f59e0b"},
          {name: "Vegetables", color: "#10b981"},
          {name: "Grains", color: "#8b5cf6"}
        ],
        items: [
          {text: "Apple", category: "Fruits"},
          {text: "Carrot", category: "Vegetables"},
          {text: "Rice", category: "Grains"},
          {text: "Banana", category: "Fruits"}
        ]
      },
      labeldiagram: {
        template: "labeldiagram",
        title: "Label the Diagram",
        description: "Click on hotspots to label the diagram",
        imageUrl: "https://via.placeholder.com/800x600?text=Diagram+Image",
        labels: [
          {x: 20, y: 30, text: "Label 1", correct: "Part A"},
          {x: 50, y: 40, text: "Label 2", correct: "Part B"},
          {x: 70, y: 60, text: "Label 3", correct: "Part C"}
        ]
      },
      wordsearch: {
        template: "wordsearch",
        title: "Word Search Puzzle",
        description: "Find all hidden words in the grid",
        words: ["EDUCATION", "LEARNING", "TEACHER", "STUDENT", "SCHOOL"],
        gridSize: 10
      },
      survey: {
        template: "survey",
        title: "Student Survey",
        description: "Share your opinions and feedback",
        questions: [
          {type: "rating", question: "How would you rate this course?", scale: 5},
          {type: "multiple", question: "What's your favorite subject?", options: ["Math", "Science", "History", "Art"]},
          {type: "text", question: "What improvements would you suggest?"}
        ]
      },
      accordion: {
        template: "accordion",
        title: "Frequently Asked Questions",
        description: "Click questions to expand answers",
        items: [
          {question: "What is photosynthesis?", answer: "The process by which plants convert light energy into chemical energy."},
          {question: "What is gravity?", answer: "The force that attracts objects toward each other."},
          {question: "What is DNA?", answer: "Deoxyribonucleic acid - the molecule that carries genetic information."}
        ]
      },
      imagehotspot: {
        template: "imagehotspot",
        title: "Interactive Image Hotspots",
        description: "Click on hotspots to learn more",
        imageUrl: "https://via.placeholder.com/800x600?text=Interactive+Image",
        hotspots: [
          {x: 25, y: 30, title: "Hotspot 1", description: "Information about this area", icon: "info"},
          {x: 60, y: 50, title: "Hotspot 2", description: "Details about this feature", icon: "star"},
          {x: 80, y: 70, title: "Hotspot 3", description: "Learn more here", icon: "question"}
        ]
      }
    };
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize theme
      initTheme();
      
      // Animate resource counter
      animateResourceCounter();
      
      // Set up Firebase auth state listener with fallback
      firebase.onAuthStateChanged(auth, async (user) => {
        if (!user) {
          // Show auth buttons, hide user menu
          if (authButtons) authButtons.classList.remove('hidden');
          if (userMenu) userMenu.classList.add('hidden');
          
          // Show Sign Up button on home page
          const signupCtaHome = document.getElementById('signup-cta-home');
          if (signupCtaHome) signupCtaHome.style.display = 'inline-block';
          
          // Hide sidebar My Templates section for guests
          const sidebarMyTemplates = document.getElementById('sidebar-my-templates');
          if (sidebarMyTemplates) sidebarMyTemplates.style.display = 'none';
          
          // Use a persistent guest ID from localStorage for guest mode
          uid = localStorage.getItem('guestUserId');
          console.log('Guest mode - UID from localStorage:', uid);
          if (!uid) {
            uid = 'guest_' + Math.random().toString(36).substring(2, 15);
            localStorage.setItem('guestUserId', uid);
            console.log('Generated new guest UID:', uid);
          }
          updateStatus('Working in guest mode (local storage)');
          return;
        }
        
        // User is signed in
        uid = user.uid;
        console.log('User signed in - UID:', uid);
        
        // Update UI
        if (authButtons) authButtons.classList.add('hidden');
        if (userMenu) userMenu.classList.remove('hidden');
        
        // Hide Sign Up button on home page
        const signupCtaHome = document.getElementById('signup-cta-home');
        if (signupCtaHome) signupCtaHome.style.display = 'none';
        
        // Display user name
        if (userDisplayName) {
          if (user.displayName) {
            userDisplayName.textContent = user.displayName;
          } else if (user.email) {
            userDisplayName.textContent = user.email.split('@')[0];
          } else {
            userDisplayName.textContent = 'User';
          }
        }
        
        // Show sidebar My Templates section for authenticated users
        const sidebarMyTemplates = document.getElementById('sidebar-my-templates');
        if (sidebarMyTemplates) sidebarMyTemplates.style.display = 'block';
        
        // Show admin section for admin users
        const sidebarAdmin = document.getElementById('sidebar-admin');
        if (sidebarAdmin && isAdmin(user.email)) {
          sidebarAdmin.style.display = 'block';
        }
        
        updateStatus('Signed in as ' + (user.email || 'anonymous'));
      });
    });
    
    // Update status
    window.updateStatus = function(msg) {
      console.log('Status update:', msg);
      if (saveStatus) {
        saveStatus.textContent = msg;
      }
    };
    
    // Animate resource counter on homepage
    function animateResourceCounter() {
      const counter = document.getElementById('resource-counter');
      if (!counter) return;
      
      // Target number - you can update this or fetch from Firebase
      const targetCount = 5247892; // Inspired by Wordwall's approach
      const duration = 2000; // 2 seconds
      const increment = targetCount / (duration / 16); // 60fps
      let current = 0;
      
      const timer = setInterval(() => {
        current += increment;
        if (current >= targetCount) {
          counter.textContent = targetCount.toLocaleString();
          clearInterval(timer);
        } else {
          counter.textContent = Math.floor(current).toLocaleString();
        }
      }, 16);
    }
    
    // Get actual resource count from Firebase (optional enhancement)
    async function getResourceCount() {
      try {
        // In future, query Firebase for actual count
        // For now, return a static impressive number
        return 5247892;
      } catch (error) {
        console.error('Error getting resource count:', error);
        return 5247892;
      }
    }
    
    // ===== Authentication Functions =====
    
    // Show authentication modal
    window.showAuthModal = function(mode) {
      console.log('Showing auth modal with mode:', mode);
      const modal = document.getElementById('auth-modal');
      const modalTitle = document.getElementById('auth-modal-title');
      const signupForm = document.getElementById('signup-form');
      const loginForm = document.getElementById('login-form');
      const errorDiv = document.getElementById('auth-error');
      
      // Hide error message
      if (errorDiv) {
        errorDiv.classList.add('hidden');
      }
      
      if (mode === 'signup') {
        modalTitle.textContent = 'Sign Up';
        signupForm.classList.remove('hidden');
        loginForm.classList.add('hidden');
      } else {
        modalTitle.textContent = 'Log In';
        signupForm.classList.add('hidden');
        loginForm.classList.remove('hidden');
      }
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    };
    
    // Close authentication modal
    window.closeAuthModal = function(event) {
      console.log('Closing auth modal');
      const modal = document.getElementById('auth-modal');
      
      // If event is provided and it's not a click on the backdrop, return
      if (event && event.target !== modal) {
        return;
      }
      
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      
      // Clear form fields
      const inputs = modal.querySelectorAll('input');
      inputs.forEach(input => {
        if (input.type !== 'checkbox') {
          input.value = '';
        }
      });
      
      // Hide error message
      const errorDiv = document.getElementById('auth-error');
      if (errorDiv) {
        errorDiv.classList.add('hidden');
      }
    };
    
    // Switch to login form
    window.switchToLogin = function(event) {
      console.log('Switching to login form');
      event.preventDefault();
      showAuthModal('login');
    };
    
    // Switch to signup form
    window.switchToSignup = function(event) {
      console.log('Switching to signup form');
      event.preventDefault();
      showAuthModal('signup');
    };
    
    // Show error message
    function showAuthError(message) {
      const errorDiv = document.getElementById('auth-error');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
      }
    }
    
    // Handle signup
    window.handleSignup = async function() {
      console.log('Handling signup');
      const name = document.getElementById('signup-name').value.trim();
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;
      const confirmPassword = document.getElementById('signup-confirm-password').value;
      const signupBtn = document.getElementById('signup-btn');
      
      // Validation
      if (!name) {
        showAuthError('Please enter your name');
        return;
      }
      
      if (!email) {
        showAuthError('Please enter your email');
        return;
      }
      
      if (!password) {
        showAuthError('Please enter a password');
        return;
      }
      
      if (password.length < 6) {
        showAuthError('Password must be at least 6 characters');
        return;
      }
      
      if (password !== confirmPassword) {
        showAuthError('Passwords do not match');
        return;
      }
      
      // Disable button and show loading
      signupBtn.disabled = true;
      signupBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating Account...';
      
      try {
        // Create user
        const userCredential = await firebase.createUserWithEmailAndPassword(auth, email, password);
        
        // Update profile with name
        await firebase.updateProfile(userCredential.user, {
          displayName: name
        });
        
        // Close modal
        closeAuthModal();
        
        // Show success message
        updateStatus('Account created successfully!');
      } catch (error) {
        console.error('Signup error:', error);
        let errorMessage = 'Failed to create account. Please try again.';
        
        if (error.code === 'auth/email-already-in-use') {
          errorMessage = 'This email is already registered. Please log in instead or use a different email.';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'Please enter a valid email address.';
        } else if (error.code === 'auth/weak-password') {
          errorMessage = 'Password is too weak. Please use at least 6 characters.';
        } else if (error.code === 'auth/operation-not-allowed') {
          errorMessage = 'Email/Password signup is not enabled. Please enable it in Firebase Console.';
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = 'Network error. Please check your internet connection.';
        }
        
        showAuthError(errorMessage);
      } finally {
        // Re-enable button
        signupBtn.disabled = false;
        signupBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Create Account';
      }
    };
    
    // Handle login
    window.handleLogin = async function() {
      console.log('Handling login');
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const loginBtn = document.getElementById('login-btn');
      
      // Validation
      if (!email) {
        showAuthError('Please enter your email');
        return;
      }
      
      if (!password) {
        showAuthError('Please enter your password');
        return;
      }
      
      // Disable button and show loading
      loginBtn.disabled = true;
      loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Logging In...';
      
      try {
        // Sign in
        await firebase.signInWithEmailAndPassword(auth, email, password);
        
        // Close modal
        closeAuthModal();
        
        // Show success message
        updateStatus('Logged in successfully!');
      } catch (error) {
        console.error('Login error:', error);
        let errorMessage = 'Failed to log in. Please try again.';
        
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
          errorMessage = 'Invalid email or password. If you don\'t have an account, please Sign Up first.';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'Please enter a valid email address.';
        } else if (error.code === 'auth/too-many-requests') {
          errorMessage = 'Too many failed attempts. Please try again later.';
        } else if (error.code === 'auth/user-disabled') {
          errorMessage = 'This account has been disabled.';
        } else if (error.code === 'auth/operation-not-allowed') {
          errorMessage = 'Email/Password login is not enabled. Please contact support.';
        }
        
        showAuthError(errorMessage);
      } finally {
        // Re-enable button
        loginBtn.disabled = false;
        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Log In';
      }
    };
    
    // Handle Google Sign-In
    window.handleGoogleSignIn = async function() {
      try {
        const provider = new firebase.GoogleAuthProvider();
        await firebase.signInWithPopup(auth, provider);
        
        // Close modal
        closeAuthModal();
        
        // Show success message
        updateStatus('Signed in with Google successfully!');
      } catch (error) {
        console.error('Google sign-in error:', error);
        let errorMessage = 'Failed to sign in with Google. Please try again.';
        
        if (error.code === 'auth/popup-closed-by-user') {
          errorMessage = 'Sign-in cancelled.';
        } else if (error.code === 'auth/popup-blocked') {
          errorMessage = 'Popup was blocked. Please allow popups for this site.';
        }
        
        showAuthError(errorMessage);
      }
    };
    
    // Handle logout
    window.handleLogout = async function() {
      if (confirm('Are you sure you want to log out?')) {
        try {
          await firebase.signOut(auth);
          updateStatus('Logged out successfully');
          
          // Reload page to reset state
          window.location.reload();
        } catch (error) {
          console.error('Logout error:', error);
          alert('Failed to log out. Please try again.');
        }
      }
    };
    
    // Handle forgot password
    window.handleForgotPassword = async function(event) {
      event.preventDefault();
      
      const email = document.getElementById('login-email').value.trim();
      
      if (!email) {
        showAuthError('Please enter your email address first');
        return;
      }
      
      try {
        await firebase.sendPasswordResetEmail(auth, email);
        showAuthError('Password reset email sent! Please check your inbox.');
      } catch (error) {
        console.error('Password reset error:', error);
        let errorMessage = 'Failed to send password reset email.';
        
        if (error.code === 'auth/user-not-found') {
          errorMessage = 'No account found with this email address.';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'Please enter a valid email address.';
        }
        
        showAuthError(errorMessage);
      }
    };
    
    // Allow Enter key to submit forms
    document.addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        const modal = document.getElementById('auth-modal');
        if (modal && !modal.classList.contains('hidden')) {
          const signupForm = document.getElementById('signup-form');
          const loginForm = document.getElementById('login-form');
          
          if (!signupForm.classList.contains('hidden')) {
            handleSignup();
          } else if (!loginForm.classList.contains('hidden')) {
            handleLogin();
          }
        }
      }
    });
    
    // ===== End Authentication Functions =====
    
    // ===== Dashboard Functions =====
    
    // Show/hide dashboard based on auth state
    window.toggleDashboard = function(show) {
      const dashboard = document.getElementById('my-templates-dashboard');
      if (dashboard) {
        if (show && !uid.startsWith('guest_')) {
          dashboard.classList.remove('hidden');
          refreshMyTemplates();
        } else {
          dashboard.classList.add('hidden');
        }
      }
    };
    
    // Refresh my templates list
    window.refreshMyTemplates = async function() {
      console.log('Refreshing My Templates');
      const templatesList = document.getElementById('my-templates-list');
      if (!templatesList) return;
      
      if (!uid || uid.startsWith('guest_')) {
        templatesList.innerHTML = '<div class="text-center py-12 text-muted col-span-full">Sign in to save and manage your templates</div>';
        return;
      }
      
      try {
        templatesList.innerHTML = '<div class="text-center py-12 text-muted col-span-full">Loading...</div>';
        
        // Load all template types including gamearena
        const templateTypes = ['mcq', 'truefalse', 'flipcards', 'dragdrop', 'contentreveal', 'mentaldrag', 'pickmany', 'infocard', 'scormviewer', 'interactivevideo', 'gamearena'];
        const templateNames = {
          'mcq': 'Quiz',
          'truefalse': 'True or False',
          'flipcards': 'Flash Cards',
          'dragdrop': 'Match Up',
          'contentreveal': 'Content Reveal',
          'mentaldrag': 'Mental Health Drag',
          'pickmany': 'Pick Many Quiz',
          'infocard': 'Info Card',
          'scormviewer': 'SCORM Viewer',
          'interactivevideo': 'Interactive Video',
          'gamearena': 'Game Arena'
        };
        
        const icons = {
          'mcq': 'fa-list',
          'truefalse': 'fa-check-circle',
          'flipcards': 'fa-clone',
          'dragdrop': 'fa-hand-pointer',
          'contentreveal': 'fa-window-restore',
          'mentaldrag': 'fa-brain',
          'pickmany': 'fa-tasks',
          'infocard': 'fa-info-circle',
          'scormviewer': 'fa-play-circle',
          'interactivevideo': 'fa-video',
          'gamearena': 'fa-gamepad'
        };
        
        const savedTemplates = [];
        
        for (const templateType of templateTypes) {
          const ref = firebase.doc(db, 'users', uid, 'templates', templateType);
          const snap = await firebase.getDoc(ref);
          
          if (snap.exists()) {
            const data = snap.data();
            savedTemplates.push({
              type: templateType,
              name: templateNames[templateType],
              icon: icons[templateType],
              title: data.title || 'Untitled',
              lastModified: data.lastModified || data.createdAt || 'Unknown'
            });
          }
        }
        
        if (savedTemplates.length === 0) {
          templatesList.innerHTML = `
            <div class="text-center py-12 text-muted col-span-full">
              <i class="fas fa-folder-open text-4xl mb-4"></i>
              <p>No saved templates yet. Create and save your first template!</p>
            </div>
          `;
          return;
        }
        
        // Display saved templates
        templatesList.innerHTML = '';
        savedTemplates.forEach(template => {
          const templateCard = document.createElement('div');
          templateCard.className = 'template-card';
          
          const lastModified = new Date(template.lastModified).toLocaleDateString();
          const plays = template.analytics?.plays || 0;
          const avgScore = template.analytics?.avgScore || 0;
          
          templateCard.innerHTML = `
            <div class="flex flex-col h-full">
              <div class="flex items-start gap-4 mb-4">
                <div class="w-12 h-12 rounded-lg flex items-center justify-center text-primary" style="background-color: var(--drag-bg);">
                  <i class="fas ${template.icon}"></i>
                </div>
                <div class="flex-1">
                  <h3 class="text-lg font-bold mb-1">${template.name}</h3>
                  <p class="text-sm text-muted template-title-display" id="title-display-${template.type}">${template.title}</p>
                  <input type="text" class="hidden w-full px-2 py-1 rounded text-sm template-title-input" id="title-input-${template.type}" value="${template.title}" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
                  <p class="text-xs text-muted mt-1">Modified: ${lastModified}</p>
                </div>
              </div>
              
              <!-- Analytics Stats -->
              <div class="grid grid-cols-2 gap-2 mb-3 p-3 rounded-lg" style="background-color: var(--drag-bg); border: 1px solid var(--card-border);">
                <div class="text-center">
                  <div class="text-xs text-muted">Plays</div>
                  <div class="text-lg font-bold" style="color: var(--primary);">${plays}</div>
                </div>
                <div class="text-center">
                  <div class="text-xs text-muted">Avg Score</div>
                  <div class="text-lg font-bold" style="color: var(--success);">${avgScore}%</div>
                </div>
              </div>
              
              <div class="flex flex-col gap-2 mt-auto">
                <div class="flex gap-2">
                  <button class="btn btn-primary flex-1" onclick="loadSavedTemplate('${template.type}')">
                    <i class="fas fa-edit mr-2"></i>
                    Edit
                  </button>
                  <button class="btn btn-accent" onclick="previewTemplate('${template.type}')" title="Preview in play mode">
                    <i class="fas fa-play"></i>
                  </button>
                  <button class="btn btn-ghost" onclick="renameTemplate('${template.type}')" title="Rename">
                    <i class="fas fa-pen"></i>
                  </button>
                  <button class="btn btn-ghost" onclick="deleteSavedTemplate('${template.type}')" title="Delete">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
                <div class="flex gap-2">
                  <button class="btn btn-ghost flex-1 text-xs" onclick="exportToSCORM('${template.type}')" title="Export as SCORM package">
                    <i class="fas fa-box mr-1"></i>
                    SCORM
                  </button>
                  <button class="btn btn-ghost flex-1 text-xs" onclick="exportToStoryline('${template.type}')" title="Export as Storyline file">
                    <i class="fas fa-file-archive mr-1"></i>
                    Storyline
                  </button>
                  <button class="btn btn-ghost flex-1 text-xs" onclick="exportSourceFile('${template.type}')" title="Download HTML source">
                    <i class="fas fa-code mr-1"></i>
                    HTML
                  </button>
                </div>
                <div class="flex gap-2">
                  <button class="btn btn-ghost flex-1 text-xs" onclick="shareTemplate('${template.type}')" title="Share via social media or link">
                    <i class="fas fa-share-alt mr-1"></i>
                    Share
                  </button>
                  <button class="btn btn-ghost flex-1 text-xs" onclick="getEmbedCode('${template.type}')" title="Get embed code">
                    <i class="fas fa-code mr-1"></i>
                    Embed
                  </button>
                  <button class="btn btn-ghost flex-1 text-xs" onclick="copyDirectLink('${template.type}')" title="Copy direct link">
                    <i class="fas fa-link mr-1"></i>
                    Link
                  </button>
                </div>
                <div class="flex gap-2">
                  <button class="btn btn-secondary flex-1 text-xs" onclick="showConvertModal('${template.type}')" title="Convert to another template type">
                    <i class="fas fa-exchange-alt mr-1"></i>
                    Convert Template
                  </button>
                </div>
              </div>
            </div>
          `;
          
          templatesList.appendChild(templateCard);
        });
        
      } catch (error) {
        console.error('Error loading templates:', error);
        templatesList.innerHTML = '<div class="text-center py-12 text-muted col-span-full">Error loading templates</div>';
      }
    };
    
    // Load a saved template
    window.loadSavedTemplate = function(templateType) {
      console.log('Loading saved template:', templateType);
      currentTemplate = templateType;
      selectTemplate(templateType);
      
      // Scroll to activity creator
      const activityCreator = document.getElementById('activity-creator');
      if (activityCreator) {
        activityCreator.scrollIntoView({ behavior: 'smooth' });
      }
    };
    
    // Share a saved template
    window.shareSavedTemplate = async function(templateType) {
      if (!uid) {
        alert('Please sign in to share templates.');
        return;
      }
      
      try {
        // Load the template data
        const ref = firebase.doc(db, 'users', uid, 'templates', templateType);
        const snap = await firebase.getDoc(ref);
        
        if (snap.exists()) {
          const templateData = snap.data();
          
          // Generate share link
          const shareUrl = window.location.origin + window.location.pathname + `?template=${templateType}&user=${uid}`;
          
          // Copy to clipboard
          navigator.clipboard.writeText(shareUrl).then(() => {
            updateStatus('Share link copied to clipboard!');
            
            // Show sharing options
            if (confirm(`Template link copied!\n\nShare on social media?`)) {
              // Open sharing dialog
              const text = `Check out this ${templateData.title || 'educational template'} I created!`;
              const socialUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}&quote=${encodeURIComponent(text)}`;
              window.open(socialUrl, '_blank');
            }
          }).catch(err => {
            console.error('Failed to copy link: ', err);
            alert('Failed to copy link. Here it is: ' + shareUrl);
          });
        } else {
          alert('Template not found');
        }
      } catch (error) {
        console.error('Error sharing template:', error);
        alert('Failed to share template. Please try again.');
      }
    };
    
    // Preview template in play mode
    window.previewTemplate = async function(templateType) {
      currentTemplate = templateType;
      
      // Load the template data
      try {
        let templateData;
        if (uid.startsWith('guest_')) {
          const storageKey = `template_${uid}_${templateType}`;
          templateData = JSON.parse(localStorage.getItem(storageKey));
        } else {
          const ref = firebase.doc(db, 'users', uid, 'templates', templateType);
          const snap = await firebase.getDoc(ref);
          templateData = snap.data();
        }
        
        if (templateData) {
          activityData = templateData;
          
          // Switch to play mode
          currentMode = 'play';
          playMode.classList.remove('hidden');
          editMode.classList.add('hidden');
          if (modeToggleText) modeToggleText.textContent = 'Switch to Edit Mode';
          
          // Update display
          updateActivityDisplay();
          renderPlayMode();
          
          // Record play
          await recordPlay();
          
          // Scroll to activity creator
          const activityCreator = document.getElementById('activity-creator');
          if (activityCreator) {
            activityCreator.classList.remove('hidden');
            activityCreator.scrollIntoView({ behavior: 'smooth' });
          }
          
          updateStatus('Preview mode - Try the activity!');
        }
      } catch (error) {
        console.error('Error loading preview:', error);
        updateStatus('Error loading preview');
      }
    };
    
    // Delete a saved template
    window.deleteSavedTemplate = async function(templateType) {
      if (!confirm(`Are you sure you want to delete your saved ${templateType} template? This cannot be undone.`)) {
        return;
      }
      
      try {
        if (uid.startsWith('guest_')) {
          const storageKey = `template_${uid}_${templateType}`;
          localStorage.removeItem(storageKey);
          updateStatus('Template deleted');
        } else {
          const ref = firebase.doc(db, 'users', uid, 'templates', templateType);
          await firebase.deleteDoc(ref);
          updateStatus('Template deleted');
        }
        
        // Refresh the list
        refreshMyTemplates();
      } catch (error) {
        console.error('Error deleting template:', error);
        updateStatus('Error deleting template');
      }
    };
    
    // Rename a saved template
    window.renameTemplate = async function(templateType) {
      const displayElem = document.getElementById(`title-display-${templateType}`);
      const inputElem = document.getElementById(`title-input-${templateType}`);
      
      if (!displayElem || !inputElem) return;
      
      // Toggle visibility
      if (inputElem.classList.contains('hidden')) {
        // Show input, hide display
        displayElem.classList.add('hidden');
        inputElem.classList.remove('hidden');
        inputElem.focus();
        inputElem.select();
        
        // Save on blur or Enter
        const saveRename = async () => {
          const newTitle = inputElem.value.trim();
          if (newTitle && newTitle !== displayElem.textContent) {
            try {
              // Load current template data
              let templateData;
              if (uid.startsWith('guest_')) {
                const storageKey = `template_${uid}_${templateType}`;
                templateData = JSON.parse(localStorage.getItem(storageKey));
              } else {
                const ref = firebase.doc(db, 'users', uid, 'templates', templateType);
                const snap = await firebase.getDoc(ref);
                templateData = snap.data();
              }
              
              // Update title
              templateData.title = newTitle;
              templateData.lastModified = new Date().toISOString();
              
              // Save back
              if (uid.startsWith('guest_')) {
                const storageKey = `template_${uid}_${templateType}`;
                localStorage.setItem(storageKey, JSON.stringify(templateData));
              } else {
                const ref = firebase.doc(db, 'users', uid, 'templates', templateType);
                await firebase.setDoc(ref, templateData);
              }
              
              displayElem.textContent = newTitle;
              updateStatus('Template renamed');
            } catch (error) {
              console.error('Error renaming template:', error);
              updateStatus('Error renaming template');
            }
          }
          
          // Hide input, show display
          inputElem.classList.add('hidden');
          displayElem.classList.remove('hidden');
        };
        
        inputElem.addEventListener('blur', saveRename, { once: true });
        inputElem.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            inputElem.blur();
          }
        }, { once: true });
      }
    };
    
    // ===== Sharing Functions =====
    
    // Share template via modal
    window.shareTemplate = async function(templateType) {
      try {
        // Load template data to get title
        let templateData;
        if (uid.startsWith('guest_')) {
          const storageKey = `template_${uid}_${templateType}`;
          templateData = JSON.parse(localStorage.getItem(storageKey));
        } else {
          const ref = firebase.doc(db, 'users', uid, 'templates', templateType);
          const snap = await firebase.getDoc(ref);
          templateData = snap.data();
        }
        
        if (!templateData) {
          updateStatus('No template data found');
          return;
        }
        
        // Generate share link
        const shareLink = generateShareLink(uid, templateType);
        document.getElementById('share-link-input').value = shareLink;
        
        // Store current share data for social sharing
        window.currentShareData = {
          url: shareLink,
          title: templateData.title || 'Check out this activity!',
          description: `Interactive ${templateType} activity created with Tamer Educational Activities`
        };
        
        // Show share modal
        const modal = document.getElementById('share-modal');
        if (modal) {
          modal.classList.remove('hidden');
          modal.classList.add('flex');
        }
      } catch (error) {
        console.error('Error sharing template:', error);
        updateStatus('Error preparing share link');
      }
    };
    
    // Copy direct link
    window.copyDirectLink = async function(templateType) {
      try {
        const shareLink = generateShareLink(uid, templateType);
        await navigator.clipboard.writeText(shareLink);
        updateStatus('Link copied to clipboard!');
      } catch (error) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = generateShareLink(uid, templateType);
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        updateStatus('Link copied to clipboard!');
      }
    };
    
    // Generate share link
    function generateShareLink(userId, templateType) {
      const baseUrl = window.location.origin + window.location.pathname;
      return `${baseUrl}?share=${userId}_${templateType}`;
    }
    
    // Copy share link from modal
    window.copyShareLink = async function() {
      const input = document.getElementById('share-link-input');
      try {
        await navigator.clipboard.writeText(input.value);
        updateStatus('Link copied to clipboard!');
      } catch (error) {
        input.select();
        document.execCommand('copy');
        updateStatus('Link copied to clipboard!');
      }
    };
    
    // Share to social media
    window.shareToSocial = function(platform) {
      const data = window.currentShareData;
      if (!data) return;
      
      let shareUrl = '';
      
      switch(platform) {
        case 'twitter':
          shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(data.title)}&url=${encodeURIComponent(data.url)}`;
          break;
        case 'facebook':
          shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(data.url)}`;
          break;
        case 'linkedin':
          shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(data.url)}`;
          break;
        case 'whatsapp':
          shareUrl = `https://wa.me/?text=${encodeURIComponent(data.title + ' ' + data.url)}`;
          break;
        case 'email':
          shareUrl = `mailto:?subject=${encodeURIComponent(data.title)}&body=${encodeURIComponent(data.description + '\n\n' + data.url)}`;
          break;
      }
      
      if (shareUrl) {
        window.open(shareUrl, '_blank', 'width=600,height=400');
      }
    };
    
    // Close share modal
    window.closeShareModal = function(event) {
      const modal = document.getElementById('share-modal');
      if (event && event.target !== modal) {
        return;
      }
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    };
    
    // Get embed code
    window.getEmbedCode = async function(templateType) {
      try {
        // Load template data
        let templateData;
        if (uid.startsWith('guest_')) {
          const storageKey = `template_${uid}_${templateType}`;
          templateData = JSON.parse(localStorage.getItem(storageKey));
        } else {
          const ref = firebase.doc(db, 'users', uid, 'templates', templateType);
          const snap = await firebase.getDoc(ref);
          templateData = snap.data();
        }
        
        if (!templateData) {
          updateStatus('No template data found');
          return;
        }
        
        // Store template data for embed code generation
        window.currentEmbedTemplate = {
          type: templateType,
          data: templateData,
          userId: uid
        };
        
        // Show embed modal and update code
        const modal = document.getElementById('embed-modal');
        if (modal) {
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          updateEmbedCode();
        }
      } catch (error) {
        console.error('Error getting embed code:', error);
        updateStatus('Error preparing embed code');
      }
    };
    
    // Update embed code
    window.updateEmbedCode = function() {
      if (!window.currentEmbedTemplate) return;
      
      const width = document.getElementById('embed-width').value || '800';
      const height = document.getElementById('embed-height').value || '600';
      const shareLink = generateShareLink(window.currentEmbedTemplate.userId, window.currentEmbedTemplate.type);
      
      const embedCode = `<iframe src="${shareLink}" width="${width}" height="${height}" frameborder="0" allowfullscreen></iframe>`;
      
      const textarea = document.getElementById('embed-code-textarea');
      if (textarea) {
        textarea.value = embedCode;
      }
      
      // Update preview
      const preview = document.getElementById('embed-preview');
      if (preview) {
        preview.innerHTML = `<iframe src="${shareLink}" width="100%" height="300" frameborder="0" allowfullscreen></iframe>`;
      }
    };
    
    // Copy embed code
    window.copyEmbedCode = async function() {
      const textarea = document.getElementById('embed-code-textarea');
      try {
        await navigator.clipboard.writeText(textarea.value);
        updateStatus('Embed code copied to clipboard!');
      } catch (error) {
        textarea.select();
        document.execCommand('copy');
        updateStatus('Embed code copied to clipboard!');
      }
    };
    
    // Close embed modal
    window.closeEmbedModal = function(event) {
      const modal = document.getElementById('embed-modal');
      if (event && event.target !== modal) {
        return;
      }
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    };
    
    // Load shared template on page load
    window.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const shareId = urlParams.get('share');
      
      if (shareId) {
        const [userId, templateType] = shareId.split('_');
        if (userId && templateType) {
          // Set UID temporarily to load shared template
          const originalUid = uid;
          uid = userId;
          
          setTimeout(async () => {
            try {
              currentTemplate = templateType;
              await loadActivity(true);
              
              // Show activity creator
              hideAllSections();
              const activityCreator = document.getElementById('activity-creator');
              if (activityCreator) {
                activityCreator.classList.remove('hidden');
              }
              
              // Switch to play mode
              currentMode = 'play';
              renderPlayMode();
              
              updateStatus('Shared activity loaded!');
            } catch (error) {
              console.error('Error loading shared activity:', error);
              updateStatus('Error loading shared activity');
              uid = originalUid;
            }
          }, 1000);
        }
      }
    });
    
    // ===== End Sharing Functions =====
    
    // ===== Color Customization Functions =====
    
    // Toggle color customization panel
    window.toggleColorCustomization = function() {
      const panel = document.getElementById('color-customization-panel');
      const toggleText = document.getElementById('color-toggle-text');
      
      if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        toggleText.textContent = 'Hide Colors';
        
        // Load saved colors for current template
        loadCustomColors();
      } else {
        panel.classList.add('hidden');
        toggleText.textContent = 'Customize Colors';
      }
    };
    
    // Toggle activity settings panel
    window.toggleActivitySettings = function() {
      const panel = document.getElementById('activity-settings-panel');
      const toggleText = document.getElementById('settings-toggle-text');
      
      if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        if (toggleText) toggleText.textContent = 'Hide Settings';
      } else {
        panel.classList.add('hidden');
        if (toggleText) toggleText.textContent = 'Show Settings';
      }
    };
    
    // Change template from dropdown
    window.changeTemplate = function(newTemplate) {
      if (confirm('Changing template will reset current data. Continue?')) {
        selectTemplate(newTemplate);
      } else {
        // Reset dropdown to current template
        const selector = document.getElementById('template-selector');
        if (selector) selector.value = currentTemplate;
      }
    };
    
    // Update custom color preview
    window.updateCustomColor = function(type, value) {
      if (value.match(/^#[0-9A-F]{6}$/i)) {
        const colorInput = document.getElementById(`custom-${type}-color`);
        const hexInput = document.getElementById(`custom-${type}-hex`);
        
        if (colorInput) colorInput.value = value;
        if (hexInput) hexInput.value = value;
      }
    };
    
    // Apply custom colors
    window.applyCustomColors = function() {
      const primaryColor = document.getElementById('custom-primary-color').value;
      const bgColor = document.getElementById('custom-bg-color').value;
      const accentColor = document.getElementById('custom-accent-color').value;
      
      // Apply to CSS variables
      document.documentElement.style.setProperty('--primary', primaryColor);
      document.documentElement.style.setProperty('--background', bgColor);
      document.documentElement.style.setProperty('--accent', accentColor);
      
      // Save to activity data
      if (activityData) {
        if (!activityData.customColors) {
          activityData.customColors = {};
        }
        activityData.customColors.primary = primaryColor;
        activityData.customColors.background = bgColor;
        activityData.customColors.accent = accentColor;
      }
      
      // Save to user preferences
      const colorPrefs = {
        primary: primaryColor,
        background: bgColor,
        accent: accentColor,
        template: currentTemplate
      };
      
      localStorage.setItem(`customColors_${uid}_${currentTemplate}`, JSON.stringify(colorPrefs));
      
      updateStatus('Custom colors applied!');
    };
    
    // Reset custom colors
    window.resetCustomColors = function() {
      // Reset to default theme colors
      const defaults = {
        primary: '#2563eb',
        background: '#0f1419',
        accent: '#14b8a6'
      };
      
      document.getElementById('custom-primary-color').value = defaults.primary;
      document.getElementById('custom-primary-hex').value = defaults.primary;
      document.getElementById('custom-bg-color').value = defaults.background;
      document.getElementById('custom-bg-hex').value = defaults.background;
      document.getElementById('custom-accent-color').value = defaults.accent;
      document.getElementById('custom-accent-hex').value = defaults.accent;
      
      // Apply defaults
      document.documentElement.style.setProperty('--primary', defaults.primary);
      document.documentElement.style.setProperty('--background', defaults.background);
      document.documentElement.style.setProperty('--accent', defaults.accent);
      
      // Remove from activity data
      if (activityData && activityData.customColors) {
        delete activityData.customColors;
      }
      
      // Remove from localStorage
      localStorage.removeItem(`customColors_${uid}_${currentTemplate}`);
      
      updateStatus('Colors reset to default');
    };
    
    // Load custom colors for current template
    function loadCustomColors() {
      let colors = null;
      
      // Try to load from activity data first
      if (activityData && activityData.customColors) {
        colors = activityData.customColors;
      } else {
        // Try to load from localStorage
        const saved = localStorage.getItem(`customColors_${uid}_${currentTemplate}`);
        if (saved) {
          try {
            colors = JSON.parse(saved);
          } catch (e) {
            console.error('Error parsing saved colors:', e);
          }
        }
      }
      
      if (colors) {
        document.getElementById('custom-primary-color').value = colors.primary || '#2563eb';
        document.getElementById('custom-primary-hex').value = colors.primary || '#2563eb';
        document.getElementById('custom-bg-color').value = colors.background || '#0f1419';
        document.getElementById('custom-bg-hex').value = colors.background || '#0f1419';
        document.getElementById('custom-accent-color').value = colors.accent || '#14b8a6';
        document.getElementById('custom-accent-hex').value = colors.accent || '#14b8a6';
      }
    }
    
    // Sync color picker with hex input
    document.addEventListener('DOMContentLoaded', function() {
      const colorInputs = [
        { picker: 'custom-primary-color', hex: 'custom-primary-hex', type: 'primary' },
        { picker: 'custom-bg-color', hex: 'custom-bg-hex', type: 'background' },
        { picker: 'custom-accent-color', hex: 'custom-accent-hex', type: 'accent' }
      ];
      
      colorInputs.forEach(({ picker, hex, type }) => {
        const pickerElem = document.getElementById(picker);
        const hexElem = document.getElementById(hex);
        
        if (pickerElem && hexElem) {
          pickerElem.addEventListener('input', function() {
            hexElem.value = this.value;
          });
        }
      });
    });
    
    // ===== End Color Customization Functions =====
    
    // ===== Template Conversion Functions =====
    
    let currentConvertTemplate = null;
    
    // Show conversion modal
    window.showConvertModal = function(templateType) {
      currentConvertTemplate = templateType;
      const modal = document.getElementById('convert-modal');
      const currentTypeLabel = document.getElementById('convert-current-type');
      
      const templateNames = {
        'mcq': 'Quiz',
        'truefalse': 'True or False',
        'flipcards': 'Flash Cards',
        'dragdrop': 'Match Up',
        'contentreveal': 'Content Reveal',
        'accordion': 'Accordion FAQ',
        'survey': 'Survey'
      };
      
      currentTypeLabel.textContent = templateNames[templateType] || templateType;
      
      // Reset target selection
      document.getElementById('convert-target-type').value = '';
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    };
    
    // Close conversion modal
    window.closeConvertModal = function(event) {
      const modal = document.getElementById('convert-modal');
      if (event && event.target !== modal) {
        return;
      }
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      currentConvertTemplate = null;
    };
    
    // Confirm template conversion
    window.confirmTemplateConversion = async function() {
      const targetType = document.getElementById('convert-target-type').value;
      
      if (!targetType) {
        alert('Please select a target template type');
        return;
      }
      
      if (targetType === currentConvertTemplate) {
        alert('Source and target templates are the same');
        return;
      }
      
      try {
        updateStatus('Converting template...');
        
        // Load source template data
        let sourceData;
        if (uid.startsWith('guest_')) {
          const storageKey = `template_${uid}_${currentConvertTemplate}`;
          sourceData = JSON.parse(localStorage.getItem(storageKey));
        } else {
          const ref = firebase.doc(db, 'users', uid, 'templates', currentConvertTemplate);
          const snap = await firebase.getDoc(ref);
          sourceData = snap.data();
        }
        
        if (!sourceData) {
          alert('Source template data not found');
          return;
        }
        
        // Convert the template
        const convertedData = convertTemplateData(sourceData, currentConvertTemplate, targetType);
        
        // Save converted template
        convertedData.template = targetType;
        convertedData.createdAt = new Date().toISOString();
        convertedData.lastModified = new Date().toISOString();
        
        if (uid.startsWith('guest_')) {
          const storageKey = `template_${uid}_${targetType}`;
          localStorage.setItem(storageKey, JSON.stringify(convertedData));
        } else {
          const ref = firebase.doc(db, 'users', uid, 'templates', targetType);
          await firebase.setDoc(ref, convertedData, { merge: false });
        }
        
        updateStatus('Template converted successfully!');
        closeConvertModal();
        
        // Refresh templates list if visible
        if (!document.getElementById('my-templates-dashboard').classList.contains('hidden')) {
          refreshMyTemplates();
        }
        
        // Ask if user wants to edit the converted template
        if (confirm('Template converted! Would you like to edit it now?')) {
          selectTemplate(targetType);
        }
      } catch (error) {
        console.error('Error converting template:', error);
        updateStatus('Error converting template: ' + error.message);
      }
    };
    
    // Convert template data from one type to another
    function convertTemplateData(sourceData, sourceType, targetType) {
      const converted = {
        title: sourceData.title || 'Converted Template',
        template: targetType
      };
      
      // Conversion logic based on source and target types
      
      // MCQ to True/False
      if (sourceType === 'mcq' && targetType === 'truefalse') {
        converted.items = sourceData.questions?.slice(0, 10).map(q => ({
          q: q.q,
          isTrue: true // Default to true, user should edit
        })) || [];
      }
      
      // MCQ to FlashCards
      else if (sourceType === 'mcq' && targetType === 'flipcards') {
        converted.cards = sourceData.questions?.map(q => ({
          front: q.q,
          back: q.options?.[q.correctIndex] || 'Answer'
        })) || [];
      }
      
      // MCQ to Accordion
      else if (sourceType === 'mcq' && targetType === 'accordion') {
        converted.items = sourceData.questions?.map(q => ({
          question: q.q,
          answer: q.options?.[q.correctIndex] || 'Answer'
        })) || [];
      }
      
      // True/False to MCQ
      else if (sourceType === 'truefalse' && targetType === 'mcq') {
        converted.questions = sourceData.items?.map(item => ({
          q: item.q,
          options: ['True', 'False'],
          correctIndex: item.isTrue ? 0 : 1
        })) || [];
      }
      
      // FlashCards to MCQ
      else if (sourceType === 'flipcards' && targetType === 'mcq') {
        converted.questions = sourceData.cards?.map(card => ({
          q: card.front,
          options: [card.back, 'Option 2', 'Option 3', 'Option 4'],
          correctIndex: 0
        })) || [];
      }
      
      // FlashCards to Accordion
      else if (sourceType === 'flipcards' && targetType === 'accordion') {
        converted.items = sourceData.cards?.map(card => ({
          question: card.front,
          answer: card.back
        })) || [];
      }
      
      // DragDrop to FlashCards
      else if (sourceType === 'dragdrop' && targetType === 'flipcards') {
        converted.cards = sourceData.pairs?.map(pair => ({
          front: pair.left,
          back: pair.right
        })) || [];
      }
      
      // Content Reveal to Accordion
      else if (sourceType === 'contentreveal' && targetType === 'accordion') {
        converted.items = sourceData.panels?.map(panel => ({
          question: panel.title,
          answer: panel.content
        })) || [];
      }
      
      // Default: try to preserve basic structure
      else {
        // Copy description if available
        if (sourceData.description) converted.description = sourceData.description;
        
        // For Survey target, create sample questions
        if (targetType === 'survey') {
          converted.questions = [
            { type: 'rating', question: 'Rate this converted content', scale: 5 },
            { type: 'text', question: 'Additional feedback' }
          ];
        }
        
        // For other types, create minimal valid structure from DUMMIES
        else if (DUMMIES[targetType]) {
          const dummy = JSON.parse(JSON.stringify(DUMMIES[targetType]));
          Object.assign(converted, dummy);
          converted.title = sourceData.title || 'Converted Template';
        }
      }
      
      return converted;
    }
    
    // ===== End Template Conversion Functions =====
    
    // Export to SCORM format
    window.exportToSCORM = async function(templateType) {
      try {
        updateStatus('Preparing SCORM package...');
        
        // Check if JSZip is available
        if (typeof JSZip === 'undefined') {
          alert('JSZip library not loaded. Please refresh the page.');
          return;
        }
        
        // Load template data
        let templateData;
        if (uid.startsWith('guest_')) {
          const storageKey = `template_${uid}_${templateType}`;
          templateData = JSON.parse(localStorage.getItem(storageKey));
        } else {
          const ref = firebase.doc(db, 'users', uid, 'templates', templateType);
          const snap = await firebase.getDoc(ref);
          templateData = snap.data();
        }
        
        if (!templateData) {
          updateStatus('No template data found');
          return;
        }
        
        // Create ZIP file
        const zip = new JSZip();
        
        // Create SCORM manifest (imsmanifest.xml)
        const manifest = `<?xml version="1.0" encoding="UTF-8"?>
<manifest identifier="${templateType}_${Date.now()}" version="1.0"
  xmlns="http://www.imsproject.org/xsd/imscp_rootv1p1p2"
  xmlns:adlcp="http://www.adlnet.org/xsd/adlcp_rootv1p2"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.imsproject.org/xsd/imscp_rootv1p1p2 imscp_rootv1p1p2.xsd
                      http://www.imsglobal.org/xsd/imsmd_rootv1p2p1 imsmd_rootv1p2p1.xsd
                      http://www.adlnet.org/xsd/adlcp_rootv1p2 adlcp_rootv1p2.xsd">
  <metadata>
    <schema>ADL SCORM</schema>
    <schemaversion>1.2</schemaversion>
  </metadata>
  <organizations default="${templateType}_org">
    <organization identifier="${templateType}_org">
      <title>${templateData.title || 'Educational Activity'}</title>
      <item identifier="item_1" identifierref="resource_1">
        <title>${templateData.title || 'Educational Activity'}</title>
      </item>
    </organization>
  </organizations>
  <resources>
    <resource identifier="resource_1" type="webcontent" adlcp:scormtype="sco" href="index.html">
      <file href="index.html"/>
    </resource>
  </resources>
</manifest>`;
        
        // Add manifest to ZIP
        zip.file('imsmanifest.xml', manifest);
        
        // Generate standalone HTML with embedded data
        const htmlContent = await generateStandaloneHTML(templateData);
        zip.file('index.html', htmlContent);
        
        // Add SCORM API wrapper
        const scormAPI = `
var API = {
  LMSInitialize: function() { return "true"; },
  LMSFinish: function() { return "true"; },
  LMSGetValue: function(key) { return ""; },
  LMSSetValue: function(key, value) { return "true"; },
  LMSCommit: function() { return "true"; },
  LMSGetLastError: function() { return "0"; },
  LMSGetErrorString: function(errorCode) { return "No error"; },
  LMSGetDiagnostic: function(errorCode) { return "No error"; }
};
`;
        zip.file('scorm_api.js', scormAPI);
        
        // Generate ZIP blob
        updateStatus('Creating ZIP package...');
        const blob = await zip.generateAsync({ type: 'blob' });
        
        // Download ZIP file
        if (typeof saveAs !== 'undefined') {
          saveAs(blob, `${templateData.title || templateType}_SCORM.zip`);
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${templateData.title || templateType}_SCORM.zip`;
          a.click();
          URL.revokeObjectURL(url);
        }
        
        updateStatus('SCORM package downloaded successfully!');
      } catch (error) {
        console.error('Error exporting SCORM:', error);
        updateStatus('Error creating SCORM package: ' + error.message);
      }
    };
    
    // Export to Storyline format (.story)
    window.exportToStoryline = async function(templateType) {
      try {
        updateStatus('Preparing Storyline package...');
        
        // Check if JSZip is available
        if (typeof JSZip === 'undefined') {
          alert('JSZip library not loaded. Please refresh the page.');
          return;
        }
        
        // Load template data
        let templateData;
        if (uid.startsWith('guest_')) {
          const storageKey = `template_${uid}_${templateType}`;
          templateData = JSON.parse(localStorage.getItem(storageKey));
        } else {
          const ref = firebase.doc(db, 'users', uid, 'templates', templateType);
          const snap = await firebase.getDoc(ref);
          templateData = snap.data();
        }
        
        if (!templateData) {
          updateStatus('No template data found');
          return;
        }
        
        // Create ZIP file (Storyline .story format)
        const zip = new JSZip();
        
        // Create story.xml (main content file for Storyline)
        const storyXML = `<?xml version="1.0" encoding="UTF-8"?>
<story version="3.0" title="${escapeXML(templateData.title || 'Educational Activity')}">
  <meta>
    <created>${templateData.createdAt || new Date().toISOString()}</created>
    <modified>${templateData.lastModified || new Date().toISOString()}</modified>
    <author>Tamer Educational Activities</author>
    <templateType>${templateType}</templateType>
  </meta>
  <slides>
    <slide id="slide1" name="Main Activity">
      <content type="${templateType}">
        ${generateStorylineContent(templateData, templateType)}
      </content>
    </slide>
  </slides>
</story>`;
        
        zip.file('story.xml', storyXML);
        
        // Add metadata
        const metadata = `<?xml version="1.0" encoding="UTF-8"?>
<metadata>
  <title>${escapeXML(templateData.title || 'Educational Activity')}</title>
  <description>Created with Tamer Educational Activities</description>
  <type>${templateType}</type>
  <version>1.0</version>
</metadata>`;
        zip.file('metadata.xml', metadata);
        
        // Add content data as JSON for import capability
        zip.file('content.json', JSON.stringify(templateData, null, 2));
        
        // Add standalone HTML version
        const htmlContent = await generateStandaloneHTML(templateData);
        zip.file('activity.html', htmlContent);
        
        // Add README
        const readme = `Articulate Storyline-Compatible Package
========================================

Title: ${templateData.title || 'Educational Activity'}
Type: ${templateType}
Created: ${templateData.createdAt || new Date().toISOString()}

This package contains:
- story.xml: Main Storyline content
- metadata.xml: Package metadata
- content.json: Raw activity data
- activity.html: Standalone HTML version

To use in Articulate Storyline:
1. Extract this ZIP file
2. Import story.xml into Storyline 360
3. Or use activity.html for web embedding

Created with Tamer Educational Activities
`;
        zip.file('README.txt', readme);
        
        // Generate ZIP blob
        updateStatus('Creating Storyline package...');
        const blob = await zip.generateAsync({ type: 'blob' });
        
        // Download as .story file
        if (typeof saveAs !== 'undefined') {
          saveAs(blob, `${templateData.title || templateType}_storyline.story`);
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${templateData.title || templateType}_storyline.story`;
          a.click();
          URL.revokeObjectURL(url);
        }
        
        updateStatus('Storyline package exported successfully!');
      } catch (error) {
        console.error('Error exporting Storyline:', error);
        updateStatus('Error creating Storyline package: ' + error.message);
      }
    };
    
    // Helper function to escape XML special characters
    function escapeXML(str) {
      if (!str) return '';
      return str.replace(/[<>&'"]/g, function(c) {
        switch(c) {
          case '<': return '&lt;';
          case '>': return '&gt;';
          case '&': return '&amp;';
          case "'": return '&apos;';
          case '"': return '&quot;';
          default: return c;
        }
      });
    }
    
    // Generate Storyline-compatible content XML
    function generateStorylineContent(data, type) {
      let content = '';
      
      switch(type) {
        case 'mcq':
          if (data.questions && Array.isArray(data.questions)) {
            content += '<questions>';
            data.questions.forEach((q, i) => {
              content += '\n        <question id="q' + (i + 1) + '">';
              content += '\n          <text>' + escapeXML(q.q) + '</text>';
              content += '\n          <options>';
              if (q.options) {
                q.options.forEach((opt, j) => {
                  content += '\n            <option id="' + j + '" correct="' + (j === q.correctIndex) + '">' + escapeXML(opt) + '</option>';
                });
              }
              content += '\n          </options>';
              content += '\n        </question>';
            });
            content += '\n      </questions>';
          }
          break;
          
        case 'truefalse':
          if (data.items && Array.isArray(data.items)) {
            content += '<statements>';
            data.items.forEach((item, i) => {
              content += '\n        <statement id="s' + (i + 1) + '" answer="' + item.isTrue + '">';
              content += '\n          <text>' + escapeXML(item.q) + '</text>';
              content += '\n        </statement>';
            });
            content += '\n      </statements>';
          }
          break;
          
        case 'flipcards':
          if (data.cards && Array.isArray(data.cards)) {
            content += '<cards>';
            data.cards.forEach((card, i) => {
              content += '\n        <card id="c' + (i + 1) + '">';
              content += '\n          <front>' + escapeXML(card.front) + '</front>';
              content += '\n          <back>' + escapeXML(card.back) + '</back>';
              content += '\n        </card>';
            });
            content += '\n      </cards>';
          }
          break;
          
        case 'dragdrop':
          if (data.pairs && Array.isArray(data.pairs)) {
            content += '<pairs>';
            data.pairs.forEach((pair, i) => {
              content += '\n        <pair id="p' + (i + 1) + '">';
              content += '\n          <left>' + escapeXML(pair.left) + '</left>';
              content += '\n          <right>' + escapeXML(pair.right) + '</right>';
              content += '\n        </pair>';
            });
            content += '\n      </pairs>';
          }
          break;
          
        case 'contentreveal':
          if (data.panels && Array.isArray(data.panels)) {
            content += '<panels>';
            data.panels.forEach((panel, i) => {
              content += '\n        <panel id="p' + (i + 1) + '">';
              content += '\n          <title>' + escapeXML(panel.title) + '</title>';
              content += '\n          <content>' + escapeXML(panel.content) + '</content>';
              content += '\n          <color>' + escapeXML(panel.color || '#F2B565') + '</color>';
              content += '\n        </panel>';
            });
            content += '\n      </panels>';
          }
          break;
          
        case 'mentaldrag':
          if (data.dragItems && Array.isArray(data.dragItems) && data.dropZones && Array.isArray(data.dropZones)) {
            content += '<dragdropActivity>';
            content += '\n        <dragItems>';
            data.dragItems.forEach((item, i) => {
              content += '\n          <item id="' + item.id + '">' + escapeXML(item.text) + '</item>';
            });
            content += '\n        </dragItems>';
            content += '\n        <dropZones>';
            data.dropZones.forEach((zone, i) => {
              content += '\n          <zone id="z' + (i + 1) + '" correctId="' + zone.correctId + '">';
              content += escapeXML(zone.label);
              content += '</zone>';
            });
            content += '\n        </dropZones>';
            content += '\n      </dragdropActivity>';
          }
          break;
          
        case 'pickmany':
          if (data.question && data.items && Array.isArray(data.items)) {
            content += '<pickManyQuestion>';
            content += '\n        <questionText>' + escapeXML(data.question) + '</questionText>';
            content += '\n        <items>';
            data.items.forEach((item, i) => {
              content += '\n          <item id="i' + (i + 1) + '" correct="' + item.isCorrect + '">';
              content += escapeXML(item.text);
              content += '</item>';
            });
            content += '\n        </items>';
            content += '\n      </pickManyQuestion>';
          }
          break;
          
        case 'infocard':
          content += '<infoCard>';
          content += '\n        <title>' + escapeXML(data.title || '') + '</title>';
          content += '\n        <subtitle>' + escapeXML(data.subtitle || '') + '</subtitle>';
          content += '\n        <description>' + escapeXML(data.description || '') + '</description>';
          if (data.colorBars && Array.isArray(data.colorBars)) {
            content += '\n        <colorBars>';
            data.colorBars.forEach((bar, i) => {
              content += '\n          <bar id="b' + (i + 1) + '">';
              content += '\n            <color>' + escapeXML(bar.color) + '</color>';
              content += '\n            <label>' + escapeXML(bar.label) + '</label>';
              content += '\n          </bar>';
            });
            content += '\n        </colorBars>';
          }
          content += '\n      </infocard>';
          break;
          
        case 'scormviewer':
          content += '<scormPackage>';
          content += '\n        <title>' + escapeXML(data.title || '') + '</title>';
          content += '\n        <scormUrl>' + escapeXML(data.scormUrl || '') + '</scormUrl>';
          content += '\n        <description>' + escapeXML(data.description || '') + '</description>';
          content += '\n        <width>' + escapeXML(data.width || '100%') + '</width>';
          content += '\n        <height>' + escapeXML(data.height || '600px') + '</height>';
          content += '\n      </scormPackage>';
          break;
          
        case 'interactivevideo':
          content += '<interactiveVideo>';
          content += '\n        <videoUrl>' + escapeXML(data.videoUrl || '') + '</videoUrl>';
          content += '\n        <videoType>' + escapeXML(data.videoType || 'youtube') + '</videoType>';
          content += '\n        <description>' + escapeXML(data.description || '') + '</description>';
          if (data.questions && Array.isArray(data.questions)) {
            content += '\n        <questions>';
            data.questions.forEach((q, i) => {
              content += '\n          <question id="vq' + (i + 1) + '" timestamp="' + q.timestamp + '">';
              content += '\n            <text>' + escapeXML(q.question) + '</text>';
              content += '\n            <options>';
              if (q.options) {
                q.options.forEach((opt, j) => {
                  content += '\n              <option id="' + j + '" correct="' + (j === q.correctIndex) + '">' + escapeXML(opt) + '</option>';
                });
              }
              content += '\n            </options>';
              content += '\n          </question>';
            });
            content += '\n        </questions>';
          }
          content += '\n      </interactiveVideo>';
          break;
          
        case 'gamearena':
          content += '<gameArena>';
          content += '\n        <title>' + escapeXML(data.title || '') + '</title>';
          content += '\n        <packagePath>' + escapeXML(data.packagePath || 'Game Arena') + '</packagePath>';
          content += '\n        <description>' + escapeXML(data.description || '') + '</description>';
          content += '\n        <instructions>' + escapeXML(data.instructions || '') + '</instructions>';
          content += '\n        <width>' + escapeXML(data.width || '100%') + '</width>';
          content += '\n        <height>' + escapeXML(data.height || '700px') + '</height>';
          content += '\n      </gameArena>';
          break;
          
        default:
          // For other types, include raw JSON data
          content = '<rawData><![CDATA[' + JSON.stringify(data, null, 2) + ']]></rawData>';
      }
      
      return content;
    }
    
    // Export source HTML file
    window.exportSourceFile = async function(templateType) {
      try {
        updateStatus('Preparing HTML source...');
        
        // Load template data
        let templateData;
        if (uid.startsWith('guest_')) {
          const storageKey = `template_${uid}_${templateType}`;
          templateData = JSON.parse(localStorage.getItem(storageKey));
        } else {
          const ref = firebase.doc(db, 'users', uid, 'templates', templateType);
          const snap = await firebase.getDoc(ref);
          templateData = snap.data();
        }
        
        if (!templateData) {
          updateStatus('No template data found');
          return;
        }
        
        // Generate standalone HTML
        const htmlContent = await generateStandaloneHTML(templateData);
        
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${templateData.title || templateType}_activity.html`;
        a.click();
        URL.revokeObjectURL(url);
        
        updateStatus('HTML source downloaded');
      } catch (error) {
        console.error('Error exporting HTML:', error);
        updateStatus('Error creating HTML file');
      }
    };
    
    // Generate standalone HTML with embedded template data
    async function generateStandaloneHTML(templateData) {
      // Get current page HTML as base
      const currentHTML = document.documentElement.outerHTML;
      
      // Create embedded data script
      const jsonData = JSON.stringify(templateData, null, 2).replace(/<\//g, '<\\/');
      const dataScript = '<' + 'script>\n' +
        '  window.EMBEDDED_TEMPLATE_DATA = ' + jsonData + ';\n' +
        '  document.addEventListener("DOMContentLoaded", function() {\n' +
        '    setTimeout(function() {\n' +
        '      if (window.EMBEDDED_TEMPLATE_DATA) {\n' +
        '        activityData = window.EMBEDDED_TEMPLATE_DATA;\n' +
        '        currentTemplate = activityData.template;\n' +
        '        updateActivityDisplay();\n' +
        '        renderPlayMode();\n' +
        '        var creator = document.getElementById("activity-creator");\n' +
        '        if (creator) creator.classList.remove("hidden");\n' +
        '      }\n' +
        '    }, 500);\n' +
        '  });\n' +
        '<' + '/script>';
      
      // Insert before closing body tag
      return currentHTML.replace('<' + '/body>', dataScript + '<' + '/body>');
    }
    
    // ===== End Dashboard Functions =====
    
    // Template selection with guaranteed working functionality
    window.selectTemplate = function(template) {
      alert('Selecting template: ' + template);
      console.log('Selecting template:', template);
      
      // Special handling for gamearena template
      if (template === 'gamearena') {
        console.log('Special handling for Game Arena template');
      }
      
      // Set current template
      currentTemplate = template;
      console.log('Current template set to:', currentTemplate);
      
      // Update template selector dropdown
      const templateSelector = document.getElementById('template-selector');
      if (templateSelector) {
        templateSelector.value = template;
      }
      
      // Update sidebar active state
      document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
      });
      const activeItem = document.querySelector(`.sidebar-item[data-template="${template}"]`);
      if (activeItem) {
        activeItem.classList.add('active');
      }
      
      // Hide all sections, show activity creator
      hideAllSections();
      const activityCreator = document.getElementById('activity-creator');
      if (activityCreator) {
        console.log('Showing activity creator');
        activityCreator.classList.remove('hidden');
        
        // Scroll to top of activity creator
        setTimeout(() => {
          activityCreator.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      }
      
      // Close mobile sidebar
      if (window.innerWidth < 1024) {
        toggleSidebar();
      }
      
      // Try to load saved template first, fallback to dummy data
      if (uid) {
        console.log('UID exists, loading activity');
        currentMode = 'play'; // Ensure we start in play mode
        loadActivity(true); // Auto-load saved or default template
      } else {
        console.log('No UID, loading dummy data');
        // If not authenticated yet, load dummy and wait for auth
        loadDummyData(template);
        updateActivityDisplay();
        setTimeout(() => {
          renderPlayMode();
        }, 50);
      }
    };
    
    // Toggle sidebar (mobile)
    window.toggleSidebar = function() {
      console.log('Toggling sidebar');
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      
      if (sidebar && overlay) {
        sidebar.classList.toggle('open');
        overlay.classList.toggle('open');
      }
    };
    
    // Show My Templates Dashboard
    window.showMyTemplatesDashboard = function() {
      console.log('Showing My Templates Dashboard');
      hideAllSections();
      const myTemplatesDashboard = document.getElementById('my-templates-dashboard');
      if (myTemplatesDashboard) {
        console.log('Showing my templates dashboard section');
        myTemplatesDashboard.classList.remove('hidden');
      }
      
      // Load templates
      refreshMyTemplates();
      
      // Close mobile sidebar
      if (window.innerWidth < 1024) {
        toggleSidebar();
      }
    };
    
    // Load dummy data
    window.loadDummyData = function(template) {
      console.log('Loading dummy data for template:', template);
      console.log('DUMMIES object:', DUMMIES);
      console.log('Game arena template in DUMMIES:', DUMMIES.gamearena);
      try {
        activityData = JSON.parse(JSON.stringify(DUMMIES[template]));
        console.log('Dummy data loaded:', activityData);
      } catch (error) {
        console.error('Error loading dummy data:', error);
        activityData = DUMMIES.mcq; // Fallback to MCQ
      }
    };
    
    // Update activity display
    window.updateActivityDisplay = function() {
      console.log('Updating activity display');
      console.log('Current activityData:', activityData);
      console.log('Current template:', currentTemplate);
      if (!activityData) {
        console.log('No activity data to display');
        return;
      }
      
      // Update main activity title input
      if (activityTitle) {
        activityTitle.value = activityData.title || '';
      }
      
      // Update dashboard activity title input
      const activityTitleDashboard = document.getElementById('activity-title-dashboard');
      if (activityTitleDashboard) {
        activityTitleDashboard.value = activityData.title || '';
      }
      
      if (activityDisplayTitle) {
        activityDisplayTitle.textContent = activityData.title || 'Untitled Activity';
      }
      
      // templateSelector is not used in current implementation
      // Templates are selected via sidebar, not a dropdown
    };
    
    // Toggle between play and edit modes
    window.toggleMode = function() {
      console.log('Toggling mode from:', currentMode);
      currentMode = currentMode === 'play' ? 'edit' : 'play';
      console.log('Toggled mode to:', currentMode);
      
      if (currentMode === 'play') {
        console.log('Switching to play mode');
        if (playMode) {
          console.log('Showing play mode');
          playMode.classList.remove('hidden');
        }
        if (editMode) {
          console.log('Hiding edit mode');
          editMode.classList.add('hidden');
        }
        if (modeToggleText) modeToggleText.textContent = 'Switch to Edit Mode';
        renderPlayMode();
      } else {
        console.log('Switching to edit mode');
        if (playMode) {
          console.log('Hiding play mode');
          playMode.classList.add('hidden');
        }
        if (editMode) {
          console.log('Showing edit mode');
          editMode.classList.remove('hidden');
        }
        if (modeToggleText) modeToggleText.textContent = 'Switch to Play Mode';
        renderEditMode();
      }
    };
    
    // Reset activity
    window.resetActivity = function() {
      console.log('Resetting activity');
      if (confirm('Are you sure you want to reset this activity? All changes will be lost.')) {
        loadDummyData(currentTemplate);
        updateActivityDisplay();
        if (currentMode === 'play') {
          renderPlayMode();
        } else {
          renderEditMode();
        }
      }
    };
    
    // Render play mode based on template
    window.renderPlayMode = function() {
      console.log('Rendering play mode for template:', currentTemplate);
      console.log('Current activityData in renderPlayMode:', activityData);
      
      if (!playArea || !playControls) {
        console.log('Play area elements not found');
        return;
      }
      
      playArea.innerHTML = '';
      playControls.innerHTML = '';
      
      if (!activityData) {
        playArea.innerHTML = '<div class="text-center py-12 text-muted">No activity data available.</div>';
        return;
      }
      
      switch(currentTemplate) {
        case 'mcq':
          renderMCQPlayMode();
          break;
        case 'truefalse':
          renderTrueFalsePlayMode();
          break;
        case 'flipcards':
          renderFlipCardsPlayMode();
          break;
        case 'dragdrop':
          renderDragDropPlayMode();
          break;
        case 'contentreveal':
          renderContentRevealPlayMode();
          break;
        case 'mentaldrag':
          renderMentalDragPlayMode();
          break;
        case 'pickmany':
          renderPickManyPlayMode();
          break;
        case 'infocard':
          renderInfoCardPlayMode();
          break;
        case 'scormviewer':
          renderSCORMViewerPlayMode();
          break;
        case 'interactivevideo':
          renderInteractiveVideoPlayMode();
          break;
        case 'gamearena':
          console.log('Rendering Game Arena play mode');
          renderGameArenaPlayMode();
          break;
        case 'crossword':
          renderCrosswordPlayMode();
          break;
        case 'timeline':
          renderTimelinePlayMode();
          break;
        case 'matchingpairs':
          renderMatchingPairsPlayMode();
          break;
        case 'sorting':
          renderSortingPlayMode();
          break;
        case 'labeldiagram':
          renderLabelDiagramPlayMode();
          break;
        case 'wordsearch':
          renderWordSearchPlayMode();
          break;
        case 'survey':
          renderSurveyPlayMode();
          break;
        case 'accordion':
          renderAccordionPlayMode();
          break;
        case 'imagehotspot':
          renderImageHotspotPlayMode();
          break;
        default:
          playArea.innerHTML = '<div class="text-center py-12 text-muted">Unsupported template type.</div>';
      }
      
      // Add general play controls
      if (playControls) {
        playControls.innerHTML = `
          <button class="btn btn-primary" onclick="toggleMode()">
            <i class="fas fa-edit mr-2"></i>
            Edit Mode
          </button>
          <button class="btn btn-ghost sound-toggle-btn" onclick="toggleSound()" title="${audioEnabled ? 'Mute Sound' : 'Unmute Sound'}">
            <i class="fas ${audioEnabled ? 'fa-volume-up' : 'fa-volume-mute'}"></i>
          </button>
          <button class="btn btn-ghost" onclick="showHomePage()">
            <i class="fas fa-home mr-2"></i>
            Home
          </button>
        `;
      }
    };
    
    // Render edit mode based on template
    window.renderEditMode = function() {
      console.log('Rendering edit mode for template:', currentTemplate);
      console.log('Current activityData in renderEditMode:', activityData);
      
      if (!editor) {
        console.log('Editor element not found');
        return;
      }
      
      editor.innerHTML = '';
      
      if (!activityData) {
        editor.innerHTML = '<div class="text-center py-12 text-muted">No activity data available.</div>';
        return;
      }
      
      // Add title input
      const titleGroup = document.createElement('div');
      titleGroup.className = 'mb-6';
      titleGroup.innerHTML = `
        <label class="block text-sm text-muted mb-2">Activity Title</label>
        <input type="text" value="${activityData.title || ''}" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" 
               oninput="updateActivityTitle(this.value)">
      `;
      editor.appendChild(titleGroup);
      
      switch(currentTemplate) {
        case 'mcq':
          renderMCQEditMode();
          break;
        case 'truefalse':
          renderTrueFalseEditMode();
          break;
        case 'flipcards':
          renderFlipCardsEditMode();
          break;
        case 'dragdrop':
          renderDragDropEditMode();
          break;
        case 'contentreveal':
          renderContentRevealEditMode();
          break;
        case 'mentaldrag':
          renderMentalDragEditMode();
          break;
        case 'pickmany':
          renderPickManyEditMode();
          break;
        case 'infocard':
          renderInfoCardEditMode();
          break;
        case 'scormviewer':
          renderSCORMViewerEditMode();
          break;
        case 'interactivevideo':
          renderInteractiveVideoEditMode();
          break;
        case 'gamearena':
          console.log('Rendering Game Arena edit mode');
          renderGameArenaEditMode();
          break;
        case 'crossword':
          renderCrosswordEditMode();
          break;
        case 'timeline':
          renderTimelineEditMode();
          break;
        case 'matchingpairs':
          renderMatchingPairsEditMode();
          break;
        case 'sorting':
          renderSortingEditMode();
          break;
        case 'labeldiagram':
          renderLabelDiagramEditMode();
          break;
        case 'wordsearch':
          renderWordSearchEditMode();
          break;
        case 'survey':
          renderSurveyEditMode();
          break;
        case 'accordion':
          renderAccordionEditMode();
          break;
        case 'imagehotspot':
          renderImageHotspotEditMode();
          break;
        default:
          editor.innerHTML = '<div class="text-center py-12 text-muted">Unsupported template type.</div>';
      }
      
      // Add general edit controls
      const generalControls = document.createElement('div');
      generalControls.className = 'mt-6 p-4 rounded-lg';
      generalControls.style = 'background-color: var(--button-bg); border: 1px solid var(--button-border);';
      generalControls.innerHTML = `
        <div class="flex flex-wrap gap-3">
          <button class="btn btn-primary" onclick="updateActivityDisplay()">
            <i class="fas fa-save mr-2"></i>
            Save Changes
          </button>
          <button class="btn btn-secondary" onclick="showHomePage()">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Home
          </button>
          <button class="btn btn-accent" onclick="openThemeCustomizer()">
            <i class="fas fa-palette mr-2"></i>
            Customize Theme
          </button>
          <button class="btn btn-ghost" onclick="duplicateCurrentActivity()">
            <i class="fas fa-copy mr-2"></i>
            Duplicate
          </button>
          <button class="btn btn-danger" onclick="deleteCurrentActivity()">
            <i class="fas fa-trash mr-2"></i>
            Delete
          </button>
        </div>
      `;
      editor.appendChild(generalControls);
    };
    
    // Update activity title
    window.updateActivityTitle = function(title) {
      console.log('updateActivityTitle called with title:', title);
      if (activityData) {
        activityData.title = title;
        if (activityDisplayTitle) {
          activityDisplayTitle.textContent = title;
        }
      }
    };
    
    // MCQ Play Mode
    window.renderMCQPlayMode = function() {
      if (!activityData.questions || activityData.questions.length === 0) {
        playArea.innerHTML = '<div class="text-center py-12 text-muted">No questions available.</div>';
        return;
      }
      
      let currentQuestion = 0;
      let score = 0;
      
      function renderQuestion() {
        if (currentQuestion >= activityData.questions.length) {
          // Record the score
          recordScore(score, activityData.questions.length);
          
          playArea.innerHTML = `
            <div class="text-center py-12">
              <div class="text-2xl font-bold mb-4"> Activity Complete!</div>
              <div class="text-xl mb-6">Your score: <span class="text-accent font-bold">${score}/${activityData.questions.length}</span></div>
              <div class="text-lg mb-6">${Math.round((score/activityData.questions.length)*100)}% Correct</div>
              <button class="btn btn-primary" onclick="resetActivity()">Play Again</button>
            </div>
          `;
          return;
        }
        
        const question = activityData.questions[currentQuestion];
        playArea.innerHTML = `
          <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
              <div class="text-lg font-bold">Question ${currentQuestion + 1}/${activityData.questions.length}</div>
              <div class="pill">Score: <span class="text-accent font-bold">${score}</span>/${currentQuestion}</div>
            </div>
            <div class="text-xl mb-6">${question.q}</div>
            <div class="space-y-3">
              ${question.options.map((option, index) => `
                <div class="flex items-center p-3 rounded-lg border hover:cursor-pointer transition-colors mcq-option" style="border: 1px solid var(--button-border); background-color: var(--button-bg);" 
                     onclick="checkMCQAnswer(${currentQuestion}, ${index})">
                  <div class="w-6 h-6 rounded-full border mr-3 flex items-center justify-center" style="border: 1px solid var(--button-border);">
                    <span class="text-sm">${String.fromCharCode(65 + index)}</span>
                  </div>
                  <div>${option}</div>
                </div>
              `).join('')}
            </div>
            <div id="answer-feedback" class="mt-4 p-3 rounded-lg hidden"></div>
          </div>
        `;
      }
      
      // Make checkMCQAnswer globally available
      window.checkMCQAnswer = function(questionIndex, selectedIndex) {
        const correctIndex = activityData.questions[questionIndex].correctIndex;
        const feedbackDiv = document.getElementById('answer-feedback');
        const options = document.querySelectorAll('.mcq-option');
        
        // Disable all options
        options.forEach(opt => opt.style.pointerEvents = 'none');
        
        // Show feedback
        if (selectedIndex === correctIndex) {
          score++;
          playSound('correct'); // Play success sound
          options[selectedIndex].style.backgroundColor = 'var(--success)';
          options[selectedIndex].style.borderColor = 'var(--success)';
          options[selectedIndex].style.color = '#fff';
          if (feedbackDiv) {
            feedbackDiv.className = 'mt-4 p-3 rounded-lg';
            feedbackDiv.style.backgroundColor = 'var(--success-bg)';
            feedbackDiv.style.borderColor = 'var(--success)';
            feedbackDiv.style.color = 'var(--success)';
            feedbackDiv.innerHTML = ' <strong>Correct!</strong> Great job!';
            feedbackDiv.classList.remove('hidden');
          }
        } else {
          playSound('incorrect'); // Play error sound
          options[selectedIndex].style.backgroundColor = 'var(--error)';
          options[selectedIndex].style.borderColor = 'var(--error)';
          options[selectedIndex].style.color = '#fff';
          options[correctIndex].style.backgroundColor = 'var(--success)';
          options[correctIndex].style.borderColor = 'var(--success)';
          options[correctIndex].style.color = '#fff';
          if (feedbackDiv) {
            feedbackDiv.className = 'mt-4 p-3 rounded-lg';
            feedbackDiv.style.backgroundColor = 'var(--error-bg)';
            feedbackDiv.style.borderColor = 'var(--error)';
            feedbackDiv.style.color = 'var(--error)';
            feedbackDiv.innerHTML = ` <strong>Incorrect!</strong> The correct answer is ${String.fromCharCode(65 + correctIndex)}.`;
            feedbackDiv.classList.remove('hidden');
          }
        }
        
        // Move to next question after delay
        setTimeout(() => {
          currentQuestion++;
          if (currentQuestion >= activityData.questions.length) {
            playSound('complete'); // Play completion sound
          }
          renderQuestion();
        }, 1500);
      };
      
      renderQuestion();
    };
    
    // MCQ Edit Mode
    window.renderMCQEditMode = function() {
      if (!activityData.questions) activityData.questions = [];
      
      activityData.questions.forEach((question, index) => {
        const questionCard = document.createElement('div');
        questionCard.className = 'card';
        questionCard.innerHTML = `
          <div class="flex justify-between items-start mb-4">
            <h4 class="text-lg font-bold">Question ${index + 1}</h4>
            <button class="text-err hover:text-white" onclick="removeMCQQuestion(${index})" style="color: var(--err);">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="mb-4">
            <label class="block text-sm text-muted mb-2">Question</label>
            <input type="text" value="${question.q}" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                   oninput="updateMCQQuestion(${index}, 'q', this.value)">
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            ${question.options.map((option, optIndex) => `
              <div>
                <label class="block text-sm text-muted mb-2">Option ${String.fromCharCode(65 + optIndex)}</label>
                <input type="text" value="${option}" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                       oninput="updateMCQOption(${index}, ${optIndex}, this.value)">
              </div>
            `).join('')}
          </div>
          <div>
            <label class="block text-sm text-muted mb-2">Correct Answer</label>
            <select class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                    onchange="updateMCQCorrectIndex(${index}, parseInt(this.value))">
              ${question.options.map((option, optIndex) => `
                <option value="${optIndex}" ${optIndex === question.correctIndex ? 'selected' : ''}>
                  ${String.fromCharCode(65 + optIndex)}: ${option}
                </option>
              `).join('')}
            </select>
          </div>
        `;
        editor.appendChild(questionCard);
      });
      
      // Update add item button functionality
      if (addItemBtn) {
        addItemBtn.onclick = function() {
          if (!activityData.questions) activityData.questions = [];
          activityData.questions.push({
            q: "New Question",
            options: ["Option A", "Option B", "Option C", "Option D"],
            correctIndex: 0
          });
          renderEditMode();
        };
      }
    };
    
    // Update MCQ question
    window.updateMCQQuestion = function(index, field, value) {
      if (activityData.questions && activityData.questions[index]) {
        activityData.questions[index][field] = value;
      }
    };
    
    // Update MCQ option
    window.updateMCQOption = function(questionIndex, optionIndex, value) {
      if (activityData.questions && 
          activityData.questions[questionIndex] && 
          activityData.questions[questionIndex].options) {
        activityData.questions[questionIndex].options[optionIndex] = value;
      }
    };
    
    // Update MCQ correct index
    window.updateMCQCorrectIndex = function(questionIndex, value) {
      if (activityData.questions && activityData.questions[questionIndex]) {
        activityData.questions[questionIndex].correctIndex = value;
      }
    };
    
    // Remove MCQ question
    window.removeMCQQuestion = function(index) {
      if (confirm('Are you sure you want to remove this question?')) {
        if (activityData.questions) {
          activityData.questions.splice(index, 1);
          renderEditMode();
        }
      }
    };
    
    // True/False Play Mode
    window.renderTrueFalsePlayMode = function() {
      if (!activityData.items || activityData.items.length === 0) {
        playArea.innerHTML = '<div class="text-center py-12 text-muted">No items available.</div>';
        return;
      }
      
      let currentItem = 0;
      let score = 0;
      
      function renderStatement() {
        if (currentItem >= activityData.items.length) {
          // Record the score
          recordScore(score, activityData.items.length);
          
          playArea.innerHTML = `
            <div class="text-center py-12">
              <div class="text-2xl font-bold mb-4"> Activity Complete!</div>
              <div class="text-xl mb-6">Your score: <span class="text-accent font-bold">${score}/${activityData.items.length}</span></div>
              <div class="text-lg mb-6">${Math.round((score/activityData.items.length)*100)}% Correct</div>
              <button class="btn btn-primary" onclick="resetActivity()">Play Again</button>
            </div>
          `;
          return;
        }
        
        const item = activityData.items[currentItem];
        playArea.innerHTML = `
          <div class="text-center py-8">
            <div class="flex justify-between items-center mb-4 max-w-2xl mx-auto">
              <div class="text-lg font-bold">Statement ${currentItem + 1}/${activityData.items.length}</div>
              <div class="pill">Score: <span class="text-accent font-bold">${score}</span>/${currentItem}</div>
            </div>
            <div class="text-xl mb-8 max-w-2xl mx-auto">${item.q}</div>
            <div class="flex justify-center gap-6">
              <button id="true-btn" class="btn btn-secondary px-8 py-4 text-lg" onclick="checkTrueFalseAnswer(${currentItem}, true)">
                <i class="fas fa-check mr-2"></i> True
              </button>
              <button id="false-btn" class="btn btn-ghost px-8 py-4 text-lg" onclick="checkTrueFalseAnswer(${currentItem}, false)" style="background-color: var(--button-bg); border: 1px solid var(--button-border);">
                <i class="fas fa-times mr-2"></i> False
              </button>
            </div>
            <div id="tf-answer-feedback" class="mt-6 p-4 rounded-lg hidden max-w-2xl mx-auto"></div>
          </div>
        `;
      }
      
      // Make checkTrueFalseAnswer globally available
      window.checkTrueFalseAnswer = function(itemIndex, selectedValue) {
        const correctValue = activityData.items[itemIndex].isTrue;
        const feedbackDiv = document.getElementById('tf-answer-feedback');
        const trueBtn = document.getElementById('true-btn');
        const falseBtn = document.getElementById('false-btn');
        
        // Disable buttons
        if (trueBtn) trueBtn.disabled = true;
        if (falseBtn) falseBtn.disabled = true;
        
        // Show feedback
        if (selectedValue === correctValue) {
          score++;
          const selectedBtn = selectedValue ? trueBtn : falseBtn;
          if (selectedBtn) {
            selectedBtn.style.backgroundColor = 'var(--success)';
            selectedBtn.style.borderColor = 'var(--success)';
            selectedBtn.style.color = '#fff';
          }
          if (feedbackDiv) {
            feedbackDiv.style.backgroundColor = 'var(--success-bg)';
            feedbackDiv.style.borderColor = 'var(--success)';
            feedbackDiv.style.color = 'var(--success)';
            feedbackDiv.innerHTML = ' <strong>Correct!</strong> Well done!';
            feedbackDiv.classList.remove('hidden');
          }
        } else {
          const selectedBtn = selectedValue ? trueBtn : falseBtn;
          const correctBtn = correctValue ? trueBtn : falseBtn;
          if (selectedBtn) {
            selectedBtn.style.backgroundColor = 'var(--error)';
            selectedBtn.style.borderColor = 'var(--error)';
            selectedBtn.style.color = '#fff';
          }
          if (correctBtn) {
            correctBtn.style.backgroundColor = 'var(--success)';
            correctBtn.style.borderColor = 'var(--success)';
            correctBtn.style.color = '#fff';
          }
          if (feedbackDiv) {
            feedbackDiv.style.backgroundColor = 'var(--error-bg)';
            feedbackDiv.style.borderColor = 'var(--error)';
            feedbackDiv.style.color = 'var(--error)';
            feedbackDiv.innerHTML = ` <strong>Incorrect!</strong> The correct answer is ${correctValue ? 'True' : 'False'}.`;
            feedbackDiv.classList.remove('hidden');
          }
        }
        
        // Move to next statement after delay
        setTimeout(() => {
          currentItem++;
          renderStatement();
        }, 1500);
      };
      
      renderStatement();
    };
    
    // True/False Edit Mode
    window.renderTrueFalseEditMode = function() {
      if (!activityData.items) activityData.items = [];
      
      activityData.items.forEach((item, index) => {
        const itemCard = document.createElement('div');
        itemCard.className = 'card';
        itemCard.innerHTML = `
          <div class="flex justify-between items-start mb-4">
            <h4 class="text-lg font-bold">Statement ${index + 1}</h4>
            <button class="text-err hover:text-white" onclick="removeTrueFalseItem(${index})" style="color: var(--err);">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="mb-4">
            <label class="block text-sm text-muted mb-2">Statement</label>
            <input type="text" value="${item.q}" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                   oninput="updateTrueFalseStatement(${index}, this.value)">
          </div>
          <div>
            <label class="block text-sm text-muted mb-2">Correct Answer</label>
            <select class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                    onchange="updateTrueFalseAnswer(${index}, this.value === 'true')">
              <option value="true" ${item.isTrue ? 'selected' : ''}>True</option>
              <option value="false" ${!item.isTrue ? 'selected' : ''}>False</option>
            </select>
          </div>
        `;
        editor.appendChild(itemCard);
      });
      
      // Update add item button functionality
      if (addItemBtn) {
        addItemBtn.onclick = function() {
          if (!activityData.items) activityData.items = [];
          activityData.items.push({
            q: "New Statement",
            isTrue: true
          });
          renderEditMode();
        };
      }
    };
    
    // Update True/False statement
    window.updateTrueFalseStatement = function(index, value) {
      if (activityData.items && activityData.items[index]) {
        activityData.items[index].q = value;
      }
    };
    
    // Update True/False answer
    window.updateTrueFalseAnswer = function(index, value) {
      if (activityData.items && activityData.items[index]) {
        activityData.items[index].isTrue = value;
      }
    };
    
    // Remove True/False item
    window.removeTrueFalseItem = function(index) {
      if (confirm('Are you sure you want to remove this statement?')) {
        if (activityData.items) {
          activityData.items.splice(index, 1);
          renderEditMode();
        }
      }
    };
    
    // Flip Cards Play Mode
    window.renderFlipCardsPlayMode = function() {
      if (!activityData.cards || activityData.cards.length === 0) {
        playArea.innerHTML = '<div class="text-center py-12 text-muted">No cards available.</div>';
        return;
      }
      
      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6';
      
      activityData.cards.forEach((card, index) => {
        const cardElement = document.createElement('div');
        cardElement.className = 'flip-card';
        cardElement.innerHTML = `
          <div class="text-center">
            <div class="text-lg font-bold mb-2">${card.front}</div>
            <div class="text-sm text-muted">Click to flip</div>
          </div>
        `;
        
        let isFlipped = false;
        cardElement.onclick = function() {
          isFlipped = !isFlipped;
          if (isFlipped) {
            this.innerHTML = `
              <div class="text-center">
                <div class="text-lg mb-2">${card.back}</div>
                <div class="text-sm text-muted">Click to flip back</div>
              </div>
            `;
          } else {
            this.innerHTML = `
              <div class="text-center">
                <div class="text-lg font-bold mb-2">${card.front}</div>
                <div class="text-sm text-muted">Click to flip</div>
              </div>
            `;
          }
        };
        
        grid.appendChild(cardElement);
      });
      
      playArea.appendChild(grid);
    };
    
    // Flip Cards Edit Mode
    window.renderFlipCardsEditMode = function() {
      if (!activityData.cards) activityData.cards = [];
      
      activityData.cards.forEach((card, index) => {
        const cardCard = document.createElement('div');
        cardCard.className = 'card';
        cardCard.innerHTML = `
          <div class="flex justify-between items-start mb-4">
            <h4 class="text-lg font-bold">Card ${index + 1}</h4>
            <button class="text-err hover:text-white" onclick="removeFlipCard(${index})" style="color: var(--err);">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-muted mb-2">Front</label>
              <input type="text" value="${card.front}" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                     oninput="updateFlipCard(${index}, 'front', this.value)">
            </div>
            <div>
              <label class="block text-sm text-muted mb-2">Back</label>
              <input type="text" value="${card.back}" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                     oninput="updateFlipCard(${index}, 'back', this.value)">
            </div>
          </div>
        `;
        editor.appendChild(cardCard);
      });
      
      // Update add item button functionality
      if (addItemBtn) {
        addItemBtn.onclick = function() {
          if (!activityData.cards) activityData.cards = [];
          activityData.cards.push({
            front: "Term",
            back: "Definition"
          });
          renderEditMode();
        };
      }
    };
    
    // Update Flip Card
    window.updateFlipCard = function(index, field, value) {
      if (activityData.cards && activityData.cards[index]) {
        activityData.cards[index][field] = value;
      }
    };
    
    // Remove Flip Card
    window.removeFlipCard = function(index) {
      if (confirm('Are you sure you want to remove this card?')) {
        if (activityData.cards) {
          activityData.cards.splice(index, 1);
          renderEditMode();
        }
      }
    };
    
    // Drag & Drop Play Mode
    window.renderDragDropPlayMode = function() {
      if (!activityData.pairs || activityData.pairs.length === 0) {
        playArea.innerHTML = '<div class="text-center py-12 text-muted">No pairs available.</div>';
        return;
      }
      
      const leftContainer = document.createElement('div');
      leftContainer.className = 'md:w-1/2 pr-4';
      
      const rightContainer = document.createElement('div');
      rightContainer.className = 'md:w-1/2 pl-4';
      
      const row = document.createElement('div');
      row.className = 'flex flex-col md:flex-row gap-6';
      
      // Create left side (drop zones)
      activityData.pairs.forEach((pair, index) => {
        const pairContainer = document.createElement('div');
        pairContainer.className = 'mb-6';
        pairContainer.innerHTML = `
          <div class="mb-2 font-medium">${pair.left}</div>
          <div class="drop-zone" data-expected="${pair.right}" data-index="${index}">
            <div class="text-muted text-center py-4">Drop matching item here</div>
          </div>
        `;
        leftContainer.appendChild(pairContainer);
      });
      
      // Create right side (draggable items)
      const shuffledPairs = [...activityData.pairs].sort(() => Math.random() - 0.5);
      const draggableContainer = document.createElement('div');
      draggableContainer.className = 'space-y-3';
      
      shuffledPairs.forEach((pair, index) => {
        const draggableItem = document.createElement('div');
        draggableItem.className = 'drag-item';
        draggableItem.draggable = true;
        draggableItem.dataset.value = pair.right;
        draggableItem.innerHTML = `
          <div class="flex items-center">
            <i class="fas fa-grip-lines mr-2 text-muted"></i>
            <span>${pair.right}</span>
          </div>
        `;
        
        // Add drag events
        draggableItem.addEventListener('dragstart', function(e) {
          e.dataTransfer.setData('text/plain', this.dataset.value);
          this.classList.add('opacity-50');
        });
        
        draggableItem.addEventListener('dragend', function() {
          this.classList.remove('opacity-50');
        });
        
        draggableContainer.appendChild(draggableItem);
      });
      
      rightContainer.appendChild(draggableContainer);
      
      row.appendChild(leftContainer);
      row.appendChild(rightContainer);
      playArea.appendChild(row);
      
      // Add drop zone events
      const dropZones = playArea.querySelectorAll('.drop-zone');
      dropZones.forEach(zone => {
        zone.addEventListener('dragover', function(e) {
          e.preventDefault();
          this.classList.add('border-primary');
        });
        
        zone.addEventListener('dragleave', function() {
          this.classList.remove('border-primary');
        });
        
        zone.addEventListener('drop', function(e) {
          e.preventDefault();
          this.classList.remove('border-primary');
          
          const droppedValue = e.dataTransfer.getData('text/plain');
          const expectedValue = this.dataset.expected;
          
          if (droppedValue === expectedValue) {
            this.innerHTML = `
              <div class="flex items-center justify-between">
                <span>${droppedValue}</span>
                <i class="fas fa-check-circle text-accent"></i>
              </div>
            `;
            this.classList.remove('border-dashed');
            this.classList.add('border-solid', 'border-accent');
          } else {
            this.innerHTML = `
              <div class="flex items-center justify-between">
                <span>${droppedValue}</span>
                <i class="fas fa-times-circle text-err"></i>
              </div>
            `;
            this.classList.remove('border-dashed');
            this.classList.add('border-solid', 'border-err');
            
            // Reset after a short delay
            setTimeout(() => {
              this.innerHTML = '<div class="text-muted text-center py-4">Drop matching item here</div>';
              this.classList.remove('border-solid', 'border-err');
              this.classList.add('border-dashed');
            }, 1500);
          }
        });
      });
      
      // Add check button
      const checkButton = document.createElement('button');
      checkButton.className = 'btn btn-primary mt-6';
      checkButton.innerHTML = '<i class="fas fa-check mr-2"></i> Check Answers';
      checkButton.onclick = checkDragDropAnswers;
      
      playControls.appendChild(checkButton);
    };
    
    window.checkDragDropAnswers = function() {
      let correct = 0;
      const dropZones = playArea.querySelectorAll('.drop-zone');
      
      dropZones.forEach(zone => {
        const content = zone.textContent.trim();
        const expected = zone.dataset.expected;
        
        // Check if the zone has the correct item
        if (content === expected) {
          correct++;
        }
      });
      
      const total = activityData.pairs.length;
      const percentage = Math.round((correct / total) * 100);
      
      // Create inline result display
      const resultDiv = document.createElement('div');
      resultDiv.className = 'mt-6 p-6 rounded-lg text-center';
      resultDiv.style.backgroundColor = correct === total ? 'var(--success-bg)' : 'var(--warn-bg)';
      resultDiv.style.borderColor = correct === total ? 'var(--success)' : 'var(--warn)';
      resultDiv.style.color = correct === total ? 'var(--success)' : 'var(--warn)';
      resultDiv.style.border = '2px solid';
      
      const icon = correct === total ? '' : '';
      const message = correct === total ? 'Perfect Score!' : 'Good Effort!';
      
      resultDiv.innerHTML = `
        <div class="text-3xl mb-3">${icon}</div>
        <div class="text-2xl font-bold mb-2">${message}</div>
        <div class="text-xl mb-2">You matched <span class="font-bold">${correct}</span> out of <span class="font-bold">${total}</span> correctly!</div>
        <div class="text-lg">${percentage}% Correct</div>
        <button class="btn btn-primary mt-4" onclick="resetActivity()">Try Again</button>
      `;
      
      // Remove check button and add result
      playControls.innerHTML = '';
      playControls.appendChild(resultDiv);
    };
    
    // Drag & Drop Edit Mode
    window.renderDragDropEditMode = function() {
      if (!activityData.pairs) activityData.pairs = [];
      
      activityData.pairs.forEach((pair, index) => {
        const pairCard = document.createElement('div');
        pairCard.className = 'card';
        pairCard.innerHTML = `
          <div class="flex justify-between items-start mb-4">
            <h4 class="text-lg font-bold">Pair ${index + 1}</h4>
            <button class="text-err hover:text-white" onclick="removeDragDropPair(${index})" style="color: var(--err);">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-muted mb-2">Left Side</label>
              <input type="text" value="${pair.left}" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                     oninput="updateDragDropPair(${index}, 'left', this.value)">
            </div>
            <div>
              <label class="block text-sm text-muted mb-2">Right Side</label>
              <input type="text" value="${pair.right}" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                     oninput="updateDragDropPair(${index}, 'right', this.value)">
            </div>
          </div>
        `;
        editor.appendChild(pairCard);
      });
      
      // Update add item button functionality
      if (addItemBtn) {
        addItemBtn.onclick = function() {
          if (!activityData.pairs) activityData.pairs = [];
          activityData.pairs.push({
            left: "Item",
            right: "Match"
          });
          renderEditMode();
        };
      }
    };
    
    // Update Drag & Drop Pair
    window.updateDragDropPair = function(index, field, value) {
      if (activityData.pairs && activityData.pairs[index]) {
        activityData.pairs[index][field] = value;
      }
    };
    
    // Remove Drag & Drop Pair
    window.removeDragDropPair = function(index) {
      if (confirm('Are you sure you want to remove this pair?')) {
        if (activityData.pairs) {
          activityData.pairs.splice(index, 1);
          renderEditMode();
        }
      }
    };
    
    // ===== NEW TEMPLATES =====
    
    // Content Reveal Play Mode
    window.renderContentRevealPlayMode = function() {
      if (!activityData.panels || activityData.panels.length === 0) {
        playArea.innerHTML = '<div class="text-center py-12 text-muted">No panels available.</div>';
        return;
      }
      
      const container = document.createElement('div');
      container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
      container.style.backgroundColor = 'var(--accent)';
      container.style.padding = '2rem';
      container.style.borderRadius = '1rem';
      
      activityData.panels.forEach((panel, index) => {
        const panelElement = document.createElement('div');
        panelElement.className = 'content-reveal-panel swivel-enter';
        panelElement.style.backgroundColor = panel.color;
        panelElement.style.animationDelay = `${index * 0.15}s`;
        panelElement.innerHTML = `
          <div class="text-center">
            <div class="text-lg font-bold mb-2">${panel.title}</div>
            <div class="text-sm opacity-75">Click to reveal</div>
          </div>
        `;
        
        let isExpanded = false;
        panelElement.onclick = function() {
          isExpanded = !isExpanded;
          this.classList.add('swivel-enter');
          if (isExpanded) {
            this.classList.add('expanded');
            this.innerHTML = `
              <div class="text-center">
                <div class="text-lg font-bold mb-3">${panel.title}</div>
                <div class="text-sm">${panel.content}</div>
                <div class="text-xs opacity-75 mt-3">Click to collapse</div>
              </div>
            `;
          } else {
            this.classList.remove('expanded');
            this.innerHTML = `
              <div class="text-center">
                <div class="text-lg font-bold mb-2">${panel.title}</div>
                <div class="text-sm opacity-75">Click to reveal</div>
              </div>
            `;
          }
        };
        
        container.appendChild(panelElement);
      });
      
      playArea.appendChild(container);
    };
    
    // Content Reveal Edit Mode
    window.renderContentRevealEditMode = function() {
      if (!activityData.panels) activityData.panels = [];
      
      activityData.panels.forEach((panel, index) => {
        const panelCard = document.createElement('div');
        panelCard.className = 'card';
        panelCard.innerHTML = `
          <div class="flex justify-between items-start mb-4">
            <h4 class="text-lg font-bold">Panel ${index + 1}</h4>
            <button class="text-err hover:text-white" onclick="removeContentRevealPanel(${index})" style="color: var(--err);">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="mb-4">
            <label class="block text-sm text-muted mb-2">Title</label>
            <input type="text" value="${panel.title}" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                   oninput="updateContentRevealPanel(${index}, 'title', this.value)">
          </div>
          <div class="mb-4">
            <label class="block text-sm text-muted mb-2">Content</label>
            <textarea class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" rows="3" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                      oninput="updateContentRevealPanel(${index}, 'content', this.value)">${panel.content}</textarea>
          </div>
          <div>
            <label class="block text-sm text-muted mb-2">Background Color</label>
            <input type="color" value="${panel.color}" class="px-2 py-1 rounded" 
                   oninput="updateContentRevealPanel(${index}, 'color', this.value)">
          </div>
        `;
        editor.appendChild(panelCard);
      });
      
      if (addItemBtn) {
        addItemBtn.onclick = function() {
          if (!activityData.panels) activityData.panels = [];
          activityData.panels.push({
            title: "New Panel",
            content: "Panel content here",
            color: "#F2B565"
          });
          renderEditMode();
        };
      }
    };
    
    window.updateContentRevealPanel = function(index, field, value) {
      if (activityData.panels && activityData.panels[index]) {
        activityData.panels[index][field] = value;
      }
    };
    
    window.removeContentRevealPanel = function(index) {
      if (confirm('Are you sure you want to remove this panel?')) {
        if (activityData.panels) {
          activityData.panels.splice(index, 1);
          renderEditMode();
        }
      }
    };
    
    // Mental Health Drag & Drop Play Mode
    window.renderMentalDragPlayMode = function() {
      if (!activityData.dragItems || !activityData.dropZones) {
        playArea.innerHTML = '<div class="text-center py-12 text-muted">No drag and drop items available.</div>';
        return;
      }
      
      const mainContainer = document.createElement('div');
      mainContainer.style.backgroundColor = 'var(--accent)';
      mainContainer.style.padding = '2rem';
      mainContainer.style.borderRadius = '1rem';
      
      const container = document.createElement('div');
      container.className = 'grid grid-cols-1 md:grid-cols-2 gap-8';
      
      const leftCol = document.createElement('div');
      const rightCol = document.createElement('div');
      
      // Create drop zones
      activityData.dropZones.forEach((zone, index) => {
        const dropZone = document.createElement('div');
        dropZone.className = 'mental-drop-zone fade-enter mb-4';
        dropZone.dataset.correctId = zone.correctId;
        dropZone.dataset.index = index;
        dropZone.style.animationDelay = `${index * 0.1}s`;
        dropZone.innerHTML = `<div class="text-center font-bold">${zone.label}</div>`;
        
        dropZone.addEventListener('dragover', function(e) {
          e.preventDefault();
          this.style.transform = 'scale(1.05)';
        });
        
        dropZone.addEventListener('dragleave', function() {
          this.style.transform = 'scale(1)';
        });
        
        dropZone.addEventListener('drop', function(e) {
          e.preventDefault();
          this.style.transform = 'scale(1)';
          
          const droppedId = parseInt(e.dataTransfer.getData('text/plain'));
          const correctId = parseInt(this.dataset.correctId);
          
          if (droppedId === correctId) {
            this.classList.add('correct');
            this.innerHTML = `
              <div class="flex items-center justify-between">
                <span>${activityData.dragItems.find(item => item.id === droppedId).text}</span>
                <i class="fas fa-check-circle text-white text-xl"></i>
              </div>
            `;
          } else {
            this.classList.add('incorrect');
            setTimeout(() => {
              this.classList.remove('incorrect');
              this.innerHTML = `<div class="text-center font-bold">${zone.label}</div>`;
            }, 1500);
          }
        });
        
        leftCol.appendChild(dropZone);
      });
      
      // Create draggable items
      const shuffledItems = [...activityData.dragItems].sort(() => Math.random() - 0.5);
      shuffledItems.forEach((item, index) => {
        const dragItem = document.createElement('div');
        dragItem.className = 'mental-drag-item fade-enter mb-3';
        dragItem.draggable = true;
        dragItem.dataset.id = item.id;
        dragItem.style.animationDelay = `${index * 0.1}s`;
        dragItem.innerHTML = `
          <div class="flex items-center">
            <i class="fas fa-grip-lines mr-2"></i>
            <span>${item.text}</span>
          </div>
        `;
        
        dragItem.addEventListener('dragstart', function(e) {
          e.dataTransfer.setData('text/plain', this.dataset.id);
          this.style.opacity = '0.5';
        });
        
        dragItem.addEventListener('dragend', function() {
          this.style.opacity = '1';
        });
        
        rightCol.appendChild(dragItem);
      });
      
      container.appendChild(leftCol);
      container.appendChild(rightCol);
      mainContainer.appendChild(container);
      playArea.appendChild(mainContainer);
    };
    
    // Mental Health Drag & Drop Edit Mode
    window.renderMentalDragEditMode = function() {
      if (!activityData.dragItems) activityData.dragItems = [];
      if (!activityData.dropZones) activityData.dropZones = [];
      
      const dragSection = document.createElement('div');
      dragSection.className = 'card mb-6';
      dragSection.innerHTML = '<h4 class="text-lg font-bold mb-4">Draggable Items</h4>';
      
      activityData.dragItems.forEach((item, index) => {
        const itemCard = document.createElement('div');
        itemCard.className = 'mb-4 p-4 rounded-lg' ;
        itemCard.style.border = '1px solid var(--button-border)';
        itemCard.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <h5 class="font-bold">Item ${index + 1}</h5>
            <button class="text-err hover:text-white" onclick="removeMentalDragItem(${index})" style="color: var(--err);">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <input type="text" value="${item.text}" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                 oninput="updateMentalDragItem(${index}, this.value)">
          <div class="text-xs text-muted mt-1">ID: ${item.id}</div>
        `;
        dragSection.appendChild(itemCard);
      });
      
      editor.appendChild(dragSection);
      
      const dropSection = document.createElement('div');
      dropSection.className = 'card';
      dropSection.innerHTML = '<h4 class="text-lg font-bold mb-4">Drop Zones</h4>';
      
      activityData.dropZones.forEach((zone, index) => {
        const zoneCard = document.createElement('div');
        zoneCard.className = 'mb-4 p-4 rounded-lg';
        zoneCard.style.border = '1px solid var(--button-border)';
        zoneCard.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <h5 class="font-bold">Zone ${index + 1}</h5>
            <button class="text-err hover:text-white" onclick="removeMentalDropZone(${index})" style="color: var(--err);">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="mb-2">
            <label class="block text-sm text-muted mb-1">Label</label>
            <input type="text" value="${zone.label}" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                   oninput="updateMentalDropZone(${index}, 'label', this.value)">
          </div>
          <div>
            <label class="block text-sm text-muted mb-1">Correct Item ID</label>
            <input type="number" value="${zone.correctId}" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                   oninput="updateMentalDropZone(${index}, 'correctId', parseInt(this.value))">
          </div>
        `;
        dropSection.appendChild(zoneCard);
      });
      
      editor.appendChild(dropSection);
      
      if (addItemBtn) {
        addItemBtn.onclick = function() {
          if (!activityData.dragItems) activityData.dragItems = [];
          const newId = Math.max(...activityData.dragItems.map(i => i.id), 0) + 1;
          activityData.dragItems.push({
            text: "New symptom",
            id: newId
          });
          activityData.dropZones.push({
            label: `Symptom ${newId}`,
            correctId: newId
          });
          renderEditMode();
        };
      }
    };
    
    window.updateMentalDragItem = function(index, value) {
      if (activityData.dragItems && activityData.dragItems[index]) {
        activityData.dragItems[index].text = value;
      }
    };
    
    window.removeMentalDragItem = function(index) {
      if (confirm('Are you sure you want to remove this item?')) {
        if (activityData.dragItems) {
          activityData.dragItems.splice(index, 1);
          renderEditMode();
        }
      }
    };
    
    window.updateMentalDropZone = function(index, field, value) {
      if (activityData.dropZones && activityData.dropZones[index]) {
        activityData.dropZones[index][field] = value;
      }
    };
    
    window.removeMentalDropZone = function(index) {
      if (confirm('Are you sure you want to remove this zone?')) {
        if (activityData.dropZones) {
          activityData.dropZones.splice(index, 1);
          renderEditMode();
        }
      }
    };
    
    // Pick Many Quiz Play Mode
    window.renderPickManyPlayMode = function() {
      if (!activityData.items || activityData.items.length === 0) {
        playArea.innerHTML = '<div class="text-center py-12 text-muted">No items available.</div>';
        return;
      }
      
      const mainContainer = document.createElement('div');
      mainContainer.style.backgroundColor = '#F2B565';
      mainContainer.style.padding = '2rem';
      mainContainer.style.borderRadius = '1rem';
      
      // Header
      const header = document.createElement('div');
      header.style.backgroundColor = '#5EA2E3';
      header.style.padding = '1.5rem';
      header.style.borderRadius = '0.5rem';
      header.style.marginBottom = '2rem';
      header.style.transform = 'skewX(-5deg)';
      header.className = 'float-enter';
      header.innerHTML = `
        <h3 class="text-2xl font-bold text-white text-center" style="transform: skewX(5deg);">${activityData.title}</h3>
        <p class="text-white text-center mt-2" style="transform: skewX(5deg);">${activityData.question || 'Select all correct answers'}</p>
      `;
      mainContainer.appendChild(header);
      
      // Items
      const itemsContainer = document.createElement('div');
      itemsContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
      
      const selectedItems = new Set();
      
      activityData.items.forEach((item, index) => {
        const itemElement = document.createElement('div');
        itemElement.className = 'pick-many-item swivel-enter';
        itemElement.dataset.index = index;
        itemElement.style.animationDelay = `${index * 0.1}s`;
        itemElement.innerHTML = `
          <div class="flex items-center justify-between">
            <span>${item.text}</span>
            <i class="fas fa-square text-white"></i>
          </div>
        `;
        
        itemElement.onclick = function() {
          const idx = parseInt(this.dataset.index);
          if (selectedItems.has(idx)) {
            selectedItems.delete(idx);
            this.classList.remove('selected');
            this.querySelector('i').className = 'fas fa-square text-white';
          } else {
            selectedItems.add(idx);
            this.classList.add('selected');
            this.querySelector('i').className = 'fas fa-check-square text-white';
          }
        };
        
        itemsContainer.appendChild(itemElement);
      });
      
      mainContainer.appendChild(itemsContainer);
      playArea.appendChild(mainContainer);
      
      // Check button
      const checkButton = document.createElement('button');
      checkButton.className = 'btn btn-primary mt-6';
      checkButton.innerHTML = '<i class="fas fa-check mr-2"></i> Submit Answers';
      checkButton.onclick = function() {
        let correct = 0;
        let total = activityData.items.filter(item => item.isCorrect).length;
        let correctSelections = 0;
        let incorrectSelections = 0;
        
        activityData.items.forEach((item, index) => {
          const itemElement = itemsContainer.children[index];
          const isSelected = selectedItems.has(index);
          
          // Disable further clicks
          itemElement.style.pointerEvents = 'none';
          
          if (item.isCorrect && isSelected) {
            correct++;
            correctSelections++;
            itemElement.classList.add('correct');
            itemElement.style.backgroundColor = 'var(--success)';
            itemElement.querySelector('i').className = 'fas fa-check-circle text-white';
          } else if (item.isCorrect && !isSelected) {
            // Should have been selected but wasn't
            itemElement.style.backgroundColor = 'var(--warn)';
            itemElement.style.opacity = '0.7';
            itemElement.querySelector('i').className = 'fas fa-exclamation-circle text-white';
          } else if (!item.isCorrect && isSelected) {
            // Incorrectly selected
            incorrectSelections++;
            itemElement.classList.add('incorrect');
            itemElement.style.backgroundColor = 'var(--error)';
            itemElement.querySelector('i').className = 'fas fa-times-circle text-white';
          } else {
            // Correctly not selected
            itemElement.style.opacity = '0.6';
          }
        });
        
        const percentage = Math.round((correct / total) * 100);
        
        // Create inline result display
        const resultDiv = document.createElement('div');
        resultDiv.className = 'mt-6 p-6 rounded-lg text-center';
        resultDiv.style.backgroundColor = correct === total && incorrectSelections === 0 ? 'var(--success-bg)' : 'var(--warn-bg)';
        resultDiv.style.borderColor = correct === total && incorrectSelections === 0 ? 'var(--success)' : 'var(--warn)';
        resultDiv.style.color = correct === total && incorrectSelections === 0 ? 'var(--success)' : 'var(--warn)';
        resultDiv.style.border = '2px solid';
        
        const icon = correct === total && incorrectSelections === 0 ? '' : '';
        const message = correct === total && incorrectSelections === 0 ? 'Perfect Score!' : 'Good Try!';
        
        resultDiv.innerHTML = `
          <div class="text-3xl mb-3">${icon}</div>
          <div class="text-2xl font-bold mb-2">${message}</div>
          <div class="text-xl mb-2">You got <span class="font-bold" style="color: var(--success);">${correct}</span> out of <span class="font-bold">${total}</span> correct answers!</div>
          ${incorrectSelections > 0 ? `<div class="text-lg mb-2" style="color: var(--error);">Incorrectly selected: ${incorrectSelections}</div>` : ''}
          <div class="text-lg">${percentage}% Correct</div>
          <button class="btn btn-primary mt-4" onclick="resetActivity()">Try Again</button>
        `;
        
        // Replace check button with result
        checkButton.replaceWith(resultDiv);
      };
      
      playControls.appendChild(checkButton);
    };
    
    // Pick Many Quiz Edit Mode
    window.renderPickManyEditMode = function() {
      if (!activityData.items) activityData.items = [];
      
      const questionCard = document.createElement('div');
      questionCard.className = 'card mb-6';
      questionCard.innerHTML = `
        <h4 class="text-lg font-bold mb-4">Quiz Question</h4>
        <label class="block text-sm text-muted mb-2">Question Text</label>
        <input type="text" value="${activityData.question || ''}" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
               oninput="updatePickManyQuestion(this.value)">
      `;
      editor.appendChild(questionCard);
      
      activityData.items.forEach((item, index) => {
        const itemCard = document.createElement('div');
        itemCard.className = 'card';
        itemCard.innerHTML = `
          <div class="flex justify-between items-start mb-4">
            <h4 class="text-lg font-bold">Item ${index + 1}</h4>
            <button class="text-err hover:text-white" onclick="removePickManyItem(${index})" style="color: var(--err);">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="mb-4">
            <label class="block text-sm text-muted mb-2">Statement</label>
            <input type="text" value="${item.text}" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                   oninput="updatePickManyItem(${index}, 'text', this.value)">
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="correct-${index}" ${item.isCorrect ? 'checked' : ''} 
                   onchange="updatePickManyItem(${index}, 'isCorrect', this.checked)"
                   class="mr-2">
            <label for="correct-${index}" class="text-sm text-muted">This is a correct answer</label>
          </div>
        `;
        editor.appendChild(itemCard);
      });
      
      if (addItemBtn) {
        addItemBtn.onclick = function() {
          if (!activityData.items) activityData.items = [];
          activityData.items.push({
            text: "New statement",
            isCorrect: false
          });
          renderEditMode();
        };
      }
    };
    
    window.updatePickManyQuestion = function(value) {
      if (activityData) {
        activityData.question = value;
      }
    };
    
    window.updatePickManyItem = function(index, field, value) {
      if (activityData.items && activityData.items[index]) {
        activityData.items[index][field] = value;
      }
    };
    
    window.removePickManyItem = function(index) {
      if (confirm('Are you sure you want to remove this item?')) {
        if (activityData.items) {
          activityData.items.splice(index, 1);
          renderEditMode();
        }
      }
    };
    
    // Info Card Play Mode
    window.renderInfoCardPlayMode = function() {
      if (!activityData) {
        playArea.innerHTML = '<div class="text-center py-12 text-muted">No info card data available.</div>';
        return;
      }
      
      const card = document.createElement('div');
      card.className = 'info-card float-enter';
      card.innerHTML = `
        <h2 class="text-4xl font-bold mb-4">${activityData.title || 'Info Card'}</h2>
        <h3 class="text-2xl mb-6">${activityData.subtitle || ''}</h3>
        <p class="text-lg mb-8">${activityData.description || ''}</p>
        ${activityData.colorBars ? `
          <div class="grid grid-cols-${Math.min(activityData.colorBars.length, 4)} gap-4">
            ${activityData.colorBars.map(bar => `
              <div class="text-center">
                <div class="h-3 rounded-full mb-2" style="background-color: ${bar.color};"></div>
                <div class="text-sm">${bar.label}</div>
              </div>
            `).join('')}
          </div>
        ` : ''}
      `;
      playArea.appendChild(card);
    };
    
    // Info Card Edit Mode
    window.renderInfoCardEditMode = function() {
      const mainCard = document.createElement('div');
      mainCard.className = 'card mb-6';
      mainCard.innerHTML = `
        <h4 class="text-lg font-bold mb-4">Card Content</h4>
        <div class="mb-4">
          <label class="block text-sm text-muted mb-2">Subtitle</label>
          <input type="text" value="${activityData.subtitle || ''}" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                 oninput="updateInfoCard('subtitle', this.value)">
        </div>
        <div class="mb-4">
          <label class="block text-sm text-muted mb-2">Description</label>
          <textarea class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" rows="4" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                    oninput="updateInfoCard('description', this.value)">${activityData.description || ''}</textarea>
        </div>
      `;
      editor.appendChild(mainCard);
      
      if (!activityData.colorBars) activityData.colorBars = [];
      
      const barsSection = document.createElement('div');
      barsSection.className = 'card';
      barsSection.innerHTML = '<h4 class="text-lg font-bold mb-4">Color Bars</h4>';
      
      activityData.colorBars.forEach((bar, index) => {
        const barCard = document.createElement('div');
        barCard.className = 'mb-4 p-4 rounded-lg';
        barCard.style.border = '1px solid var(--button-border)';
        barCard.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <h5 class="font-bold">Bar ${index + 1}</h5>
            <button class="text-err hover:text-white" onclick="removeInfoCardBar(${index})" style="color: var(--err);">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-muted mb-1">Label</label>
              <input type="text" value="${bar.label}" class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                     oninput="updateInfoCardBar(${index}, 'label', this.value)">
            </div>
            <div>
              <label class="block text-sm text-muted mb-1">Color</label>
              <input type="color" value="${bar.color}" class="px-2 py-1 rounded" 
                     oninput="updateInfoCardBar(${index}, 'color', this.value)">
            </div>
          </div>
        `;
        barsSection.appendChild(barCard);
      });
      
      editor.appendChild(barsSection);
      
      if (addItemBtn) {
        addItemBtn.onclick = function() {
          if (!activityData.colorBars) activityData.colorBars = [];
          activityData.colorBars.push({
            label: "New Category",
            color: "#5EA2E3"
          });
          renderEditMode();
        };
      }
    };
    
    window.updateInfoCard = function(field, value) {
      if (activityData) {
        activityData[field] = value;
      }
    };
    
    window.updateInfoCardBar = function(index, field, value) {
      if (activityData.colorBars && activityData.colorBars[index]) {
        activityData.colorBars[index][field] = value;
      }
    };
    
    window.removeInfoCardBar = function(index) {
      if (confirm('Are you sure you want to remove this color bar?')) {
        if (activityData.colorBars) {
          activityData.colorBars.splice(index, 1);
          renderEditMode();
        }
      }
    };
    
    // ===== SCORM Viewer Functions =====
    
    // SCORM Viewer Play Mode
    window.renderSCORMViewerPlayMode = function() {
      if (!activityData.scormUrl) {
        playArea.innerHTML = '<div class="text-center py-12 text-muted">No SCORM package configured.</div>';
        return;
      }
      
      const container = document.createElement('div');
      container.className = 'scorm-container';
      container.innerHTML = `
        <div class="mb-4 p-4 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border);">
          <p class="text-sm text-muted mb-2">${activityData.description || 'SCORM Package'}</p>
        </div>
        <div class="relative rounded-lg overflow-hidden" style="background-color: var(--background); border: 2px solid var(--card-border);">
          <iframe 
            src="${activityData.scormUrl}" 
            style="width: ${activityData.width || '100%'}; height: ${activityData.height || '600px'}; border: none;"
            allow="fullscreen; accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            title="${activityData.title || 'SCORM Content'}"
          ></iframe>
        </div>
      `;
      
      playArea.innerHTML = '';
      playArea.appendChild(container);
      
      // Add fullscreen button
      if (playControls) {
        playControls.innerHTML = `
          <button class="btn btn-primary" onclick="toggleSCORMFullscreen()">
            <div class="icon-fullscreen mr-2"></div>
            Fullscreen
          </button>
          <button class="btn btn-ghost" onclick="refreshSCORM()">
            <i class="fas fa-sync-alt mr-2"></i>
            Reload
          </button>
        `;
      }
    };
    
    // SCORM Viewer Edit Mode
    window.renderSCORMViewerEditMode = function() {
      const configCard = document.createElement('div');
      configCard.className = 'card mb-6';
      configCard.innerHTML = `
        <h4 class="text-lg font-bold mb-4">SCORM Package Configuration</h4>
        
        <div class="mb-4">
          <label class="block text-sm text-muted mb-2">SCORM Package URL</label>
          <input type="text" value="${activityData.scormUrl || ''}" 
                 class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                 style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                 oninput="updateSCORMViewer('scormUrl', this.value)"
                 placeholder="scorm/story.html or full URL">
          <p class="text-xs text-muted mt-1">Path to your SCORM package entry point (story.html or index_lms.html)</p>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm text-muted mb-2">Description</label>
          <input type="text" value="${activityData.description || ''}" 
                 class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                 style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                 oninput="updateSCORMViewer('description', this.value)"
                 placeholder="Brief description of the SCORM content">
        </div>
        
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm text-muted mb-2">Width</label>
            <input type="text" value="${activityData.width || '100%'}" 
                   class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                   style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                   oninput="updateSCORMViewer('width', this.value)"
                   placeholder="100% or 800px">
          </div>
          <div>
            <label class="block text-sm text-muted mb-2">Height</label>
            <input type="text" value="${activityData.height || '600px'}" 
                   class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                   style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                   oninput="updateSCORMViewer('height', this.value)"
                   placeholder="600px">
          </div>
        </div>
        
        <div class="p-4 rounded-lg" style="background-color: var(--drag-bg); border: 1px solid var(--card-border);">
          <p class="text-sm mb-2"><strong>Available SCORM Packages:</strong></p>
          <ul class="text-sm text-muted space-y-1">
            <li> <code class="text-primary">scorm/story.html</code> - Tamer Educational Activities</li>
            <li> <code class="text-primary">scorm/index_lms.html</code> - LMS Version</li>
          </ul>
        </div>
      `;
      
      editor.appendChild(configCard);
      
      // Preview card
      const previewCard = document.createElement('div');
      previewCard.className = 'card';
      previewCard.innerHTML = `
        <h4 class="text-lg font-bold mb-4">Preview</h4>
        <div class="relative rounded-lg overflow-hidden" style="background-color: var(--background); border: 2px solid var(--card-border); height: 400px;">
          <iframe 
            src="${activityData.scormUrl || 'about:blank'}" 
            style="width: 100%; height: 100%; border: none;"
            title="SCORM Preview"
          ></iframe>
        </div>
        <p class="text-xs text-muted mt-2">Switch to Play Mode for full-size preview</p>
      `;
      
      editor.appendChild(previewCard);
    };
    
    // Update SCORM Viewer settings
    window.updateSCORMViewer = function(field, value) {
      if (activityData) {
        activityData[field] = value;
        // Refresh preview
        if (currentMode === 'edit') {
          renderEditMode();
        }
      }
    };
    
    // Toggle SCORM fullscreen
    window.toggleSCORMFullscreen = function() {
      const iframe = document.querySelector('.scorm-container iframe');
      if (iframe) {
        if (iframe.requestFullscreen) {
          iframe.requestFullscreen();
        } else if (iframe.webkitRequestFullscreen) {
          iframe.webkitRequestFullscreen();
        } else if (iframe.mozRequestFullScreen) {
          iframe.mozRequestFullScreen();
        } else if (iframe.msRequestFullscreen) {
          iframe.msRequestFullscreen();
        }
      }
    };
    
    // Refresh SCORM content
    window.refreshSCORM = function() {
      const iframe = document.querySelector('.scorm-container iframe');
      if (iframe) {
        iframe.src = iframe.src;
      }
    };
    
    // ===== End SCORM Viewer Functions =====
    
    // ===== Game Arena Functions =====
    
    // Game Arena Play Mode
    window.renderGameArenaPlayMode = function() {
      console.log('Rendering Game Arena play mode');
      console.log('Game Arena activityData:', activityData);
      
      if (!activityData) {
        playArea.innerHTML = '<div class="text-center py-12 text-muted">No Game Arena data available.</div>';
        return;
      }
      
      const container = document.createElement('div');
      container.className = 'game-arena-container';
      container.innerHTML = `
        <div class="mb-4 p-4 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border);">
          <p class="text-sm text-muted mb-2">${activityData.description || 'Interactive Game Arena Activity'}</p>
          <p class="text-xs text-muted">${activityData.instructions || 'Complete the game challenges to test your knowledge'}</p>
        </div>
        
        <div class="relative rounded-lg overflow-hidden" style="background-color: var(--background); border: 2px solid var(--card-border);">
          <iframe 
            src="${activityData.packagePath}/story.html" 
            style="width: ${activityData.width || '100%'}; height: ${activityData.height || '700px'}; border: none;"
            allow="fullscreen; accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            title="${activityData.title || 'Game Arena Activity'}"
          ></iframe>
        </div>
      `;
      
      playArea.innerHTML = '';
      playArea.appendChild(container);
      
      // Add fullscreen button
      if (playControls) {
        playControls.innerHTML = `
          <button class="btn btn-primary" onclick="toggleGameArenaFullscreen()">
            <div class="icon-fullscreen mr-2"></div>
            Fullscreen
          </button>
          <button class="btn btn-ghost" onclick="refreshGameArena()">
            <i class="fas fa-sync-alt mr-2"></i>
            Reload
          </button>
        `;
      }
    };
    
    // Game Arena Edit Mode
    window.renderGameArenaEditMode = function() {
      console.log('Rendering Game Arena edit mode');
      console.log('Game Arena activityData:', activityData);
      const configCard = document.createElement('div');
      configCard.className = 'card mb-6';
      configCard.innerHTML = `
        <h4 class="text-lg font-bold mb-4">Game Arena Configuration</h4>
        
        <div class="mb-4">
          <label class="block text-sm text-muted mb-2">Game Package Path</label>
          <input type="text" value="${activityData.packagePath || ''}" 
                 class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                 style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                 oninput="updateGameArena('packagePath', this.value)"
                 placeholder="Path to your game package folder">
          <p class="text-xs text-muted mt-1">Path to your Game Arena package folder (e.g., 'Game Arena')</p>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm text-muted mb-2">Description</label>
          <input type="text" value="${activityData.description || ''}" 
                 class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                 style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                 oninput="updateGameArena('description', this.value)"
                 placeholder="Brief description of the game activity">
        </div>
        
        <div class="mb-4">
          <label class="block text-sm text-muted mb-2">Instructions</label>
          <textarea 
            class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
            style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text); height: 80px;"
            oninput="updateGameArena('instructions', this.value)"
            placeholder="Instructions for users">${activityData.instructions || ''}</textarea>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm text-muted mb-2">Width</label>
            <input type="text" value="${activityData.width || '100%'}" 
                   class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                   style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                   oninput="updateGameArena('width', this.value)"
                   placeholder="100% or 800px">
          </div>
          <div>
            <label class="block text-sm text-muted mb-2">Height</label>
            <input type="text" value="${activityData.height || '700px'}" 
                   class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                   style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                   oninput="updateGameArena('height', this.value)"
                   placeholder="700px">
          </div>
        </div>
        
        <div class="p-4 rounded-lg" style="background-color: var(--drag-bg); border: 1px solid var(--card-border);">
          <p class="text-sm mb-2"><strong>Game Arena Package:</strong></p>
          <p class="text-sm text-muted">Your Game Arena package should be placed in the root directory of this application.</p>
          <p class="text-xs text-muted mt-1">Current path: <code class="text-primary">${activityData.packagePath || 'Game Arena'}/story.html</code></p>
        </div>
      `;
      
      editor.appendChild(configCard);
      
      // Preview card
      const previewCard = document.createElement('div');
      previewCard.className = 'card';
      previewCard.innerHTML = `
        <h4 class="text-lg font-bold mb-4">Preview</h4>
        <div class="relative rounded-lg overflow-hidden" style="background-color: var(--background); border: 2px solid var(--card-border); height: 400px;">
          <iframe 
            src="${activityData.packagePath || 'Game Arena'}/story.html" 
            style="width: 100%; height: 100%; border: none;"
            title="Game Arena Preview"
          ></iframe>
        </div>
        <p class="text-xs text-muted mt-2">Switch to Play Mode for full-size preview</p>
      `;
      
      editor.appendChild(previewCard);
    };
    
    // Update Game Arena settings
    window.updateGameArena = function(field, value) {
      console.log('updateGameArena called with field:', field, 'value:', value);
      console.log('Current activityData before update:', activityData);
      if (activityData) {
        activityData[field] = value;
        console.log('Updated Game Arena field:', field, 'to:', value);
        console.log('Current activityData after update:', activityData);
        // Refresh preview
        if (currentMode === 'edit') {
          console.log('Refreshing edit mode preview');
          renderEditMode();
        }
      }
    };
    
    // Toggle Game Arena fullscreen
    window.toggleGameArenaFullscreen = function() {
      const iframe = document.querySelector('.game-arena-container iframe');
      if (iframe) {
        if (iframe.requestFullscreen) {
          iframe.requestFullscreen();
        } else if (iframe.webkitRequestFullscreen) {
          iframe.webkitRequestFullscreen();
        } else if (iframe.mozRequestFullScreen) {
          iframe.mozRequestFullScreen();
        } else if (iframe.msRequestFullscreen) {
          iframe.msRequestFullscreen();
        }
      }
    };
    
    // Refresh Game Arena content
    window.refreshGameArena = function() {
      const iframe = document.querySelector('.game-arena-container iframe');
      if (iframe) {
        iframe.src = iframe.src;
      }
    };
    
    // ===== End Game Arena Functions =====
    
    // ===== NEW TEMPLATES RENDER FUNCTIONS =====
    
    // Crossword Play Mode
    window.renderCrosswordPlayMode = function() {
      // Check if there are any words to place
      if (!activityData.words || activityData.words.length === 0) {
        playArea.innerHTML = `
          <div class="card">
            <h4 class="text-xl font-bold mb-4">${activityData.description || 'Crossword Puzzle'}</h4>
            <div class="text-center p-8 text-muted">
              <p>No words have been added to this crossword puzzle yet.</p>
              <p class="mt-2">Switch to Edit mode to add words and clues.</p>
            </div>
          </div>
        `;
        return;
      }
      
      // Calculate required grid size based on word positions
      let maxGridSize = activityData.gridSize || 15;
      activityData.words.forEach(wordObj => {
        const { word, startX, startY, direction } = wordObj;
        const x = startX || 0;
        const y = startY || 0;
        
        if (direction === 'across') {
          maxGridSize = Math.max(maxGridSize, x + word.length, y + 1);
        } else { // down
          maxGridSize = Math.max(maxGridSize, x + 1, y + word.length);
        }
      });
      
      // Ensure grid is at least 10x10
      maxGridSize = Math.max(maxGridSize, 10);
      
      // Create the crossword grid based on the words
      const gridSize = maxGridSize;
      const grid = Array(gridSize).fill().map(() => Array(gridSize).fill(''));
      
      // Place words on the grid
      activityData.words.forEach(wordObj => {
        const { word, startX, startY, direction } = wordObj;
        const x = startX || 0;
        const y = startY || 0;
        
        for (let i = 0; i < word.length; i++) {
          if (direction === 'across') {
            if (x + i < gridSize && y < gridSize) {
              grid[y][x + i] = word[i];
            }
          } else { // down
            if (x < gridSize && y + i < gridSize) {
              grid[y + i][x] = word[i];
            }
          }
        }
      });
      
      playArea.innerHTML = `
        <div class="card">
          <h4 class="text-xl font-bold mb-4">${activityData.description || 'Crossword Puzzle'}</h4>
          <div class="crossword-container">
            <div class="crossword-grid" style="grid-template-columns: repeat(${gridSize}, 1fr); grid-template-rows: repeat(${gridSize}, 1fr);" id="crossword-grid">
              ${grid.map((row, y) => 
                row.map((cell, x) => `
                  <div class="crossword-cell" 
                       data-x="${x}" 
                       data-y="${y}" 
                       contenteditable="true"
                       maxlength="1"
                       style="border: 1px solid var(--text); text-align: center; padding: 0; margin: 0; min-width: 30px; min-height: 30px;">
                    ${cell || ''}
                  </div>`
                ).join('')
              ).join('')}
            </div>
            <div class="crossword-clues mt-6">
              <div class="crossword-across">
                <h5 class="font-bold mb-2">Across:</h5>
                ${activityData.words.filter(w => w.direction === 'across').map((w, i) => `
                  <div class="text-sm mb-1" onclick="highlightWord('${w.word}', 'across', ${w.startX}, ${w.startY})">
                    <strong>${w.startY + 1}.${w.startX + 1}-A:</strong> ${w.clue}
                  </div>
                `).join('')}
              </div>
              <div class="crossword-down mt-4">
                <h5 class="font-bold mb-2">Down:</h5>
                ${activityData.words.filter(w => w.direction === 'down').map((w, i) => `
                  <div class="text-sm mb-1" onclick="highlightWord('${w.word}', 'down', ${w.startX}, ${w.startY})">
                    <strong>${w.startY + 1}.${w.startX + 1}-D:</strong> ${w.clue}
                  </div>
                `).join('')}
              </div>
            </div>
            <div class="mt-6">
              <button class="btn btn-primary" onclick="checkCrosswordAnswers()">Check Answers</button>
              <button class="btn btn-secondary ml-2" onclick="clearCrossword()">Clear Grid</button>
            </div>
          </div>
        </div>
      `;
      
      // Add event listeners to cells
      document.querySelectorAll('.crossword-cell').forEach(cell => {
        cell.addEventListener('input', function() {
          // Only allow single characters
          if (this.textContent.length > 1) {
            this.textContent = this.textContent.slice(0, 1);
          }
          // Only allow uppercase letters
          if (this.textContent && !/^[A-Z]$/.test(this.textContent)) {
            this.textContent = this.textContent.toUpperCase().replace(/[^A-Z]/g, '');
          }
        });
        
        cell.addEventListener('keydown', function(e) {
          if (e.key === 'ArrowRight' || e.key === 'ArrowLeft' || e.key === 'ArrowUp' || e.key === 'ArrowDown') {
            e.preventDefault();
            const x = parseInt(this.getAttribute('data-x'));
            const y = parseInt(this.getAttribute('data-y'));
            let newX = x, newY = y;
            
            switch(e.key) {
              case 'ArrowRight': newX++; break;
              case 'ArrowLeft': newX--; break;
              case 'ArrowDown': newY++; break;
              case 'ArrowUp': newY--; break;
            }
            
            const nextCell = document.querySelector(`.crossword-cell[data-x="${newX}"][data-y="${newY}"]`);
            if (nextCell) {
              nextCell.focus();
            }
          }
        });
      });
    };
    
    window.renderCrosswordEditMode = function() {
      editor.innerHTML += `
        <div class="card">
          <h4 class="text-lg font-bold mb-4">Crossword Words</h4>
          <p class="text-sm text-muted mb-4">Add words and clues for your crossword puzzle</p>
          <div class="flex flex-wrap gap-3 mb-4">
            <div class="flex-1 min-w-[200px]">
              <label class="block text-sm text-muted mb-2">Grid Size</label>
              <input type="number" id="crossword-grid-size" value="${activityData.gridSize || 15}" class="w-full px-4 py-2 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" min="5" max="20" oninput="updateCrosswordGridSize(this.value)">
            </div>
            <div class="flex items-end">
              <button class="btn btn-accent" onclick="generateCrosswordFromTopic()">
                <i class="fas fa-magic mr-2"></i>
                Generate from Topic
              </button>
            </div>
          </div>
          <div id="crossword-words-list">
            ${(activityData.words || []).map((word, i) => `
              <div class="card p-3 mb-2">
                <div class="flex justify-between items-center mb-2">
                  <span class="font-bold">${word.word}</span>
                  <button class="btn btn-sm btn-ghost" onclick="removeCrosswordWord(${i})">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <label class="block text-xs text-muted mb-1">Word</label>
                    <input type="text" value="${word.word}" class="w-full px-2 py-1 rounded text-sm" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" oninput="updateCrosswordWord(${i}, 'word', this.value.toUpperCase())">
                  </div>
                  <div>
                    <label class="block text-xs text-muted mb-1">Clue</label>
                    <input type="text" value="${word.clue}" class="w-full px-2 py-1 rounded text-sm" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" oninput="updateCrosswordWord(${i}, 'clue', this.value)">
                  </div>
                  <div>
                    <label class="block text-xs text-muted mb-1">Direction</label>
                    <select class="w-full px-2 py-1 rounded text-sm" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" onchange="updateCrosswordWord(${i}, 'direction', this.value)">
                      <option value="across" ${word.direction === 'across' ? 'selected' : ''}>Across</option>
                      <option value="down" ${word.direction === 'down' ? 'selected' : ''}>Down</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs text-muted mb-1">Start X</label>
                    <input type="number" value="${word.startX || 0}" class="w-full px-2 py-1 rounded text-sm" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" min="0" oninput="updateCrosswordWord(${i}, 'startX', parseInt(this.value))">
                  </div>
                  <div>
                    <label class="block text-xs text-muted mb-1">Start Y</label>
                    <input type="number" value="${word.startY || 0}" class="w-full px-2 py-1 rounded text-sm" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" min="0" oninput="updateCrosswordWord(${i}, 'startY', parseInt(this.value))">
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
          <button class="btn btn-primary" onclick="addCrosswordWord()">
            <i class="fas fa-plus mr-2"></i>
            Add Word
          </button>
        </div>
      `;
    };
    
    // Function to add a new word to the crossword
    window.addCrosswordWord = function() {
      const word = prompt('Enter the word:');
      if (!word || word.trim() === '') {
        alert('Word cannot be empty. Word not added.');
        return;
      }
      
      if (!activityData.words) activityData.words = [];
      activityData.words.push({
        word: word.trim().toUpperCase(),
        clue: 'Enter clue for ' + word.trim(),
        startX: 0,
        startY: 0,
        direction: 'across'
      });
      
      // Save the updated data and refresh UI
      updateActivityDisplay();
      renderEditMode();
    };
    
    // Function to generate crossword based on topic
    window.generateCrosswordFromTopic = function() {
      const topic = prompt('Enter a topic for your crossword (e.g., Science, History, Math, etc.):');
      if (!topic || topic.trim() === '') {
        alert('Topic cannot be empty. Please enter a valid topic.');
        return;
      }
      
      // Show loading message
      const editContainer = document.querySelector('#edit-container');
      if (editContainer) {
        editContainer.innerHTML = '<div class="text-center p-8 text-muted"><p>Generating crossword for topic: <strong>' + topic + '</strong></p><p class="mt-2">Please wait...</p></div>';
      }
      
      // Simulate API call with timeout for demo purposes
      // In a real implementation, this would call an actual API
      setTimeout(() => {
        // Sample word/clue pairs based on common educational topics
        const topicWords = {
          'science': [
            {word: 'BIOLOGY', clue: 'Study of living organisms'},
            {word: 'CHEMISTRY', clue: 'Study of matter and its properties'},
            {word: 'PHYSICS', clue: 'Study of energy and motion'},
            {word: 'ATOMIC', clue: 'Smallest unit of matter'},
            {word: 'CELL', clue: 'Basic unit of life'},
            {word: 'ELEMENT', clue: 'Substance made of one type of atom'},
            {word: 'REACTION', clue: 'Process where substances change'},
            {word: 'MOLECULE', clue: 'Two or more atoms bonded together'}
          ],
          'history': [
            {word: 'REVOLUTION', clue: 'Major change in government'},
            {word: 'ANCIENT', clue: 'From long ago'},
            {word: 'EMPIRE', clue: 'Large political unit'},
            {word: 'CIVILIZATION', clue: 'Advanced society'},
            {word: 'MONARCH', clue: 'King or queen'},
            {word: 'BATTLE', clue: 'Fight between armies'},
            {word: 'TREATY', clue: 'Agreement between countries'},
            {word: 'EXPLORER', clue: 'Person who travels to discover'}
          ],
          'math': [
            {word: 'ALGEBRA', clue: 'Math with letters'},
            {word: 'GEOMETRY', clue: 'Math of shapes'},
            {word: 'CALCULUS', clue: 'Advanced math of change'},
            {word: 'EQUATION', clue: 'Mathematical statement'},
            {word: 'THEOREM', clue: 'Provable mathematical statement'},
            {word: 'FRACTION', clue: 'Part of a whole'},
            {word: 'INTEGER', clue: 'Whole number'},
            {word: 'TRIGONOMETRY', clue: 'Math of triangles'}
          ],
          'literature': [
            {word: 'NOVEL', clue: 'Long fictional story'},
            {word: 'POETRY', clue: 'Rhythmic literary form'},
            {word: 'CHARACTER', clue: 'Person in a story'},
            {word: 'PLOT', clue: 'Sequence of events'},
            {word: 'METAPHOR', clue: 'Figure of speech'},
            {word: 'SYMBOLISM', clue: 'Use of symbols'},
            {word: 'NARRATOR', clue: 'Story teller'},
            {word: 'STANZA', clue: 'Group of lines in poem'}
          ],
          'geography': [
            {word: 'CONTINENT', clue: 'Large land mass'},
            {word: 'MOUNTAIN', clue: 'High landform'},
            {word: 'RIVER', clue: 'Flowing water'},
            {word: 'OCEAN', clue: 'Large body of salt water'},
            {word: 'COUNTRY', clue: 'Sovereign state'},
            {word: 'CAPITAL', clue: 'Seat of government'},
            {word: 'CLIMATE', clue: 'Weather patterns'},
            {word: 'LATITUDE', clue: 'Distance from equator'}
          ],
          'information technology': [
            {word: 'ALGORITHM', clue: 'Step-by-step procedure for calculations'},
            {word: 'DATABASE', clue: 'Organized collection of data'},
            {word: 'ENCRYPTION', clue: 'Process of encoding information'},
            {word: 'FIREWALL', clue: 'Network security system'},
            {word: 'GIGABYTE', clue: 'Unit of digital information storage'},
            {word: 'HTML', clue: 'Markup language for web pages'},
            {word: 'INTERNET', clue: 'Global network of computers'},
            {word: 'JAVASCRIPT', clue: 'Programming language for web development'}
          ],
          'it': [
            {word: 'BINARY', clue: 'Base-2 number system'},
            {word: 'CLOUD', clue: 'Internet-based computing services'},
            {word: 'DEBUGGING', clue: 'Process of finding and fixing errors'},
            {word: 'ETHERNET', clue: 'Networking technology for local area networks'},
            {word: 'FIRMWARE', clue: 'Software in hardware devices'},
            {word: 'GUI', clue: 'Graphical user interface'},
            {word: 'HYPERLINK', clue: 'Reference to data'},
            {word: 'IPADDRESS', clue: 'Unique network address'}
          ],
          'general': [
            {word: 'KNOWLEDGE', clue: 'Facts and information acquired through experience'},
            {word: 'LEARNING', clue: 'Acquiring knowledge or skills through study'},
            {word: 'EDUCATION', clue: 'Systematic instruction to develop knowledge'},
            {word: 'SKILL', clue: 'An ability developed through training'},
            {word: 'PRACTICE', clue: 'Repeated performance to acquire proficiency'},
            {word: 'STUDY', clue: 'Dedicated effort to acquire knowledge'},
            {word: 'THINKING', clue: 'Process of using ones mind to consider ideas'},
            {word: 'UNDERSTANDING', clue: 'Grasping the nature of something'}
          ]
        };
        
        // Use words for the specific topic or default to general education
        let selectedWords = [];
        
        // Check if exact topic match exists
        if (topicWords[topic.toLowerCase()]) {
          selectedWords = [...topicWords[topic.toLowerCase()]];
        } else {
          // Check for partial matches (e.g., "info tech" matches "it" or "information technology")
          const lowerTopic = topic.toLowerCase();
          let foundMatch = false;
          
          for (let topicKey in topicWords) {
            if (lowerTopic.includes(topicKey) || topicKey.includes(lowerTopic)) {
              selectedWords = [...topicWords[topicKey]];
              foundMatch = true;
              break;
            }
          }
          
          // If no partial match, use a general education list
          if (!foundMatch) {
            const allWords = [];
            for (let key in topicWords) {
              allWords.push(...topicWords[key]);
            }
            // Pick 8 random words from all topics
            for (let i = 0; i < 8; i++) {
              const randomIndex = Math.floor(Math.random() * allWords.length);
              selectedWords.push(allWords[randomIndex]);
            }
          }
        }
        
        // Initialize activity data with generated words
        if (!activityData.words) activityData.words = [];
        
        // Add the generated words (limit to 8 to avoid overcrowding)
        const wordsToAdd = selectedWords.slice(0, 8);
        
        // Clear existing words and add new ones
        activityData.words = [];
        
        // Fixed grid size to 10 as per requirements
        const gridSize = 10;
        
        // Create a grid to track where letters are placed
        const grid = Array(gridSize).fill().map(() => Array(gridSize).fill(''));
        
        // Track which words have been used to avoid duplicates
        const usedWords = new Set();
        
        // Place the first word horizontally in the center
        if (wordsToAdd.length > 0) {
          const firstWord = wordsToAdd[0];
          usedWords.add(firstWord.word);
          
          // Make sure the first word fits in the grid
          if (firstWord.word.length <= gridSize) {
            const startX = Math.floor((gridSize - firstWord.word.length) / 2);
            const startY = Math.floor(gridSize / 2);
            
            activityData.words.push({
              word: firstWord.word,
              clue: firstWord.clue,
              startX: startX,
              startY: startY,
              direction: 'across'
            });
            
            // Place the word on the grid
            for (let i = 0; i < firstWord.word.length; i++) {
              grid[startY][startX + i] = firstWord.word[i];
            }
          }
        }
        

        
        // Place remaining words to intersect with existing words
        for (let i = 1; i < wordsToAdd.length; i++) {
          const currentWord = wordsToAdd[i];
          
          // Skip if this word is already used
          if (usedWords.has(currentWord.word)) {
            continue;
          }
          
          let placed = false;
          
          // Try to place the word vertically to intersect with existing words
          for (let y = 0; y < gridSize; y++) {
            for (let x = 0; x < gridSize; x++) {
              if (grid[y][x] !== '') {
                // Check if this letter exists in the current word
                for (let wIdx = 0; wIdx < currentWord.word.length; wIdx++) {
                  if (currentWord.word[wIdx] === grid[y][x]) {
                    // Try to place the word vertically through this intersection
                    const wordStartY = y - wIdx;
                    const wordEndY = wordStartY + currentWord.word.length - 1;
                    
                    // Check if the word fits vertically
                    if (wordStartY >= 0 && wordEndY < gridSize) {
                      // Check if placement is valid (no conflicts)
                      let validPlacement = true;
                      for (let j = 0; j < currentWord.word.length; j++) {
                        const checkY = wordStartY + j;
                        if (checkY >= 0 && checkY < gridSize && x >= 0 && x < gridSize) {
                          if (grid[checkY][x] !== '' && grid[checkY][x] !== currentWord.word[j]) {
                            validPlacement = false;
                            break;
                          }
                        } else {
                          validPlacement = false;
                          break;
                        }
                      }
                      
                      // Check horizontal neighbors to avoid unintended words
                      if (validPlacement) {
                        for (let j = 0; j < currentWord.word.length; j++) {
                          const checkY = wordStartY + j;
                          if (x > 0 && checkY >= 0 && checkY < gridSize && grid[checkY][x-1] !== '') {
                            validPlacement = false;
                            break;
                          }
                          if (x < gridSize-1 && checkY >= 0 && checkY < gridSize && grid[checkY][x+1] !== '') {
                            validPlacement = false;
                            break;
                          }
                        }
                      }
                      
                      if (validPlacement) {
                        // Place the word vertically
                        activityData.words.push({
                          word: currentWord.word,
                          clue: currentWord.clue,
                          startX: x,
                          startY: wordStartY,
                          direction: 'down'
                        });
                        usedWords.add(currentWord.word);
                        
                        // Update the grid
                        for (let j = 0; j < currentWord.word.length; j++) {
                          const checkY = wordStartY + j;
                          if (checkY >= 0 && checkY < gridSize && x >= 0 && x < gridSize) {
                            grid[checkY][x] = currentWord.word[j];
                          }
                        }
                        placed = true;
                        break;
                      }
                    }
                  }
                }
              }
              if (placed) break;
            }
            if (placed) break;
          }
          
          // If we couldn't place vertically, try to place horizontally
          if (!placed) {
            // Find a suitable position for horizontal placement
            for (let y = 0; y < gridSize; y++) {
              for (let x = 0; x < gridSize; x++) {
                // Check if we can place horizontally without exceeding grid
                if (x + currentWord.word.length <= gridSize) {
                  // Check if placement is valid
                  let validPlacement = true;
                  
                  for (let j = 0; j < currentWord.word.length; j++) {
                    if (grid[y][x+j] !== '' && grid[y][x+j] !== currentWord.word[j]) {
                      validPlacement = false;
                      break;
                    }
                  }
                  
                  // Check vertical neighbors to avoid unintended words
                  if (validPlacement) {
                    if (y > 0) {
                      for (let j = 0; j < currentWord.word.length; j++) {
                        if (grid[y-1][x+j] !== '') {
                          validPlacement = false;
                          break;
                        }
                      }
                    }
                    if (y < gridSize-1 && validPlacement) {
                      for (let j = 0; j < currentWord.word.length; j++) {
                        if (grid[y+1][x+j] !== '') {
                          validPlacement = false;
                          break;
                        }
                      }
                    }
                  }
                  
                  if (validPlacement) {
                    // Place the word horizontally
                    activityData.words.push({
                      word: currentWord.word,
                      clue: currentWord.clue,
                      startX: x,
                      startY: y,
                      direction: 'across'
                    });
                    usedWords.add(currentWord.word);
                    
                    // Update the grid
                    for (let j = 0; j < currentWord.word.length; j++) {
                      grid[y][x+j] = currentWord.word[j];
                    }
                    placed = true;
                    break;
                  }
                }
              }
              if (placed) break;
            }
          }
          
          // If still couldn't place the word with intersection logic, try a random direction
          if (!placed && activityData.words.length < 8) { // Limit to 8 words
            // Try to place it in a random direction if it fits
            if (currentWord.word.length <= gridSize) {
              let placedRandomly = false;
              // Try a few random positions with random direction
              for (let attempts = 0; attempts < 20 && !placedRandomly; attempts++) {
                const isVertical = Math.random() > 0.5; // Randomly choose direction
                
                if (isVertical && currentWord.word.length <= gridSize) {
                  // Try vertical placement
                  const randomX = Math.floor(Math.random() * gridSize);
                  const randomY = Math.floor(Math.random() * (gridSize - currentWord.word.length + 1));
                  
                  // Check if this position is valid for vertical placement
                  let validPlacement = true;
                  for (let j = 0; j < currentWord.word.length; j++) {
                    if (grid[randomY + j][randomX] !== '') {
                      validPlacement = false;
                      break;
                    }
                  }
                  
                  if (validPlacement) {
                    activityData.words.push({
                      word: currentWord.word,
                      clue: currentWord.clue,
                      startX: randomX,
                      startY: randomY,
                      direction: 'down'
                    });
                    usedWords.add(currentWord.word);
                    
                    // Place the word on the grid
                    for (let j = 0; j < currentWord.word.length; j++) {
                      grid[randomY + j][randomX] = currentWord.word[j];
                    }
                    placedRandomly = true;
                  }
                } else if (!isVertical) {
                  // Try horizontal placement
                  const randomX = Math.floor(Math.random() * (gridSize - currentWord.word.length + 1));
                  const randomY = Math.floor(Math.random() * gridSize);
                  
                  // Check if this position is valid for horizontal placement
                  let validPlacement = true;
                  for (let j = 0; j < currentWord.word.length; j++) {
                    if (grid[randomY][randomX + j] !== '') {
                      validPlacement = false;
                      break;
                    }
                  }
                  
                  if (validPlacement) {
                    activityData.words.push({
                      word: currentWord.word,
                      clue: currentWord.clue,
                      startX: randomX,
                      startY: randomY,
                      direction: 'across'
                    });
                    usedWords.add(currentWord.word);
                    
                    // Place the word on the grid
                    for (let j = 0; j < currentWord.word.length; j++) {
                      grid[randomY][randomX + j] = currentWord.word[j];
                    }
                    placedRandomly = true;
                  }
                }
              }
            }
          }
        }
        
        // Update display and refresh UI
        updateActivityDisplay();
        renderEditMode();
        
        alert(`Crossword generated for topic: ${topic}. ${activityData.words.length} words added.`);
      }, 1500); // Simulate API delay
    };
    
    // Function to remove a word from the crossword
    window.removeCrosswordWord = function(index) {
      if (activityData.words && activityData.words.length > index) {
        activityData.words.splice(index, 1);
        updateActivityDisplay();
        renderEditMode();
      }
    };
    
    // Function to update a crossword word property
    window.updateCrosswordWord = function(index, property, value) {
      if (activityData.words && activityData.words.length > index) {
        if (property === 'word') {
          // Ensure the word is uppercase and not empty
          const upperValue = value.toUpperCase();
          if (upperValue.trim() !== '') {
            activityData.words[index][property] = upperValue;
            // Update the activity display to save changes
            updateActivityDisplay();
          }
        } else {
          activityData.words[index][property] = value;
          // Update the activity display to save changes
          updateActivityDisplay();
        }
      }
    };
    
    // Function to update the grid size (now fixed at 10)
    window.updateCrosswordGridSize = function(size) {
      // Grid size is fixed at 10, so we don't update it
      // This function remains for compatibility but has no effect
    };
    
    // Function to highlight a word in the crossword
    window.highlightWord = function(word, direction, startX, startY) {
      // Remove previous highlights
      document.querySelectorAll('.crossword-cell').forEach(cell => {
        cell.style.backgroundColor = '';
        cell.style.color = '';
      });
      
      // Highlight the word
      for (let i = 0; i < word.length; i++) {
        let x, y;
        if (direction === 'across') {
          x = startX + i;
          y = startY;
        } else { // down
          x = startX;
          y = startY + i;
        }
        
        const cell = document.querySelector(`.crossword-cell[data-x="${x}"][data-y="${y}"]`);
        if (cell) {
          cell.style.backgroundColor = 'var(--primary)';
          cell.style.color = 'white';
          
          // Scroll to the first cell of the word
          if (i === 0) {
            cell.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      }
    };
    
    // Function to check crossword answers
    window.checkCrosswordAnswers = function() {
      if (!activityData.words || activityData.words.length === 0) {
        alert('No words to check in this crossword puzzle.');
        return;
      }
      
      const cells = document.querySelectorAll('.crossword-cell');
      let correctCount = 0;
      let totalCount = 0;
      
      // Reset all cells to default appearance
      cells.forEach(cell => {
        cell.style.backgroundColor = '';
        cell.style.color = '';
        cell.style.border = '1px solid var(--text)';
      });
      
      // Check each word in the crossword
      activityData.words.forEach(wordObj => {
        const { word, startX, startY, direction } = wordObj;
        let isCorrect = true;
        
        for (let i = 0; i < word.length; i++) {
          let x, y;
          if (direction === 'across') {
            x = startX + i;
            y = startY;
          } else { // down
            x = startX;
            y = startY + i;
          }
          
          const cell = document.querySelector(`.crossword-cell[data-x="${x}"][data-y="${y}"]`);
          if (cell) {
            totalCount++;
            const userLetter = cell.textContent.toUpperCase();
            const correctLetter = word[i];
            
            if (userLetter === correctLetter) {
              cell.style.backgroundColor = 'var(--success-bg)';
              cell.style.color = 'var(--success)';
              correctCount++;
            } else {
              cell.style.backgroundColor = 'var(--error-bg)';
              cell.style.color = 'var(--error)';
              isCorrect = false;
            }
          }
        }
        
        // Highlight the clue if the word is correct
        if (isCorrect) {
          const clues = direction === 'across' ? 
            document.querySelectorAll('.crossword-across .text-sm') : 
            document.querySelectorAll('.crossword-down .text-sm');
          
          clues.forEach(clue => {
            if (clue.textContent.includes(wordObj.clue)) {
              clue.style.color = 'var(--success)';
              clue.style.fontWeight = 'bold';
            }
          });
        }
      });
      
      // Show feedback
      const percentage = Math.round((correctCount / totalCount) * 100);
      alert(`You got ${correctCount} out of ${totalCount} letters correct (${percentage}%).`);
    };
    
    // Function to clear the crossword grid
    window.clearCrossword = function() {
      const cells = document.querySelectorAll('.crossword-cell');
      cells.forEach(cell => {
        cell.textContent = '';
        cell.style.backgroundColor = '';
        cell.style.color = '';
        cell.style.border = '1px solid var(--text)';
      });
      
      // Reset clue styles
      document.querySelectorAll('.crossword-clues .text-sm').forEach(clue => {
        clue.style.color = '';
        clue.style.fontWeight = '';
      });
    };
    
    // Timeline Play Mode
    window.renderTimelinePlayMode = function() {
      playArea.innerHTML = `
        <div class="card">
          <h4 class="text-xl font-bold mb-4">${activityData.description || 'Timeline'}</h4>
          <div class="relative">
            ${activityData.events.sort((a,b) => a.year - b.year).map(event => `
              <div class="flex items-center mb-6">
                <div class="w-20 h-20 rounded-full flex items-center justify-center font-bold text-white" style="background: ${event.color}">
                  ${event.year}
                </div>
                <div class="ml-6 flex-1 p-4 rounded-lg" style="background-color: var(--button-bg); border-left: 4px solid ${event.color}">
                  <h5 class="font-bold mb-2">${event.title}</h5>
                  <p class="text-sm text-muted">${event.description}</p>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    };
    
    window.renderTimelineEditMode = function() {
      editor.innerHTML += `
        <div class="card">
          <h4 class="text-lg font-bold mb-4">Timeline Events</h4>
          <p class="text-sm text-muted mb-4">Add events to your timeline</p>
          <button class="btn btn-primary" onclick="alert('Timeline editor - Add events here')">Add Event</button>
        </div>
      `;
    };
    
    // Matching Pairs Play Mode
    window.renderMatchingPairsPlayMode = function() {
      const shuffled = [...activityData.pairs, ...activityData.pairs].sort(() => Math.random() - 0.5);
      playArea.innerHTML = `
        <div class="card">
          <h4 class="text-xl font-bold mb-4">${activityData.description || 'Find Matching Pairs'}</h4>
          <div class="grid grid-cols-4 gap-4">
            ${shuffled.map((pair, i) => `
              <div class="card p-6 text-center cursor-pointer hover:bg-primary/10 transition-all" onclick="flipCard(${i})">
                <div class="card-front">?</div>
                <div class="card-back hidden">${pair.content}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    };
    
    window.renderMatchingPairsEditMode = function() {
      editor.innerHTML += `
        <div class="card">
          <h4 class="text-lg font-bold mb-4">Matching Pairs</h4>
          <p class="text-sm text-muted mb-4">Create pairs for the memory game</p>
          <button class="btn btn-primary" onclick="alert('Pairs editor - Add matching pairs here')">Add Pair</button>
        </div>
      `;
    };
    
    // Sorting Activity Play Mode
    window.renderSortingPlayMode = function() {
      playArea.innerHTML = `
        <div class="card">
          <h4 class="text-xl font-bold mb-4">${activityData.description || 'Sort Items'}</h4>
          <div class="grid grid-cols-3 gap-4 mb-6">
            ${activityData.categories.map(cat => `
              <div class="p-4 rounded-lg min-h-[200px]" style="background-color: ${cat.color}20; border: 2px dashed ${cat.color};">
                <h5 class="font-bold mb-3" style="color: ${cat.color}">${cat.name}</h5>
                <div class="space-y-2" id="category-${cat.name}"></div>
              </div>
            `).join('')}
          </div>
          <div class="space-y-2">
            <h5 class="font-bold mb-2">Items to Sort:</h5>
            ${activityData.items.map((item, i) => `
              <div class="btn btn-ghost" draggable="true">${item.text}</div>
            `).join('')}
          </div>
        </div>
      `;
    };
    
    window.renderSortingEditMode = function() {
      editor.innerHTML += `
        <div class="card">
          <h4 class="text-lg font-bold mb-4">Sorting Activity</h4>
          <p class="text-sm text-muted mb-4">Create categories and items to sort</p>
          <button class="btn btn-primary" onclick="alert('Sorting editor - Add categories and items')">Add Category</button>
        </div>
      `;
    };
    
    // Label Diagram Play Mode
    window.renderLabelDiagramPlayMode = function() {
      playArea.innerHTML = `
        <div class="card">
          <h4 class="text-xl font-bold mb-4">${activityData.description || 'Label the Diagram'}</h4>
          <div class="relative" style="background: url('${activityData.imageUrl}') center/cover; height: 600px; border-radius: 8px;">
            ${activityData.labels.map((label, i) => `
              <div class="absolute" style="left: ${label.x}%; top: ${label.y}%;">
                <button class="w-8 h-8 rounded-full bg-primary text-white font-bold" onclick="showLabel(${i})">${i+1}</button>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    };
    
    window.renderLabelDiagramEditMode = function() {
      editor.innerHTML += `
        <div class="card">
          <h4 class="text-lg font-bold mb-4">Label Diagram</h4>
          <p class="text-sm text-muted mb-4">Upload diagram and add labels</p>
          <button class="btn btn-primary" onclick="alert('Diagram editor - Add labels here')">Add Label</button>
        </div>
      `;
    };
    
    // Word Search Play Mode
    window.renderWordSearchPlayMode = function() {
      if (!activityData.words || activityData.words.length === 0) {
        playArea.innerHTML = '<div class="text-center py-12 text-muted">No words configured for this word search.</div>';
        return;
      }
      
      // Generate the word search grid
      const gridSize = activityData.gridSize || 15;
      const words = activityData.words || [];
      
      // Create empty grid
      let grid = Array(gridSize).fill().map(() => Array(gridSize).fill(''));
      
      // Place words in the grid
      words.forEach(word => {
        placeWordInGrid(grid, word.toUpperCase(), gridSize);
      });
      
      // Fill empty spaces with random letters
      for (let row = 0; row < gridSize; row++) {
        for (let col = 0; col < gridSize; col++) {
          if (grid[row][col] === '') {
            grid[row][col] = String.fromCharCode(65 + Math.floor(Math.random() * 26));
          }
        }
      }
      
      playArea.innerHTML = `
        <div class="card">
          <h4 class="text-xl font-bold mb-4">${activityData.description || 'Word Search'}</h4>
          <div class="grid" style="grid-template-columns: repeat(${gridSize}, 1fr); gap: 2px; max-width: 800px; margin: 0 auto;">
            ${grid.map((row, r) => 
              row.map((cell, c) => `
                <div class="w-8 h-8 border flex items-center justify-center font-bold cursor-pointer hover:bg-primary/20 word-cell" 
                     style="background-color: var(--button-bg); border: 1px solid var(--button-border);"
                     data-row="${r}" 
                     data-col="${c}" 
                     onclick="selectWordCell(${r}, ${c})">
                  ${cell}
                </div>
              `).join('')
            ).join('')}
          </div>
          <div class="mt-6">
            <h5 class="font-bold mb-2">Words to Find:</h5>
            <div class="flex flex-wrap gap-2">
              ${words.map(word => `
                <span class="pill word-item" id="word-${word.toLowerCase()}" style="background-color: var(--button-bg); border: 1px solid var(--button-border); padding: 0.5rem 1rem; border-radius: 9999px;">
                  ${word}
                </span>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    };
    
    // Helper function to place a word in the grid
    function placeWordInGrid(grid, word, gridSize) {
      const directions = [
        [0, 1],   // horizontal
        [1, 0],   // vertical
        [1, 1],   // diagonal down-right
        [-1, 1],  // diagonal up-right
        [0, -1],  // horizontal backwards
        [-1, 0],  // vertical backwards
        [-1, -1], // diagonal up-left
        [1, -1]   // diagonal down-left
      ];
      
      let placed = false;
      let attempts = 0;
      
      while (!placed && attempts < 100) {
        attempts++;
        
        // Random direction
        const [dx, dy] = directions[Math.floor(Math.random() * directions.length)];
        
        // Random starting position
        let startRow = Math.floor(Math.random() * gridSize);
        let startCol = Math.floor(Math.random() * gridSize);
        
        // Adjust starting position based on direction to ensure word fits
        if (dx > 0 && startRow + word.length > gridSize) continue;
        if (dx < 0 && startRow - word.length < -1) continue;
        if (dy > 0 && startCol + word.length > gridSize) continue;
        if (dy < 0 && startCol - word.length < -1) continue;
        
        // Check if word can be placed
        let canPlace = true;
        for (let i = 0; i < word.length; i++) {
          const row = startRow + i * dx;
          const col = startCol + i * dy;
          
          if (grid[row][col] !== '' && grid[row][col] !== word[i]) {
            canPlace = false;
            break;
          }
        }
        
        if (canPlace) {
          // Place the word
          for (let i = 0; i < word.length; i++) {
            const row = startRow + i * dx;
            const col = startCol + i * dy;
            grid[row][col] = word[i];
          }
          placed = true;
        }
      }
    };
    
    // Variables for word selection
    let selectedCells = [];
    let isSelecting = false;
    
    // Select word cell
    window.selectWordCell = function(row, col) {
      const cell = document.querySelector(`.word-cell[data-row="${row}"][data-col="${col}"]`);
      
      if (!isSelecting) {
        // Start selection
        isSelecting = true;
        selectedCells = [{row, col, element: cell}];
        cell.style.backgroundColor = 'var(--primary)';
        cell.style.color = 'white';
      } else {
        // End selection
        if (selectedCells.length === 1) {
          // If only one cell was selected, start a new selection
          selectedCells[0].element.style.backgroundColor = 'var(--button-bg)';
          selectedCells[0].element.style.color = 'inherit';
          selectedCells = [{row, col, element: cell}];
          cell.style.backgroundColor = 'var(--primary)';
          cell.style.color = 'white';
        } else {
          // Calculate direction and check if it matches a word
          const startCell = selectedCells[0];
          const endCell = {row, col, element: cell};
          
          // Calculate direction
          const dRow = endCell.row - startCell.row;
          const dCol = endCell.col - startCell.col;
          
          // Normalize direction
          const maxStep = Math.max(Math.abs(dRow), Math.abs(dCol));
          const stepRow = maxStep !== 0 ? dRow / maxStep : 0;
          const stepCol = maxStep !== 0 ? dCol / maxStep : 0;
          
          // Get the word from the grid
          let foundWord = '';
          for (let i = 0; i <= maxStep; i++) {
            const r = startCell.row + i * stepRow;
            const c = startCell.col + i * stepCol;
            const gridCell = document.querySelector(`.word-cell[data-row="${r}"][data-col="${c}"]`);
            if (gridCell) {
              foundWord += gridCell.textContent;
            }
          }
          
          // Check if the found word matches any of the target words
          const words = activityData.words || [];
          const matchedWord = words.find(w => 
            w.toUpperCase() === foundWord || 
            w.toUpperCase() === foundWord.split('').reverse().join('')
          );
          
          if (matchedWord) {
            // Word found - highlight all cells and mark word as found
            selectedCells.forEach(cell => {
              cell.element.style.backgroundColor = 'var(--success)';
              cell.element.style.color = 'white';
            });
            
            // Mark word as found
            const wordElement = document.getElementById(`word-${matchedWord.toLowerCase()}`);
            if (wordElement) {
              wordElement.style.textDecoration = 'line-through';
              wordElement.style.opacity = '0.6';
            }
            
            // Check if all words are found
            const remainingWords = document.querySelectorAll('.word-item:not([style*="line-through"])');
            if (remainingWords.length === 0) {
              // All words found
              setTimeout(() => {
                playArea.innerHTML += `<div class="text-center mt-6 text-xl font-bold text-success"> All words found! Great job!</div>`;
              }, 500);
            }
          } else {
            // Reset selection
            selectedCells.forEach(cell => {
              cell.element.style.backgroundColor = 'var(--button-bg)';
              cell.element.style.color = 'inherit';
            });
          }
          
          // Reset selection
          selectedCells = [];
          isSelecting = false;
        }
      }
    };
    
    window.renderWordSearchEditMode = function() {
      // Initialize activity data if it doesn't exist
      if (!activityData.words) activityData.words = [];
      if (!activityData.gridSize) activityData.gridSize = 15;
      if (!activityData.description) activityData.description = 'Word Search Puzzle';
      
      editor.innerHTML += `
        <div class="card mb-6">
          <h4 class="text-lg font-bold mb-4">Word Search Configuration</h4>
          
          <div class="mb-4">
            <label class="block text-sm text-muted mb-2">Title/Description</label>
            <input type="text" value="${activityData.description}" 
                   class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                   style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                   oninput="updateWordSearch('description', this.value)">
          </div>
          
          <div class="mb-4">
            <label class="block text-sm text-muted mb-2">Grid Size</label>
            <input type="number" value="${activityData.gridSize}" min="5" max="25" 
                   class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                   style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                   oninput="updateWordSearch('gridSize', parseInt(this.value))">
            <p class="text-xs text-muted mt-1">Recommended: 10-20 for best experience</p>
          </div>
        </div>
        
        <div class="card mb-6">
          <div class="flex justify-between items-center mb-4">
            <h4 class="text-lg font-bold">Words to Find</h4>
            <button class="btn btn-sm btn-accent" onclick="addWordSearchWord()">
              <i class="fas fa-plus mr-2"></i>
              Add Word
            </button>
          </div>
          
          <div id="wordsearch-words-list" class="space-y-3">
            ${activityData.words && activityData.words.length > 0 ? activityData.words.map((word, index) => `
              <div class="p-3 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border);">
                <div class="flex justify-between items-center mb-2">
                  <div class="font-bold">Word ${index + 1}</div>
                  <button class="btn btn-sm btn-error" onclick="removeWordSearchWord(${index})">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
                <input type="text" value="${word}" 
                       class="w-full px-3 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                       style="background-color: var(--card); border: 1px solid var(--card-border); color: var(--text);"
                       oninput="updateWordSearchWord(${index}, this.value)">
              </div>
            `).join('') : '<div class="text-center py-8 text-muted">No words added yet. Click "Add Word" to get started.</div>'}
          </div>
        </div>
        
        <div class="card">
          <h4 class="text-lg font-bold mb-4">Preview</h4>
          <div class="text-center text-sm text-muted p-8">
            Switch to Play Mode to see the generated word search puzzle
          </div>
        </div>
      `;
    };
    
    // Update word search settings
    window.updateWordSearch = function(field, value) {
      if (activityData) {
        activityData[field] = value;
      }
    };
    
    // Add word search word
    window.addWordSearchWord = function() {
      if (!activityData.words) activityData.words = [];
      activityData.words.push('NEWWORD');
      renderEditMode();
    };
    
    // Remove word search word
    window.removeWordSearchWord = function(index) {
      if (activityData.words && activityData.words[index] !== undefined) {
        activityData.words.splice(index, 1);
        renderEditMode();
      }
    };
    
    // Update word search word
    window.updateWordSearchWord = function(index, value) {
      if (activityData.words && activityData.words[index] !== undefined) {
        activityData.words[index] = value;
      }
    };
    
    // Survey Play Mode
    window.renderSurveyPlayMode = function() {
      if (!activityData.questions || activityData.questions.length === 0) {
        playArea.innerHTML = '<div class="text-center py-12 text-muted">No questions configured for this survey.</div>';
        return;
      }
      
      playArea.innerHTML = `
        <div class="card">
          <h4 class="text-xl font-bold mb-4">${activityData.description || 'Survey'}</h4>
          <form id="survey-form">
          ${activityData.questions.map((q, i) => `
            <div class="mb-6 p-4 rounded-lg" style="background-color: var(--drag-bg);">
              <label class="block font-bold mb-3">${i+1}. ${q.question}</label>
              ${q.type === 'rating' ? `
                <div class="flex gap-2">
                  ${Array(q.scale || 5).fill(0).map((_, j) => `
                    <button type="button" class="btn btn-ghost rating-btn" data-question="${i}" data-value="${j+1}" onclick="selectRating(${i}, ${j+1})">
                      ${''.repeat(j+1)}${''.repeat((q.scale || 5)-(j+1))} ${j+1}
                    </button>
                  `).join('')}
                </div>
                <div class="mt-2">
                  <span class="text-sm text-muted" id="rating-label-${i}">Select a rating</span>
                </div>
              ` : q.type === 'multiple' ? `
                <select class="w-full px-4 py-2 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" data-question="${i}" onchange="selectMultipleChoice(${i}, this.value)">
                  <option value="">Select an option...</option>
                  ${q.options.map((opt, optIndex) => `<option value="${optIndex}">${opt}</option>`).join('')}
                </select>
              ` : q.type === 'checkbox' ? `
                <div class="space-y-2">
                  ${q.options.map((opt, optIndex) => `
                    <div class="flex items-center">
                      <input type="checkbox" id="q${i}-opt${optIndex}" class="mr-2" data-question="${i}" data-option="${optIndex}" onchange="selectCheckbox(${i}, ${optIndex})">
                      <label for="q${i}-opt${optIndex}">${opt}</label>
                    </div>
                  `).join('')}
                </div>
              ` : `
                <textarea class="w-full px-4 py-2 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" rows="3" data-question="${i}" onchange="saveTextResponse(${i}, this.value)"></textarea>
              `}
            </div>
          `).join('')}
          <button type="button" class="btn btn-primary w-full" onclick="submitSurvey()">Submit Survey</button>
          </form>
        </div>
      `;
      
      // Initialize survey responses object
      if (!window.surveyResponses) window.surveyResponses = {};
      
      // Initialize responses for each question
      activityData.questions.forEach((q, i) => {
        window.surveyResponses[i] = null;
      });
    };
    
    // Variables to track survey responses
    window.surveyResponses = {};
    
    // Select rating for survey question
    window.selectRating = function(questionIndex, value) {
      // Update visual feedback
      const ratingButtons = document.querySelectorAll(`[data-question="${questionIndex}"].rating-btn`);
      ratingButtons.forEach(btn => {
        if (parseInt(btn.getAttribute('data-value')) <= value) {
          btn.classList.add('text-yellow-500', 'bg-yellow-100');
          btn.classList.remove('btn-ghost');
        } else {
          btn.classList.remove('text-yellow-500', 'bg-yellow-100');
          btn.classList.add('btn-ghost');
        }
      });
      
      // Update label
      const label = document.getElementById(`rating-label-${questionIndex}`);
      if (label) {
        label.textContent = `Selected: ${value} star${value > 1 ? 's' : ''}`;
      }
      
      // Save response
      window.surveyResponses[questionIndex] = value;
    };
    
    // Select multiple choice option
    window.selectMultipleChoice = function(questionIndex, value) {
      window.surveyResponses[questionIndex] = value;
    };
    
    // Select checkbox option
    window.selectCheckbox = function(questionIndex, optionIndex) {
      const checkbox = document.querySelector(`[data-question="${questionIndex}"][data-option="${optionIndex}"]`);
      if (checkbox) {
        if (!window.surveyResponses[questionIndex]) {
          window.surveyResponses[questionIndex] = [];
        }
        
        if (checkbox.checked) {
          window.surveyResponses[questionIndex].push(optionIndex);
        } else {
          window.surveyResponses[questionIndex] = window.surveyResponses[questionIndex].filter(opt => opt !== optionIndex);
        }
      }
    };
    
    // Save text response
    window.saveTextResponse = function(questionIndex, value) {
      window.surveyResponses[questionIndex] = value;
    };
    
    // Submit survey
    window.submitSurvey = function() {
      // Check if all required questions are answered
      let allAnswered = true;
      activityData.questions.forEach((q, i) => {
        if (window.surveyResponses[i] === null || window.surveyResponses[i] === undefined || 
            (Array.isArray(window.surveyResponses[i]) && window.surveyResponses[i].length === 0) ||
            (typeof window.surveyResponses[i] === 'string' && window.surveyResponses[i].trim() === '')) {
          allAnswered = false;
        }
      });
      
      if (!allAnswered) {
        alert('Please answer all questions before submitting.');
        return;
      }
      
      // Show success message
      playArea.innerHTML = `
        <div class="text-center py-12">
          <div class="text-2xl font-bold mb-4"> Thank You!</div>
          <div class="text-lg mb-6">Your survey has been submitted successfully.</div>
          <div class="text-sm text-muted">Responses have been recorded.</div>
        </div>
      `;
      
      // Reset responses
      window.surveyResponses = {};
    };
    
    window.renderSurveyEditMode = function() {
      // Initialize activity data if it doesn't exist
      if (!activityData.questions) activityData.questions = [];
      if (!activityData.description) activityData.description = 'Survey';
      
      editor.innerHTML += `
        <div class="card mb-6">
          <h4 class="text-lg font-bold mb-4">Survey Configuration</h4>
          
          <div class="mb-4">
            <label class="block text-sm text-muted mb-2">Title/Description</label>
            <input type="text" value="${activityData.description}" 
                   class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                   style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                   oninput="updateSurvey('description', this.value)">
          </div>
        </div>
        
        <div class="card mb-6">
          <div class="flex justify-between items-center mb-4">
            <h4 class="text-lg font-bold">Survey Questions</h4>
            <button class="btn btn-sm btn-accent" onclick="addSurveyQuestion()">
              <i class="fas fa-plus mr-2"></i>
              Add Question
            </button>
          </div>
          
          <div id="survey-questions-list" class="space-y-4">
            ${activityData.questions && activityData.questions.length > 0 ? activityData.questions.map((q, index) => `
              <div class="p-4 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border);">
                <div class="flex justify-between items-start mb-3">
                  <div class="font-bold">Question ${index + 1}</div>
                  <button class="btn btn-sm btn-error" onclick="removeSurveyQuestion(${index})">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
                
                <div class="mb-3">
                  <label class="block text-sm text-muted mb-2">Question Text</label>
                  <input type="text" value="${q.question || ''}" 
                         class="w-full px-3 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                         style="background-color: var(--card); border: 1px solid var(--card-border); color: var(--text);"
                         oninput="updateSurveyQuestion(${index}, 'question', this.value)">
                </div>
                
                <div class="mb-3">
                  <label class="block text-sm text-muted mb-2">Question Type</label>
                  <select class="w-full px-3 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                          style="background-color: var(--card); border: 1px solid var(--card-border); color: var(--text);"
                          onchange="updateSurveyQuestion(${index}, 'type', this.value)">
                    <option value="text" ${q.type === 'text' ? 'selected' : ''}>Text Response</option>
                    <option value="multiple" ${q.type === 'multiple' ? 'selected' : ''}>Multiple Choice</option>
                    <option value="checkbox" ${q.type === 'checkbox' ? 'selected' : ''}>Checkboxes</option>
                    <option value="rating" ${q.type === 'rating' ? 'selected' : ''}>Rating Scale</option>
                  </select>
                </div>
                
                ${q.type === 'multiple' || q.type === 'checkbox' ? `
                <div class="mb-3">
                  <label class="block text-sm text-muted mb-2">Options (one per line)</label>
                  <textarea class="w-full px-3 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                            style="background-color: var(--card); border: 1px solid var(--card-border); color: var(--text);" 
                            rows="4" 
                            onchange="updateSurveyQuestionOptions(${index}, this.value)">${q.options ? q.options.join('\n') : ''}</textarea>
                </div>
                ` : ''}
                
                ${q.type === 'rating' ? `
                <div class="mb-3">
                  <label class="block text-sm text-muted mb-2">Scale (number of stars)</label>
                  <input type="number" value="${q.scale || 5}" min="3" max="10" 
                         class="w-full px-3 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                         style="background-color: var(--card); border: 1px solid var(--card-border); color: var(--text);"
                         oninput="updateSurveyQuestion(${index}, 'scale', parseInt(this.value))">
                </div>
                ` : ''}
              </div>
            `).join('') : '<div class="text-center py-8 text-muted">No questions added yet. Click "Add Question" to get started.</div>'}
          </div>
        </div>
        
        <div class="card">
          <h4 class="text-lg font-bold mb-4">Preview</h4>
          <div class="text-center text-sm text-muted p-8">
            Switch to Play Mode to test the survey
          </div>
        </div>
      `;
    };
    
    // Update survey settings
    window.updateSurvey = function(field, value) {
      if (activityData) {
        activityData[field] = value;
      }
    };
    
    // Add survey question
    window.addSurveyQuestion = function() {
      if (!activityData.questions) activityData.questions = [];
      activityData.questions.push({
        question: 'New survey question?',
        type: 'text',
        options: ['Option 1', 'Option 2', 'Option 3'],
        scale: 5
      });
      renderEditMode();
    };
    
    // Remove survey question
    window.removeSurveyQuestion = function(index) {
      if (activityData.questions && activityData.questions[index] !== undefined) {
        activityData.questions.splice(index, 1);
        renderEditMode();
      }
    };
    
    // Update survey question
    window.updateSurveyQuestion = function(index, field, value) {
      if (activityData.questions && activityData.questions[index] !== undefined) {
        activityData.questions[index][field] = value;
      }
    };
    
    // Update survey question options
    window.updateSurveyQuestionOptions = function(index, value) {
      if (activityData.questions && activityData.questions[index] !== undefined) {
        activityData.questions[index].options = value.split('\n').filter(opt => opt.trim() !== '');
      }
    };
    
    // Accordion FAQ Play Mode
    window.renderAccordionPlayMode = function() {
      if (!activityData.items || activityData.items.length === 0) {
        playArea.innerHTML = '<div class="text-center py-12 text-muted">No items configured for this accordion.</div>';
        return;
      }
      
      playArea.innerHTML = `
        <div class="card">
          <h4 class="text-xl font-bold mb-4">${activityData.description || 'FAQ'}</h4>
          ${activityData.items.map((item, i) => `
            <div class="mb-2">
              <button class="w-full text-left p-4 rounded-lg font-bold hover:bg-primary/10 transition-all accordion-header" style="background-color: var(--button-bg); border: 1px solid var(--button-border);" onclick="toggleAccordionItem(${i})">
                <i class="fas fa-chevron-down mr-2" id="accordion-icon-${i}"></i>${item.question}
              </button>
              <div id="accordion-${i}" class="hidden p-4 rounded-lg mt-1" style="background-color: var(--drag-bg);">
                ${item.answer}
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      // Initialize all accordion items as closed
      activityData.items.forEach((_, i) => {
        const panel = document.getElementById(`accordion-${i}`);
        if (panel) panel.classList.add('hidden');
      });
    };
    
    // Toggle accordion item
    window.toggleAccordionItem = function(index) {
      const panel = document.getElementById(`accordion-${index}`);
      const icon = document.getElementById(`accordion-icon-${index}`);
      
      if (panel) {
        if (panel.classList.contains('hidden')) {
          panel.classList.remove('hidden');
          if (icon) icon.className = 'fas fa-chevron-up mr-2';
        } else {
          panel.classList.add('hidden');
          if (icon) icon.className = 'fas fa-chevron-down mr-2';
        }
      }
    };
    
    window.renderAccordionEditMode = function() {
      // Initialize activity data if it doesn't exist
      if (!activityData.items) activityData.items = [];
      if (!activityData.description) activityData.description = 'FAQ';
      
      editor.innerHTML += `
        <div class="card mb-6">
          <h4 class="text-lg font-bold mb-4">Accordion Configuration</h4>
          
          <div class="mb-4">
            <label class="block text-sm text-muted mb-2">Title/Description</label>
            <input type="text" value="${activityData.description}" 
                   class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                   style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                   oninput="updateAccordion('description', this.value)">
          </div>
        </div>
        
        <div class="card mb-6">
          <div class="flex justify-between items-center mb-4">
            <h4 class="text-lg font-bold">Accordion Items</h4>
            <button class="btn btn-sm btn-accent" onclick="addAccordionItem()">
              <i class="fas fa-plus mr-2"></i>
              Add Item
            </button>
          </div>
          
          <div id="accordion-items-list" class="space-y-4">
            ${activityData.items && activityData.items.length > 0 ? activityData.items.map((item, index) => `
              <div class="p-4 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border);">
                <div class="flex justify-between items-start mb-3">
                  <div class="font-bold">Item ${index + 1}</div>
                  <button class="btn btn-sm btn-error" onclick="removeAccordionItem(${index})">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
                
                <div class="mb-3">
                  <label class="block text-sm text-muted mb-2">Question/Title</label>
                  <input type="text" value="${item.question || ''}" 
                         class="w-full px-3 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                         style="background-color: var(--card); border: 1px solid var(--card-border); color: var(--text);"
                         oninput="updateAccordionItem(${index}, 'question', this.value)">
                </div>
                
                <div class="mb-3">
                  <label class="block text-sm text-muted mb-2">Answer/Content</label>
                  <textarea class="w-full px-3 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                            style="background-color: var(--card); border: 1px solid var(--card-border); color: var(--text);" 
                            rows="4" 
                            oninput="updateAccordionItem(${index}, 'answer', this.value)">${item.answer || ''}</textarea>
                </div>
              </div>
            `).join('') : '<div class="text-center py-8 text-muted">No items added yet. Click "Add Item" to get started.</div>'}
          </div>
        </div>
        
        <div class="card">
          <h4 class="text-lg font-bold mb-4">Preview</h4>
          <div class="text-center text-sm text-muted p-8">
            Switch to Play Mode to test the accordion
          </div>
        </div>
      `;
    };
    
    // Update accordion settings
    window.updateAccordion = function(field, value) {
      if (activityData) {
        activityData[field] = value;
      }
    };
    
    // Add accordion item
    window.addAccordionItem = function() {
      if (!activityData.items) activityData.items = [];
      activityData.items.push({
        question: 'New question?',
        answer: 'New answer here...'
      });
      renderEditMode();
    };
    
    // Remove accordion item
    window.removeAccordionItem = function(index) {
      if (activityData.items && activityData.items[index] !== undefined) {
        activityData.items.splice(index, 1);
        renderEditMode();
      }
    };
    
    // Update accordion item
    window.updateAccordionItem = function(index, field, value) {
      if (activityData.items && activityData.items[index] !== undefined) {
        activityData.items[index][field] = value;
      }
    };
    
    // Image Hotspot Play Mode
    window.renderImageHotspotPlayMode = function() {
      playArea.innerHTML = `
        <div class="card">
          <h4 class="text-xl font-bold mb-4">${activityData.title || 'Interactive Image Hotspots'}</h4>
          <div class="relative" style="background: url('${activityData.imageUrl}') center/cover; height: 600px; border-radius: 8px; border: 1px solid var(--card-border);">
            ${activityData.hotspots.map((spot, i) => `
              <div class="absolute transform -translate-x-1/2 -translate-y-1/2" style="left: ${spot.x}%; top: ${spot.y}%">
                <button class="w-8 h-8 rounded-full bg-primary text-white hover:scale-110 transition-all flex items-center justify-center shadow-lg" 
                        style="border: 2px solid white;" 
                        onclick="showHotspot(${i})" 
                        title="${spot.title || 'Hotspot ' + (i+1)}">
                  <i class="fas fa-${spot.icon || 'info'} text-xs"></i>
                </button>
              </div>
            `).join('')}
          </div>
          <div id="hotspot-info" class="mt-4 p-4 rounded-lg hidden" style="background-color: var(--card); border: 1px solid var(--card-border);">
            <h5 class="font-bold mb-2 text-lg" id="hotspot-title"></h5>
            <p class="text-sm" id="hotspot-desc"></p>
          </div>
        </div>
      `;
    };
    
    window.renderImageHotspotEditMode = function() {
      // Initialize activity data if it doesn't exist
      if (!activityData.imageUrl) {
        activityData.imageUrl = 'https://via.placeholder.com/800x600?text=Upload+Your+Image';
      }
      if (!activityData.hotspots) {
        activityData.hotspots = [
          {x: 25, y: 30, title: 'Hotspot 1', description: 'Information about this area', icon: 'info'},
          {x: 60, y: 50, title: 'Hotspot 2', description: 'Details about this feature', icon: 'star'},
          {x: 80, y: 70, title: 'Hotspot 3', description: 'Learn more here', icon: 'question'}
        ];
      }
      
      editor.innerHTML += '<div class="card">' +
        '<h4 class="text-lg font-bold mb-4">Image Hotspots Editor</h4>' +
        '<p class="text-sm text-muted mb-4">Upload image and add interactive hotspots</p>' +
        
        '<div class="mb-4">' +
          '<label class="block text-sm text-muted mb-2">Image URL</label>' +
          '<input type="text" ' +
                 'id="imagehotspot-url" ' +
                 'value="' + activityData.imageUrl + '" ' +
                 'class="w-full px-4 py-2 rounded-lg mb-2" ' +
                 'style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" ' +
                 'placeholder="Enter image URL" ' +
                 'onchange="updateImageHotspotUrl(this.value)">' +
          '<label class="block text-sm text-muted mb-2">Or Upload Image</label>' +
          '<input type="file" ' +
                 'id="imagehotspot-upload" ' +
                 'accept="image/*" ' +
                 'class="w-full px-4 py-2 rounded-lg" ' +
                 'style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);" ' +
                 'onchange="uploadImageHotspotFile(this)">' +
        '</div>' +
        
        '<div class="mb-4">' +
          '<label class="block text-sm text-muted mb-2">Image Preview</label>' +
          '<div class="relative" id="imagehotspot-preview" style="background: url(\'' + activityData.imageUrl + '\') center/cover; height: 400px; border-radius: 8px; border: 1px solid var(--card-border); position: relative;">' +
            (activityData.hotspots ? activityData.hotspots.map((spot, i) => 
              '<div class="absolute transform -translate-x-1/2 -translate-y-1/2" style="left: ' + spot.x + '%; top: ' + spot.y + '%">' +
                '<button class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center shadow-lg" ' +
                        'style="border: 2px solid white;" ' +
                        'onclick="editHotspot(' + i + ')" ' +
                        'title="' + (spot.title || 'Hotspot ' + (i+1)) + '">' +
                  '<i class="fas fa-' + (spot.icon || 'info') + ' text-xs"></i>' +
                '</button>' +
              '</div>'
            ).join('') : '') +
            '<div id="new-hotspot-marker" class="absolute hidden transform -translate-x-1/2 -translate-y-1/2" style="border: 2px dashed var(--primary); width: 20px; height: 20px;">' +
              '<div class="w-full h-full rounded-full bg-primary/20 flex items-center justify-center">' +
                '<i class="fas fa-plus text-primary"></i>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<p class="text-xs text-muted mt-2">Click on the image to add a new hotspot, or click existing hotspots to edit them</p>' +
        '</div>' +
        
        '<div class="mb-4">' +
          '<button class="btn btn-primary" onclick="addNewHotspot()">' +
            '<i class="fas fa-plus mr-2"></i>' +
            'Add New Hotspot' +
          '</button>' +
          '<button class="btn btn-secondary ml-2" onclick="document.getElementById(\'new-hotspot-marker\').classList.toggle(\'hidden\')">' +
            '<i class="fas fa-map-marker mr-2"></i>' +
            'Toggle Marker' +
          '</button>' +
        '</div>' +
        
        '<div id="hotspot-editor" class="mb-4 p-4 rounded-lg" style="background-color: var(--card); display: none;">' +
          '<h5 class="font-bold mb-3">Edit Hotspot</h5>' +
          '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">' +
            '<div>' +
              '<label class="block text-sm text-muted mb-2">Title</label>' +
              '<input type="text" id="hotspot-title" class="w-full px-3 py-2 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">' +
            '</div>' +
            '<div>' +
              '<label class="block text-sm text-muted mb-2">Icon</label>' +
              '<select id="hotspot-icon" class="w-full px-3 py-2 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">' +
                '<option value="info">Info</option>' +
                '<option value="question">Question</option>' +
                '<option value="star">Star</option>' +
                '<option value="exclamation">Exclamation</option>' +
                '<option value="lightbulb">Lightbulb</option>' +
                '<option value="book">Book</option>' +
                '<option value="check">Check</option>' +
                '<option value="plus">Plus</option>' +
              '</select>' +
            '</div>' +
            '<div class="md:col-span-2">' +
              '<label class="block text-sm text-muted mb-2">Description</label>' +
              '<textarea id="hotspot-description" class="w-full px-3 py-2 rounded-lg" rows="3" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"></textarea>' +
            '</div>' +
          '</div>' +
          '<div class="flex gap-2 mt-3">' +
            '<button class="btn btn-primary" onclick="saveHotspot()">Save</button>' +
            '<button class="btn btn-ghost" onclick="cancelHotspotEdit()">Cancel</button>' +
            '<button class="btn btn-danger ml-auto" onclick="deleteCurrentHotspot()">Delete</button>' +
          '</div>' +
          '<input type="hidden" id="current-hotspot-index">' +
        '</div>' +
        
        '<div id="hotspots-list" class="mt-4">' +
          '<h5 class="font-bold mb-3">Hotspots</h5>' +
          (activityData.hotspots ? activityData.hotspots.map((spot, i) => 
            '<div class="card p-3 mb-2 flex justify-between items-center">' +
              '<div>' +
                '<div class="font-bold">' + spot.title + '</div>' +
                '<div class="text-xs text-muted">' + (spot.description.substring(0, 50) + (spot.description.length > 50 ? '...' : '')) + '</div>' +
              '</div>' +
              '<div class="flex gap-2">' +
                '<button class="btn btn-sm btn-ghost" onclick="editHotspot(' + i + ')">' +
                  '<i class="fas fa-edit"></i>' +
                '</button>' +
                '<button class="btn btn-sm btn-ghost" onclick="removeHotspot(' + i + ')">' +
                  '<i class="fas fa-trash"></i>' +
                '</button>' +
              '</div>' +
            '</div>'
          ).join('') : '') +
        '</div>' +
      '</div>';
      
      // Add click event to the image for adding new hotspots
      const imageContainer = document.getElementById('imagehotspot-preview');
      if (imageContainer) {
        imageContainer.onclick = function(e) {
          if (e.target !== this && !e.target.closest('.w-8.h-8')) {
            const rect = this.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            
            // Show the marker at the clicked position
            const marker = document.getElementById('new-hotspot-marker');
            marker.style.left = x + '%';
            marker.style.top = y + '%';
            marker.classList.remove('hidden');
            
            // Ask for hotspot details
            setTimeout(() => {
              const title = prompt('Enter hotspot title:');
              if (title) {
                const description = prompt('Enter hotspot description:');
                if (description !== null) {
                  const icon = prompt('Enter icon name (info, question, star, etc.):', 'info');
                  addHotspotAtPosition(x, y, title, description, icon || 'info');
                  marker.classList.add('hidden');
                }
              }
            }, 300);
          }
        };
      }
    };
    
    // Theme customization functions
    let currentThemeModal = null;
    
    window.applyTemplateTheme = function(themeData) {
      try {
        // Apply theme to the current activity
        if (!activityData || !activityData.theme) {
          if (!activityData) activityData = {};
          activityData.theme = {};
        }
        
        // Merge new theme data with existing
        Object.assign(activityData.theme, themeData);
        
        // Update CSS variables if possible
        const styleElement = document.createElement('style');
        styleElement.id = 'template-theme-styles';
        styleElement.textContent = `
          #play-area > div, #editor {
            ${themeData.backgroundColor ? `background-color: ${themeData.backgroundColor} !important;` : ''}
            ${themeData.textColor ? `color: ${themeData.textColor} !important;` : ''}
            ${themeData.fontFamily ? `font-family: ${themeData.fontFamily} !important;` : ''}
          }
          
          #play-area .card, #editor .card {
            ${themeData.cardBackgroundColor ? `background-color: ${themeData.cardBackgroundColor} !important;` : ''}
            ${themeData.cardBorderColor ? `border-color: ${themeData.cardBorderColor} !important;` : ''}
          }
          
          #play-area .btn, #editor .btn {
            ${themeData.buttonColor ? `background-color: ${themeData.buttonColor} !important;` : ''}
            ${themeData.buttonTextColor ? `color: ${themeData.buttonTextColor} !important;` : ''}
          }
        `;
        
        // Remove existing theme styles
        const existingStyles = document.getElementById('template-theme-styles');
        if (existingStyles) existingStyles.remove();
        
        // Add new theme styles
        document.head.appendChild(styleElement);
      } catch (error) {
        console.error('Error in applyTemplateTheme:', error);
      }
    };
    
    window.openThemeCustomizer = function() {
      // Create theme customization modal
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
      modal.id = 'theme-customizer-modal'; // Add an ID for easier reference
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto" style="background-color: var(--background); color: var(--text); border: 1px solid var(--divider);">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">Template Theme Customization</h3>
            <button onclick="closeThemeCustomizer()" class="text-gray-500 hover:text-gray-700">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-muted mb-2">Background Color</label>
              <input type="color" id="theme-bg-color" class="w-full h-10" value="${activityData.theme?.backgroundColor || '#ffffff'}">
            </div>
            
            <div>
              <label class="block text-sm text-muted mb-2">Text Color</label>
              <input type="color" id="theme-text-color" class="w-full h-10" value="${activityData.theme?.textColor || '#000000'}">
            </div>
            
            <div>
              <label class="block text-sm text-muted mb-2">Card Background</label>
              <input type="color" id="theme-card-bg" class="w-full h-10" value="${activityData.theme?.cardBackgroundColor || '#f8f9fa'}">
            </div>
            
            <div>
              <label class="block text-sm text-muted mb-2">Card Border Color</label>
              <input type="color" id="theme-card-border" class="w-full h-10" value="${activityData.theme?.cardBorderColor || '#dee2e6'}">
            </div>
            
            <div>
              <label class="block text-sm text-muted mb-2">Button Color</label>
              <input type="color" id="theme-button-color" class="w-full h-10" value="${activityData.theme?.buttonColor || '#0ea5e9'}">
            </div>
            
            <div>
              <label class="block text-sm text-muted mb-2">Button Text Color</label>
              <input type="color" id="theme-button-text" class="w-full h-10" value="${activityData.theme?.buttonTextColor || '#ffffff'}">
            </div>
            
            <div>
              <label class="block text-sm text-muted mb-2">Font Family</label>
              <select id="theme-font-family" class="w-full px-3 py-2 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);">
                <option value="Arial, sans-serif" ${activityData.theme?.fontFamily === 'Arial, sans-serif' ? 'selected' : ''}>Arial</option>
                <option value="'Times New Roman', serif" ${activityData.theme?.fontFamily === 'Times New Roman, serif' ? 'selected' : ''}>Times New Roman</option>
                <option value="'Courier New', monospace" ${activityData.theme?.fontFamily === 'Courier New, monospace' ? 'selected' : ''}>Courier New</option>
                <option value="Georgia, serif" ${activityData.theme?.fontFamily === 'Georgia, serif' ? 'selected' : ''}>Georgia</option>
                <option value="Verdana, sans-serif" ${activityData.theme?.fontFamily === 'Verdana, sans-serif' ? 'selected' : ''}>Verdana</option>
              </select>
            </div>
            
            <div class="flex gap-2 mt-6">
              <button class="btn btn-primary flex-1" onclick="saveThemeCustomization()">Apply Theme</button>
              <button class="btn btn-ghost flex-1" onclick="resetTemplateTheme()">Reset</button>
            </div>
          </div>
        </div>
      `;
      
      // Store reference to the modal
      currentThemeModal = modal;
      document.body.appendChild(modal);
    };
    
    window.closeThemeCustomizer = function() {
      // Try to use the stored reference first
      if (currentThemeModal) {
        currentThemeModal.remove();
        currentThemeModal = null; // Clear the reference
        return;
      }
      
      // Fallback: try to find by ID
      let modal = document.getElementById('theme-customizer-modal');
      if (modal) {
        modal.remove();
        currentThemeModal = null; // Clear the reference if it was somehow different
        return;
      }
      
      // Fallback: try to find by class
      modal = document.querySelector('.fixed.inset-0.bg-black\/50');
      if (modal && modal.innerHTML && modal.innerHTML.includes('Template Theme Customization')) {
        modal.remove();
        currentThemeModal = null;
        return;
      }
      
      // Final fallback: find by content
      const allDivs = document.querySelectorAll('div');
      for (let div of allDivs) {
        if (div.innerHTML && div.innerHTML.includes('Template Theme Customization')) {
          div.remove();
          currentThemeModal = null;
          break;
        }
      }
    };
    
    window.saveThemeCustomization = function() {
      try {
        const themeData = {
          backgroundColor: document.getElementById('theme-bg-color').value,
          textColor: document.getElementById('theme-text-color').value,
          cardBackgroundColor: document.getElementById('theme-card-bg').value,
          cardBorderColor: document.getElementById('theme-card-border').value,
          buttonColor: document.getElementById('theme-button-color').value,
          buttonTextColor: document.getElementById('theme-button-text').value,
          fontFamily: document.getElementById('theme-font-family').value
        };
        
        console.log('Applying theme data:', themeData);
        applyTemplateTheme(themeData);
        updateActivityDisplay();
        console.log('Theme applied, attempting to close modal');
        closeThemeCustomizer();
        console.log('Modal close function called');
      } catch (error) {
        console.error('Error in saveThemeCustomization:', error);
        // Ensure modal is closed even if there's an error
        closeThemeCustomizer();
      }
    };
    
    window.resetTemplateTheme = function() {
      try {
        activityData.theme = {};
        applyTemplateTheme({});
        updateActivityDisplay();
        closeThemeCustomizer();
      } catch (error) {
        console.error('Error in resetTemplateTheme:', error);
        // Ensure modal is closed even if there's an error
        closeThemeCustomizer();
      }
    };
    
    // Audio/sound management functions
    let audioEnabled = true;
    let audioContext;
    
    // Initialize audio context
    function initAudioContext() {
      if (!audioContext && typeof AudioContext !== 'undefined') {
        audioContext = new AudioContext();
      }
    }
    
    // Play sound effect
    window.playSound = function(type) {
      if (!audioEnabled) return;
      
      initAudioContext();
      
      try {
        // Create a simple beep sound
        if (audioContext) {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.type = 'sine';
          
          if (type === 'correct') {
            oscillator.frequency.value = 800; // Higher pitch for correct
            gainNode.gain.value = 0.3;
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.1); // Short beep
          } else if (type === 'incorrect') {
            oscillator.frequency.value = 400; // Lower pitch for incorrect
            gainNode.gain.value = 0.3;
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.15); // Slightly longer beep
          } else {
            oscillator.frequency.value = 600; // Default sound
            gainNode.gain.value = 0.2;
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.05);
          }
        }
      } catch (e) {
        console.log('Audio playback not supported or blocked:', e);
        // Fallback: just log the sound attempt
      }
    };
    
    // Toggle sound on/off
    window.toggleSound = function() {
      audioEnabled = !audioEnabled;
      
      // Update the sound toggle button UI
      const soundBtn = document.querySelector('.sound-toggle-btn');
      if (soundBtn) {
        soundBtn.innerHTML = audioEnabled ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
        soundBtn.title = audioEnabled ? 'Mute Sound' : 'Unmute Sound';
      }
      
      // Show feedback message
      const feedback = document.createElement('div');
      feedback.className = 'fixed top-4 right-4 bg-primary text-white px-4 py-2 rounded-lg shadow-lg z-50';
      feedback.textContent = audioEnabled ? 'Sound enabled' : 'Sound muted';
      document.body.appendChild(feedback);
      
      setTimeout(() => {
        feedback.remove();
      }, 2000);
    };
    
    // Helper functions for new templates
    window.toggleAccordion = function(index) {
      const panel = document.getElementById(`accordion-${index}`);
      const icon = document.getElementById(`accordion-icon-${index}`);
      
      if (panel) {
        if (panel.classList.contains('hidden')) {
          panel.classList.remove('hidden');
          if (icon) icon.className = 'fas fa-chevron-up mr-2';
        } else {
          panel.classList.add('hidden');
          if (icon) icon.className = 'fas fa-chevron-down mr-2';
        }
      }
    };
    
    window.showHotspot = function(index) {
      const info = document.getElementById('hotspot-info');
      const title = document.getElementById('hotspot-title');
      const desc = document.getElementById('hotspot-desc');
      const spot = activityData.hotspots[index];
      
      title.textContent = spot.title;
      desc.textContent = spot.description;
      info.classList.remove('hidden');
    };
    
    window.updateImageHotspotUrl = function(url) {
      activityData.imageUrl = url;
      updateActivityDisplay();
      renderEditMode();
    };
    
    window.uploadImageHotspotFile = function(input) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          activityData.imageUrl = e.target.result;
          updateActivityDisplay();
          renderEditMode();
        };
        reader.readAsDataURL(file);
      }
    };
    
    window.addNewHotspot = function() {
      alert('Please click on the image where you want to place the new hotspot.');
      // The actual hotspot creation will happen in the image click handler
      // This function just provides instructions to the user
    };
    
    window.addHotspotAtPosition = function(x, y, title, description, icon) {
      if (!activityData.hotspots) activityData.hotspots = [];
      activityData.hotspots.push({
        x: x,
        y: y,
        title: title,
        description: description,
        icon: icon
      });
      updateActivityDisplay();
      renderEditMode();
    };
    
    window.editHotspot = function(index) {
      const hotspot = activityData.hotspots[index];
      
      document.getElementById('hotspot-title').value = hotspot.title;
      document.getElementById('hotspot-description').value = hotspot.description;
      document.getElementById('hotspot-icon').value = hotspot.icon;
      document.getElementById('current-hotspot-index').value = index;
      
      document.getElementById('hotspot-editor').style.display = 'block';
    };
    
    window.saveHotspot = function() {
      const index = parseInt(document.getElementById('current-hotspot-index').value);
      if (index >= 0 && index < activityData.hotspots.length) {
        activityData.hotspots[index].title = document.getElementById('hotspot-title').value;
        activityData.hotspots[index].description = document.getElementById('hotspot-description').value;
        activityData.hotspots[index].icon = document.getElementById('hotspot-icon').value;
        
        updateActivityDisplay();
        renderEditMode();
        cancelHotspotEdit();
      }
    };
    
    window.cancelHotspotEdit = function() {
      document.getElementById('hotspot-editor').style.display = 'none';
      document.getElementById('current-hotspot-index').value = '';
    };
    
    window.deleteCurrentHotspot = function() {
      const index = parseInt(document.getElementById('current-hotspot-index').value);
      if (index >= 0 && index < activityData.hotspots.length) {
        if (confirm('Are you sure you want to delete this hotspot?')) {
          activityData.hotspots.splice(index, 1);
          updateActivityDisplay();
          renderEditMode();
          cancelHotspotEdit();
        }
      }
    };
    
    window.removeHotspot = function(index) {
      if (confirm('Are you sure you want to remove this hotspot?')) {
        activityData.hotspots.splice(index, 1);
        updateActivityDisplay();
        renderEditMode();
      }
    };
    
    // ===== End NEW TEMPLATES RENDER FUNCTIONS =====
    
    // ===== Interactive Video Functions =====
    
    let videoPlayer = null;
    let currentQuestionIndex = 0;
    let videoScore = 0;
    let questionsAnswered = [];
    let checkInterval = null;
    
    // Interactive Video Play Mode
    
    window.renderInteractiveVideoPlayMode = function() {
      if (!activityData.videoUrl) {
        playArea.innerHTML = '<div class="text-center py-12 text-muted">No video configured.</div>';
        return;
      }
      
      // Reset state
      currentQuestionIndex = 0;
      videoScore = 0;
      questionsAnswered = [];
      
      const container = document.createElement('div');
      container.className = 'interactive-video-container';
      container.innerHTML = `
        <div class="mb-4 p-4 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border);">
          <p class="text-sm text-muted">${activityData.description || 'Interactive Video Lesson'}</p>
        </div>
              
        <div class="relative rounded-lg overflow-hidden mb-4" style="background-color: var(--background); border: 2px solid var(--card-border);">
          <iframe 
            id="video-player"
            src="${getEmbedUrl(activityData.videoUrl)}"
            style="width: 100%; height: 500px; border: none;"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
            title="${activityData.title || 'Interactive Video'}"
          ></iframe>
                  
          <!-- Video Question Overlay - Positioned on top of video -->
          <div id="video-question-area" class="video-question-overlay hidden" style="max-width: 600px;">
            <div class="text-lg font-bold mb-4" id="question-text">Which statement is correct?</div>
            <div id="question-options" class="space-y-3">
              <button class="w-full p-3 rounded-lg border-2 border-white/30 hover:border-white/60 hover:bg-white/10 transition-all text-left video-option" onclick="answerVideoQuestion(0)">
                A. Plants produce oxygen
              </button>
              <button class="w-full p-3 rounded-lg border-2 border-white/30 hover:border-white/60 hover:bg-white/10 transition-all text-left video-option" onclick="answerVideoQuestion(1)">
                B. Plants produce carbon dioxide
              </button>
              <button class="w-full p-3 rounded-lg border-2 border-white/30 hover:border-white/60 hover:bg-white/10 transition-all text-left video-option" onclick="answerVideoQuestion(2)">
                C. Plants don't breathe
              </button>
            </div>
            <div id="video-feedback" class="mt-4 p-3 rounded-lg hidden" style="background-color: var(--success-bg); border: 2px solid var(--success); color: var(--success);"> <strong>Correct!</strong> Great job!</div>
          </div>
        </div>
              
        <div class="flex justify-between items-center p-4 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border);">
          <div class="flex gap-4">
            <div class="pill">Progress: <span id="video-progress" class="text-accent font-bold">0</span>/${activityData.questions ? activityData.questions.length : 0}</div>
            <div class="pill">Score: <span id="video-score" class="text-success font-bold">0</span>/${activityData.questions ? activityData.questions.length : 0}</div>
          </div>
          <div class="text-xs text-muted">Questions appear automatically at specific timestamps</div>
        </div>`;
      
      playArea.innerHTML = '';
      playArea.appendChild(container);
      
      // Note: Actual YouTube API integration would require additional setup
      // This is a simplified version that shows the concept
      
      if (playControls) {
        playControls.innerHTML = `
          <button class="btn btn-primary" onclick="toggleVideoFullscreen()">
            <div class="icon-fullscreen mr-2"></div>
            Fullscreen
          </button>
          <button class="btn btn-ghost" onclick="resetVideoActivity()">
            <i class="fas fa-redo mr-2"></i>
            Restart
          </button>
        `;
      }
      
      // Initialize video player for pausing functionality
      const videoPlayer = document.getElementById('video-player');
      
      // Function to check if it's time to show a question based on video progress
      function checkVideoTime() {
        if (!activityData.questions || currentQuestionIndex >= activityData.questions.length) {
          clearInterval(checkInterval);
          return;
        }
        
        const currentQuestion = activityData.questions[currentQuestionIndex];
        const timestamp = currentQuestion.timestamp || 5; // Default to 5 seconds if no timestamp
        
        // In a real implementation, we'd get the actual video time
        // For demo, we'll simulate based on elapsed time
        const elapsed = (Date.now() - startTime) / 1000; // seconds since start
        
        if (elapsed >= timestamp && !questionsAnswered.includes(currentQuestionIndex)) {
          showNextVideoQuestion();
        }
      }
      
      const startTime = Date.now();
      
      // Start checking for questions
      checkInterval = setInterval(checkVideoTime, 1000); // Check every second
      
      // Also trigger initial check after 5 seconds as backup
      setTimeout(() => {
        if (currentQuestionIndex < (activityData.questions?.length || 0)) {
          showNextVideoQuestion();
        }
      }, 5000);
    };
    
    // Show next video question
    window.showNextVideoQuestion = function() {
      if (!activityData.questions || currentQuestionIndex >= activityData.questions.length) {
        showVideoCompletion();
        return;
      }
      
      const question = activityData.questions[currentQuestionIndex];
      const questionArea = document.getElementById('video-question-area');
      const questionText = document.getElementById('question-text');
      const questionOptions = document.getElementById('question-options');
      
      if (!questionArea || !questionText || !questionOptions) return;
      
      questionText.textContent = question.question;
      questionOptions.innerHTML = question.options.map((option, index) => `
        <button class="w-full p-3 rounded-lg border-2 border-white/30 hover:border-white/60 hover:bg-white/10 transition-all text-left video-option"
                onclick="answerVideoQuestion(${index})">
          ${String.fromCharCode(65 + index)}. ${option}
        </button>
      `).join('');
      
      questionArea.classList.remove('hidden');
      
      // In production, pause the video here using YouTube/Vimeo API
      // For now, we'll simulate with a message
      const videoFrame = document.getElementById('video-player');
      if (videoFrame) {
        // Note: Actual pausing would require YouTube/Vimeo API integration
        // This is a placeholder for the concept
        console.log('Video should pause when question appears');
      }
    };
    
    // Answer video question
    window.answerVideoQuestion = function(selectedIndex) {
      const question = activityData.questions[currentQuestionIndex];
      const feedbackDiv = document.getElementById('video-feedback');
      const options = document.querySelectorAll('.video-option');
      
      // Disable all options
      options.forEach(opt => opt.disabled = true);
      
      const isCorrect = selectedIndex === question.correctIndex;
      
      if (isCorrect) {
        videoScore++;
        options[selectedIndex].style.backgroundColor = 'var(--success-bg)';
        options[selectedIndex].style.borderColor = 'var(--success)';
        if (feedbackDiv) {
          feedbackDiv.className = 'mt-4 p-3 rounded-lg';
          feedbackDiv.style.backgroundColor = 'var(--success-bg)';
          feedbackDiv.style.borderColor = 'var(--success)';
          feedbackDiv.style.border = '2px solid';
          feedbackDiv.innerHTML = ' <strong>Correct!</strong> Great job!';
          feedbackDiv.classList.remove('hidden');
        }
      } else {
        options[selectedIndex].style.backgroundColor = 'var(--error-bg)';
        options[selectedIndex].style.borderColor = 'var(--error)';
        options[question.correctIndex].style.backgroundColor = 'var(--success-bg)';
        options[question.correctIndex].style.borderColor = 'var(--success)';
        if (feedbackDiv) {
          feedbackDiv.className = 'mt-4 p-3 rounded-lg';
          feedbackDiv.style.backgroundColor = 'var(--error-bg)';
          feedbackDiv.style.borderColor = 'var(--error)';
          feedbackDiv.style.border = '2px solid';
          feedbackDiv.innerHTML = ' <strong>Incorrect.</strong> The correct answer is highlighted.';
          feedbackDiv.classList.remove('hidden');
        }
      }
      
      questionsAnswered.push(currentQuestionIndex);
      
      // Update progress
      const progressEl = document.getElementById('video-progress');
      const scoreEl = document.getElementById('video-score');
      if (progressEl) progressEl.textContent = questionsAnswered.length;
      if (scoreEl) scoreEl.textContent = videoScore;
      
      // Continue to next question after delay
      setTimeout(() => {
        const questionArea = document.getElementById('video-question-area');
        if (questionArea) questionArea.classList.add('hidden');
        currentQuestionIndex++;
        
        // In production, resume video playback here
        const videoPlayer = document.getElementById('video-player');
        if (videoPlayer) {
          // Note: Actual resuming would require YouTube/Vimeo API integration
          // This is a placeholder for the concept
          console.log('Video should resume after answering');
        }
        
        // Show next question after delay (simulating video progress)
        setTimeout(() => {
          showNextVideoQuestion();
        }, 10000);
      }, 3000);
    };
    
    // Show video completion
    window.showVideoCompletion = function() {
      const questionArea = document.getElementById('video-question-area');
      if (!questionArea) return;
      
      const percentage = Math.round((videoScore / activityData.questions.length) * 100);
      
      questionArea.className = 'video-question-overlay text-center';
      questionArea.style.background = 'linear-gradient(135deg, var(--success) 0%, var(--accent) 100%)';
      questionArea.style.color = 'white';
      questionArea.innerHTML = `
        <div class="text-3xl font-bold mb-4"> Video Complete!</div>
        <div class="text-2xl mb-4">Final Score: ${videoScore}/${activityData.questions.length}</div>
        <div class="text-xl mb-6">${percentage}% Correct</div>
        <div class="text-lg mb-4">${percentage >= 80 ? 'Excellent work!' : percentage >= 60 ? 'Good job!' : 'Keep practicing!'}</div>
        <button class="btn" style="background: white; color: var(--primary);" onclick="resetVideoActivity()">
          <i class="fas fa-redo mr-2"></i>
          Watch Again
        </button>
      `;
      questionArea.classList.remove('hidden');
    };
    
    // Interactive Video Edit Mode
    window.renderInteractiveVideoEditMode = function() {
      const videoCard = document.createElement('div');
      videoCard.className = 'card mb-6';
      videoCard.innerHTML = `
        <h4 class="text-lg font-bold mb-4">Video Configuration</h4>
        
        <div class="mb-4">
          <label class="block text-sm text-muted mb-2">Video URL</label>
          <input type="text" value="${activityData.videoUrl || ''}" 
                 class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                 style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                 oninput="updateInteractiveVideo('videoUrl', this.value)"
                 placeholder="YouTube or Vimeo URL (e.g., https://www.youtube.com/watch?v=...)">
          <p class="text-xs text-muted mt-1">Paste a YouTube or Vimeo video URL</p>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm text-muted mb-2">Video Type</label>
          <select class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                  style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                  onchange="updateInteractiveVideo('videoType', this.value)">
            <option value="youtube" ${activityData.videoType === 'youtube' ? 'selected' : ''}>YouTube</option>
            <option value="vimeo" ${activityData.videoType === 'vimeo' ? 'selected' : ''}>Vimeo</option>
          </select>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm text-muted mb-2">Description</label>
          <input type="text" value="${activityData.description || ''}" 
                 class="w-full px-4 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                 style="background-color: var(--button-bg); border: 1px solid var(--button-border); color: var(--text);"
                 oninput="updateInteractiveVideo('description', this.value)"
                 placeholder="Brief description of the video lesson">
        </div>
      `;
      
      editor.appendChild(videoCard);
      
      // Questions section
      const questionsCard = document.createElement('div');
      questionsCard.className = 'card mb-6';
      questionsCard.innerHTML = `
        <div class="flex justify-between items-center mb-4">
          <h4 class="text-lg font-bold">Timeline Questions</h4>
          <button class="btn btn-sm btn-accent" onclick="addVideoQuestion()">
            <i class="fas fa-plus mr-2"></i>
            Add Question
          </button>
        </div>
        <div id="video-questions-list" class="space-y-4"></div>
      `;
      
      editor.appendChild(questionsCard);
      
      // Render existing questions
      renderVideoQuestions();
      
      // Preview
      const previewCard = document.createElement('div');
      previewCard.className = 'card';
      previewCard.innerHTML = `
        <h4 class="text-lg font-bold mb-4">Video Preview</h4>
        <div class="relative rounded-lg overflow-hidden" style="background-color: var(--background); border: 2px solid var(--card-border); height: 400px;">
          <iframe 
            src="${activityData.videoUrl ? getEmbedUrl(activityData.videoUrl) : 'about:blank'}" 
            style="width: 100%; height: 100%; border: none;"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
            title="Video Preview"
          ></iframe>
        </div>
        <p class="text-xs text-muted mt-2">Switch to Play Mode to test interactive questions</p>
      `;
      
      editor.appendChild(previewCard);
    };
    
    // Render video questions in edit mode
    window.renderVideoQuestions = function() {
      const questionsList = document.getElementById('video-questions-list');
      if (!questionsList) return;
      
      if (!activityData.questions || activityData.questions.length === 0) {
        questionsList.innerHTML = '<div class="text-center py-8 text-muted">No questions added yet. Click "Add Question" to get started.</div>';
        return;
      }
      
      questionsList.innerHTML = activityData.questions.map((q, index) => `
        <div class="p-4 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border);">
          <div class="flex justify-between items-start mb-3">
            <div class="font-bold">Question ${index + 1} (at ${q.timestamp || 0}s)</div>
            <button class="btn btn-sm btn-error" onclick="removeVideoQuestion(${index})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          
          <div class="mb-3">
            <label class="block text-xs text-muted mb-1">Timestamp (seconds)</label>
            <input type="number" value="${q.timestamp || 0}" 
                   class="w-full px-3 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                   style="background-color: var(--card); border: 1px solid var(--card-border); color: var(--text);"
                   oninput="updateVideoQuestion(${index}, 'timestamp', parseInt(this.value))" min="0">
          </div>
          
          <div class="mb-3">
            <label class="block text-xs text-muted mb-1">Question</label>
            <input type="text" value="${q.question || ''}" 
                   class="w-full px-3 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                   style="background-color: var(--card); border: 1px solid var(--card-border); color: var(--text);"
                   oninput="updateVideoQuestion(${index}, 'question', this.value)">
          </div>
          
          <div class="space-y-2">
            ${q.options ? q.options.map((opt, optIndex) => `
              <div class="flex gap-2">
                <input type="text" value="${opt}" 
                       class="flex-1 px-3 py-2 rounded-lg outline-none focus:border-primary transition-colors" 
                       style="background-color: var(--card); border: 1px solid var(--card-border); color: var(--text);"
                       oninput="updateVideoQuestionOption(${index}, ${optIndex}, this.value)"
                       placeholder="Option ${optIndex + 1}">
                <input type="radio" name="correct_${index}" ${q.correctIndex === optIndex ? 'checked' : ''}
                       onchange="updateVideoQuestion(${index}, 'correctIndex', ${optIndex})"
                       title="Mark as correct answer">
              </div>
            `).join('') : ''}
          </div>
        </div>
      `).join('');
    };
    
    // Add video question
    window.addVideoQuestion = function() {
      if (!activityData.questions) {
        activityData.questions = [];
      }
      
      activityData.questions.push({
        timestamp: (activityData.questions.length + 1) * 30,
        question: `Question ${activityData.questions.length + 1}`,
        options: ['Option A', 'Option B', 'Option C'],
        correctIndex: 0
      });
      
      activityData.totalQuestions = activityData.questions.length;
      renderVideoQuestions();
    };
    
    // Remove video question
    window.removeVideoQuestion = function(index) {
      if (activityData.questions) {
        activityData.questions.splice(index, 1);
        activityData.totalQuestions = activityData.questions.length;
        renderVideoQuestions();
      }
    };
    
    // Update video question
    window.updateVideoQuestion = function(index, field, value) {
      if (activityData.questions && activityData.questions[index]) {
        activityData.questions[index][field] = value;
        if (field === 'correctIndex') {
          renderVideoQuestions();
        }
      }
    };
    
    // Update video question option
    window.updateVideoQuestionOption = function(questionIndex, optionIndex, value) {
      if (activityData.questions && activityData.questions[questionIndex]) {
        activityData.questions[questionIndex].options[optionIndex] = value;
      }
    };
    
    // Update interactive video settings
    window.updateInteractiveVideo = function(field, value) {
      if (activityData) {
        activityData[field] = value;
        if (field === 'videoUrl' && currentMode === 'edit') {
          renderEditMode();
        }
      }
    };
    
    // Get embed URL for video
    function getEmbedUrl(url) {
      if (!url) return 'about:blank';
      
      // YouTube
      if (url.includes('youtube.com') || url.includes('youtu.be')) {
        const videoId = url.includes('youtu.be') 
          ? url.split('youtu.be/')[1]?.split('?')[0]
          : new URLSearchParams(new URL(url).search).get('v');
        return videoId ? `https://www.youtube.com/embed/${videoId}?enablejsapi=1` : url;
      }
      
      // Vimeo
      if (url.includes('vimeo.com')) {
        const videoId = url.split('vimeo.com/')[1]?.split('?')[0];
        return videoId ? `https://player.vimeo.com/video/${videoId}` : url;
      }
      
      return url;
    }
    
    // Toggle video fullscreen
    window.toggleVideoFullscreen = function() {
      const iframe = document.getElementById('video-player');
      if (iframe) {
        if (iframe.requestFullscreen) {
          iframe.requestFullscreen();
        } else if (iframe.webkitRequestFullscreen) {
          iframe.webkitRequestFullscreen();
        } else if (iframe.mozRequestFullScreen) {
          iframe.mozRequestFullScreen();
        } else if (iframe.msRequestFullscreen) {
          iframe.msRequestFullscreen();
        }
      }
    };
    
    // Reset video activity
    window.resetVideoActivity = function() {
      currentQuestionIndex = 0;
      videoScore = 0;
      questionsAnswered = [];
      renderPlayMode();
    };
    
    // ===== End Interactive Video Functions =====
    
    // ===== Enhanced Game Controls =====
    
    // Share Activity
    window.shareActivity = function() {
      const modal = document.getElementById('share-modal');
      const shareInput = document.getElementById('share-link-input');
      
      // Generate shareable link (in production, use actual deployed URL)
      const shareUrl = `${window.location.origin}${window.location.pathname}?template=${currentTemplate}&id=${activityData?.templateId || 'demo'}`;
      
      if (shareInput) {
        shareInput.value = shareUrl;
      }
      
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }
    };
    
    // Close share modal
    window.closeShareModal = function(event) {
      const modal = document.getElementById('share-modal');
      if (event && event.target !== modal) return;
      
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    };
    
    // Copy share link
    window.copyShareLink = function() {
      const shareInput = document.getElementById('share-link-input');
      if (shareInput) {
        shareInput.select();
        document.execCommand('copy');
        updateStatus('Link copied to clipboard!');
        
        // Visual feedback
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
          btn.innerHTML = originalHTML;
        }, 2000);
      }
    };
    
    // Share to social media
    window.shareToSocial = function(platform) {
      const shareUrl = document.getElementById('share-link-input')?.value || window.location.href;
      const title = activityData?.title || 'Check out this educational activity!';
      const text = `${title} - Interactive learning activity`;
      
      let url = '';
      
      switch(platform) {
        case 'twitter':
          url = `https://twitter.com/intent/tweet?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(text)}`;
          break;
        case 'facebook':
          url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;
          break;
        case 'linkedin':
          url = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(shareUrl)}`;
          break;
        case 'email':
          url = `mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(text + '\n\n' + shareUrl)}`;
          break;
      }
      
      if (url) {
        window.open(url, '_blank', 'width=600,height=400');
      }
    };
    
    // Show embed code modal
    window.showEmbedCode = function() {
      const modal = document.getElementById('embed-modal');
      
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        updateEmbedCode();
      }
    };
    
    // Close embed modal
    window.closeEmbedModal = function(event) {
      const modal = document.getElementById('embed-modal');
      if (event && event.target !== modal) return;
      
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    };
    
    // Update embed code
    window.updateEmbedCode = function() {
      const width = document.getElementById('embed-width')?.value || '800';
      const height = document.getElementById('embed-height')?.value || '600';
      const textarea = document.getElementById('embed-code-textarea');
      const preview = document.getElementById('embed-preview');
      
      const embedUrl = `${window.location.origin}${window.location.pathname}?template=${currentTemplate}&id=${activityData?.templateId || 'demo'}&embed=true`;
      
      const embedCode = `<iframe src="${embedUrl}" width="${width}" height="${height}" frameborder="0" allowfullscreen></iframe>`;
      
      if (textarea) {
        textarea.value = embedCode;
      }
      
      if (preview) {
        preview.innerHTML = `<div class="text-xs text-muted p-4">Preview: ${width}x${height}px iframe</div>`;
      }
    };
    
    // Copy embed code
    window.copyEmbedCode = function() {
      const textarea = document.getElementById('embed-code-textarea');
      if (textarea) {
        textarea.select();
        document.execCommand('copy');
        updateStatus('Embed code copied!');
        
        // Visual feedback
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check mr-1"></i> Copied!';
        setTimeout(() => {
          btn.innerHTML = originalHTML;
        }, 2000);
      }
    };
    
    // Toggle fullscreen
    window.toggleFullscreen = function() {
      const container = document.getElementById('activity-creator');
      const text = document.getElementById('fullscreen-text');
      
      if (!document.fullscreenElement) {
        if (container.requestFullscreen) {
          container.requestFullscreen();
        } else if (container.webkitRequestFullscreen) {
          container.webkitRequestFullscreen();
        } else if (container.mozRequestFullScreen) {
          container.mozRequestFullScreen();
        } else if (container.msRequestFullscreen) {
          container.msRequestFullscreen();
        }
        if (text) text.textContent = 'Exit Fullscreen';
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
          document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
        if (text) text.textContent = 'Fullscreen';
      }
    };
    
    // Listen for fullscreen changes
    document.addEventListener('fullscreenchange', () => {
      const text = document.getElementById('fullscreen-text');
      if (text) {
        text.textContent = document.fullscreenElement ? 'Exit Fullscreen' : 'Fullscreen';
      }
    });
    
    // Toggle timer
    window.toggleTimer = function() {
      if (timerRunning) {
        stopTimer();
      } else {
        startTimer();
      }
    };
    
    // Start timer
    function startTimer() {
      timerRunning = true;
      timerInterval = setInterval(() => {
        timerSeconds++;
        updateTimerDisplay();
      }, 1000);
      updateStatus('Timer started');
    }
    
    // Stop timer
    function stopTimer() {
      timerRunning = false;
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      updateStatus('Timer stopped');
    }
    
    // Reset timer
    window.resetTimer = function() {
      stopTimer();
      timerSeconds = 0;
      updateTimerDisplay();
    };
    
    // Update timer display
    function updateTimerDisplay() {
      const display = document.getElementById('timer-display');
      if (display) {
        const minutes = Math.floor(timerSeconds / 60);
        const seconds = timerSeconds % 60;
        display.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      }
    }
    
    // Toggle sound
    window.toggleSound = function() {
      soundEnabled = !soundEnabled;
      const icon = document.getElementById('sound-icon');
      const btn = document.getElementById('sound-btn');
      
      if (icon) {
        icon.className = soundEnabled ? 'icon-volume' : 'icon-volume-mute';
      }
      
      if (btn) {
        btn.style.opacity = soundEnabled ? '1' : '0.5';
      }
      
      // Stop background music if disabled
      if (!soundEnabled && backgroundMusic) {
        backgroundMusic.pause();
        backgroundMusic = null;
      }
      
      updateStatus(soundEnabled ? 'Sound enabled' : 'Sound muted');
    };
    
    // Play sound effect
    window.playSound = function(type) {
      if (!soundEnabled) return;
      
      // In production, load actual sound files
      // For now, use Web Audio API for simple beeps
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      // Different sounds for different types
      switch(type) {
        case 'correct':
          oscillator.frequency.value = 800;
          gainNode.gain.value = 0.3;
          oscillator.start();
          oscillator.stop(audioContext.currentTime + 0.2);
          break;
        case 'incorrect':
          oscillator.frequency.value = 200;
          gainNode.gain.value = 0.3;
          oscillator.start();
          oscillator.stop(audioContext.currentTime + 0.3);
          break;
        case 'complete':
          oscillator.frequency.value = 1000;
          gainNode.gain.value = 0.2;
          oscillator.start();
          setTimeout(() => {
            oscillator.frequency.value = 1200;
          }, 100);
          oscillator.stop(audioContext.currentTime + 0.4);
          break;
        default:
          oscillator.frequency.value = 440;
          gainNode.gain.value = 0.2;
          oscillator.start();
          oscillator.stop(audioContext.currentTime + 0.1);
      }
    };
    
    // ===== End Enhanced Game Controls =====
    
    // ===== Analytics Functions =====
    
    // Record activity play
    window.recordPlay = async function() {
      if (!activityData) return;
      
      if (!activityData.analytics) {
        activityData.analytics = {
          plays: 0,
          scores: [],
          avgScore: 0,
          lastPlayed: null
        };
      }
      
      activityData.analytics.plays = (activityData.analytics.plays || 0) + 1;
      activityData.analytics.lastPlayed = new Date().toISOString();
      
      // Save updated analytics
      await saveActivity();
    };
    
    // Record activity score
    window.recordScore = async function(score, maxScore) {
      if (!activityData) return;
      
      if (!activityData.analytics) {
        activityData.analytics = {
          plays: 0,
          scores: [],
          avgScore: 0,
          lastPlayed: null
        };
      }
      
      const percentage = maxScore > 0 ? Math.round((score / maxScore) * 100) : 0;
      
      activityData.analytics.scores.push({
        score: score,
        maxScore: maxScore,
        percentage: percentage,
        date: new Date().toISOString()
      });
      
      // Calculate average score
      const totalPercentage = activityData.analytics.scores.reduce((sum, s) => sum + s.percentage, 0);
      activityData.analytics.avgScore = Math.round(totalPercentage / activityData.analytics.scores.length);
      
      // Keep only last 50 scores to avoid bloat
      if (activityData.analytics.scores.length > 50) {
        activityData.analytics.scores = activityData.analytics.scores.slice(-50);
      }
      
      // Save updated analytics
      await saveActivity();
    };
    
    // ===== End Analytics Functions =====
    
    // ===== Public Gallery Functions =====
    
    // Show public gallery
    window.showPublicGallery = function() {
      console.log('Showing Public Gallery');
      hideAllSections();
      const publicGallery = document.getElementById('public-gallery');
      if (publicGallery) {
        console.log('Showing public gallery section');
        publicGallery.classList.remove('hidden');
      }
      
      // Load public templates
      refreshPublicGallery();
      
      // Close mobile sidebar
      if (window.innerWidth < 1024) {
        toggleSidebar();
      }
    };
    
    // Refresh public gallery
    window.refreshPublicGallery = async function() {
      const galleryList = document.getElementById('gallery-list');
      if (!galleryList) return;
      
      try {
        galleryList.innerHTML = '<div class="text-center py-12 text-muted col-span-full">Loading...</div>';
        
        // Fetch public templates from Firestore
        const publicTemplatesRef = firebase.collection(db, 'public_templates');
        const querySnapshot = await firebase.getDocs(publicTemplatesRef);
        
        const publicTemplates = [];
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          publicTemplates.push({
            id: doc.id,
            type: data.type,
            title: data.title,
            author: data.author,
            description: data.description,
            plays: data.analytics?.plays || 0,
            rating: data.analytics?.avgScore ? data.analytics.avgScore / 20 : 0, // Convert percentage to 5-star scale
            thumbnail: data.thumbnail || 'fa-graduation-cap',
            createdAt: data.createdAt || data.timestamp || new Date().toISOString()
          });
        });
        
        window.publicTemplatesCache = publicTemplates;
        renderGalleryTemplates(publicTemplates);
        
      } catch (error) {
        console.error('Error loading public gallery:', error);
        // Fallback to sample data if there's an error
        const sampleTemplates = [
          {
            id: 'pub_mcq_1',
            type: 'mcq',
            title: 'World Capitals Quiz',
            author: 'TeacherJohn',
            description: 'Test your knowledge of world capitals',
            plays: 1234,
            rating: 4.5,
            thumbnail: 'fa-globe'
          },
          {
            id: 'pub_flipcards_1',
            type: 'flipcards',
            title: 'Spanish Vocabulary',
            author: 'ProfesoraMaria',
            description: 'Learn common Spanish phrases',
            plays: 856,
            rating: 4.8,
            thumbnail: 'fa-language'
          },
          {
            id: 'pub_dragdrop_1',
            type: 'dragdrop',
            title: 'Parts of Speech',
            author: 'MsSmith',
            description: 'Match words to their parts of speech',
            plays: 542,
            rating: 4.3,
            thumbnail: 'fa-book'
          },
          {
            id: 'pub_video_1',
            type: 'interactivevideo',
            title: 'Science Experiment Demo',
            author: 'ProfessorBrown',
            description: 'Watch and answer questions about chemistry',
            plays: 2103,
            rating: 4.9,
            thumbnail: 'fa-flask'
          },
          {
            id: 'pub_reveal_1',
            type: 'contentreveal',
            title: 'Solar System Facts',
            author: 'AstronomyClub',
            description: 'Discover facts about planets',
            plays: 978,
            rating: 4.6,
            thumbnail: 'fa-space-shuttle'
          },
          {
            id: 'pub_truefalse_1',
            type: 'truefalse',
            title: 'History True or False',
            author: 'HistoryBuff',
            description: 'Test your historical knowledge',
            plays: 665,
            rating: 4.2,
            thumbnail: 'fa-landmark'
          }
        ];
        
        window.publicTemplatesCache = sampleTemplates;
        renderGalleryTemplates(sampleTemplates);
      }
    };
    
    // Render gallery templates
    function renderGalleryTemplates(templates) {
      const galleryList = document.getElementById('gallery-list');
      if (!galleryList) return;
      
      if (templates.length === 0) {
        galleryList.innerHTML = '<div class="text-center py-12 text-muted col-span-full">No templates found</div>';
        return;
      }
      
      const templateNames = {
        'mcq': 'Quiz',
        'truefalse': 'True or False',
        'flipcards': 'Flash Cards',
        'dragdrop': 'Match Up',
        'contentreveal': 'Content Reveal',
        'mentaldrag': 'Mental Health',
        'pickmany': 'Pick Many',
        'infocard': 'Info Card',
        'scormviewer': 'SCORM Viewer',
        'interactivevideo': 'Interactive Video',
        'gamearena': 'Game Arena'
      };
      
      galleryList.innerHTML = '';
      templates.forEach(template => {
        const card = document.createElement('div');
        card.className = 'template-card';
        
        const stars = ''.repeat(Math.floor(template.rating)) + ''.repeat(5 - Math.floor(template.rating));
        
        card.innerHTML = `
          <div class="flex flex-col h-full">
            <div class="flex items-start gap-4 mb-4">
              <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white;">
                <i class="fas ${template.thumbnail}"></i>
              </div>
              <div class="flex-1">
                <h3 class="text-lg font-bold mb-1">${template.title}</h3>
                <p class="text-xs text-muted">by ${template.author}</p>
                <p class="text-sm text-muted mt-1">${template.description}</p>
              </div>
            </div>
            
            <div class="flex items-center gap-4 mb-3 text-sm text-muted">
              <span><i class="fas fa-play mr-1"></i> ${template.plays} plays</span>
              <span style="color: var(--warn);">${stars}</span>
            </div>
            
            <div class="pill mb-4" style="width: fit-content;">${templateNames[template.type]}</div>
            
            <div class="flex gap-2 mt-auto">
              <button class="btn btn-primary flex-1" onclick="usePublicTemplate('${template.id}')">
                <i class="fas fa-download mr-2"></i>
                Use Template
              </button>
              <button class="btn btn-accent" onclick="previewPublicTemplate('${template.id}')" title="Preview">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
        `;
        
        galleryList.appendChild(card);
      });
    }
    
    // Filter gallery
    window.filterGallery = function() {
      const searchInput = document.getElementById('gallery-search');
      const filterSelect = document.getElementById('gallery-filter');
      
      if (!searchInput || !filterSelect || !window.publicTemplatesCache) return;
      
      const searchTerm = searchInput.value.toLowerCase();
      const filterType = filterSelect.value;
      
      const filtered = window.publicTemplatesCache.filter(template => {
        const matchesSearch = template.title.toLowerCase().includes(searchTerm) ||
                            template.description.toLowerCase().includes(searchTerm) ||
                            template.author.toLowerCase().includes(searchTerm);
        const matchesType = filterType === 'all' || template.type === filterType;
        
        return matchesSearch && matchesType;
      });
      
      renderGalleryTemplates(filtered);
    };
    
    // Use public template
    window.usePublicTemplate = async function(templateId) {
      try {
        // Get the template data from public templates
        const templateRef = firebase.doc(db, 'public_templates', templateId);
        const templateSnap = await firebase.getDoc(templateRef);
        
        if (templateSnap.exists()) {
          const templateData = templateSnap.data();
          
          // Update the current activity with the template data
          activityData = {...templateData};
          
          // Update the current template type to match the imported template
          currentTemplate = templateData.type;
          
          // Update UI to show the imported template
          updateActivityDisplay();
          if (currentMode === 'play') {
            renderPlayMode();
          } else {
            renderEditMode();
          }
          
          // Update template selection in UI
          const templateSelect = document.getElementById('template-select');
          if (templateSelect) {
            templateSelect.value = templateData.type;
          }
          
          updateStatus(`Imported template: ${templateData.title}`);
        } else {
          alert('Template not found');
        }
      } catch (error) {
        console.error('Error importing template:', error);
        alert('Failed to import template. Please try again.');
      }
    };
    
    // Preview public template
    window.previewPublicTemplate = async function(templateId) {
      try {
        // Get the template data from public templates
        const templateRef = firebase.doc(db, 'public_templates', templateId);
        const templateSnap = await firebase.getDoc(templateRef);
        
        if (templateSnap.exists()) {
          const templateData = templateSnap.data();
          
          // Store the original activity data to restore later
          const originalActivityData = activityData;
          const originalTemplate = currentTemplate;
          
          // Update the current activity with the template data
          activityData = {...templateData};
          
          // Update the current template type to match the previewed template
          currentTemplate = templateData.type;
          
          // Update UI to show the previewed template
          updateActivityDisplay();
          if (currentMode === 'play') {
            renderPlayMode();
          } else {
            renderEditMode();
          }
          
          // Update template selection in UI
          const templateSelect = document.getElementById('template-select');
          if (templateSelect) {
            templateSelect.value = templateData.type;
          }
          
          updateStatus(`Previewing template: ${templateData.title}`);
          
          // After preview, ask user if they want to use the template
          setTimeout(() => {
            if (confirm(`Like this template?\n\nClick OK to import it to your workspace, or Cancel to go back to your work.`)) {
              // User wants to import the template, keep it as is
              updateStatus(`Template imported: ${templateData.title}`);
            } else {
              // Restore original activity data
              activityData = originalActivityData;
              currentTemplate = originalTemplate;
              updateActivityDisplay();
              if (currentMode === 'play') {
                renderPlayMode();
              } else {
                renderEditMode();
              }
              const templateSelect = document.getElementById('template-select');
              if (templateSelect) {
                templateSelect.value = originalTemplate;
              }
              updateStatus('Returned to your work');
            }
          }, 1000);
        } else {
          alert('Template not found');
        }
      } catch (error) {
        console.error('Error previewing template:', error);
        alert('Failed to preview template. Please try again.');
      }
    };
    
    // ===== End Public Gallery Functions =====
    
    // ===== Theme Variant Functions =====
    
    // Switch theme variant
    window.switchThemeVariant = function(variant) {
      console.log('Switching theme variant to:', variant);
      const body = document.body;
      
      // Remove all theme classes
      body.classList.remove('theme-minimal', 'theme-chalkboard', 'theme-neon', 'theme-vibrant');
      
      // Add new theme class
      if (variant !== 'default') {
        body.classList.add(`theme-${variant}`);
      }
      
      // Save preference
      localStorage.setItem('themeVariant', variant);
      
      updateStatus(`Theme changed to ${variant}`);
    };
    
    // Load saved theme variant
    window.loadThemeVariant = function() {
      console.log('Loading theme variant');
      const savedVariant = localStorage.getItem('themeVariant') || 'default';
      const selectorSidebar = document.getElementById('theme-variant-selector');
      const selectorHeader = document.getElementById('theme-variant-selector-header');
      
      if (selectorSidebar) {
        selectorSidebar.value = savedVariant;
      }
      
      if (selectorHeader) {
        selectorHeader.value = savedVariant;
      }
      
      if (savedVariant !== 'default') {
        document.body.classList.add(`theme-${savedVariant}`);
      }
    };
    
    // ===== End Theme Variant Functions =====
    
    // ===== Navigation Functions =====
    
    // Show home page
    window.showHomePage = function() {
      console.log('Showing home page');
      hideAllSections();
      const homePage = document.getElementById('home-page');
      if (homePage) {
        console.log('Showing home page section');
        homePage.classList.remove('hidden');
      }
      
      // Close mobile sidebar
      if (window.innerWidth < 1024) {
        toggleSidebar();
      }
    };
    
    // Show user dashboard
    window.showUserDashboard = async function() {
      console.log('Showing user dashboard');
      hideAllSections();
      const userDashboard = document.getElementById('user-dashboard');
      if (userDashboard) {
        console.log('Showing user dashboard section');
        userDashboard.classList.remove('hidden');
      }
      
      // Update dashboard data
      await updateUserDashboard();
      
      // Close mobile sidebar
      if (window.innerWidth < 1024) {
        toggleSidebar();
      }
    };
    
    // Update user dashboard
    async function updateUserDashboard() {
      // Update username
      const usernameElem = document.getElementById('dashboard-username');
      const emailElem = document.getElementById('dashboard-email');
      const uidElem = document.getElementById('dashboard-uid');
      
      if (usernameElem) {
        if (uid && !uid.startsWith('guest_')) {
          const user = auth.currentUser;
          usernameElem.textContent = user?.displayName || user?.email?.split('@')[0] || 'User';
          emailElem.textContent = user?.email || 'Not provided';
        } else {
          usernameElem.textContent = 'Guest User';
          emailElem.textContent = 'Not logged in';
        }
      }
      
      if (uidElem) {
        uidElem.textContent = uid || 'Not available';
      }
      
      // Count templates and total plays
      let templateCount = 0;
      let totalPlays = 0;
      
      if (uid && !uid.startsWith('guest_')) {
        const templateTypes = ['mcq', 'truefalse', 'flipcards', 'dragdrop', 'contentreveal', 'mentaldrag', 'pickmany', 'infocard', 'scormviewer', 'interactivevideo'];
        
        for (const type of templateTypes) {
          try {
            const ref = firebase.doc(db, 'users', uid, 'templates', type);
            const snap = await firebase.getDoc(ref);
            
            if (snap.exists()) {
              templateCount++;
              const data = snap.data();
              totalPlays += data.analytics?.plays || 0;
            }
          } catch (error) {
            console.error('Error loading template stats:', error);
          }
        }
      }
      
      const countElem = document.getElementById('dashboard-template-count');
      const playsElem = document.getElementById('dashboard-total-plays');
      
      if (countElem) countElem.textContent = templateCount;
      if (playsElem) playsElem.textContent = totalPlays;
    }
    
    // Hide all sections
    function hideAllSections() {
      console.log('Hiding all sections');
      const sections = [
        'home-page',
        'user-dashboard',
        'welcome-section',
        'activity-creator',
        'my-templates-dashboard',
        'public-gallery',
        'admin-dashboard',
        'price-plans'
      ];
      
      sections.forEach(id => {
        const section = document.getElementById(id);
        if (section) {
          console.log('Hiding section:', id);
          section.classList.add('hidden');
        }
      });
    }
    
    // ===== Price Plans Functions =====
    
    // Show Price Plans
    window.showPricePlans = function() {
      console.log('Showing price plans');
      hideAllSections();
      const pricePlans = document.getElementById('price-plans');
      if (pricePlans) {
        pricePlans.classList.remove('hidden');
      }
      
      // Close mobile sidebar
      if (window.innerWidth < 1024) {
        toggleSidebar();
      }
    };
    
    // Switch billing cycle (monthly/annual)
    window.switchBillingCycle = function(cycle) {
      const monthlyBtn = document.getElementById('billing-monthly');
      const annualBtn = document.getElementById('billing-annual');
      
      if (cycle === 'monthly') {
        monthlyBtn.style.backgroundColor = 'var(--primary)';
        monthlyBtn.style.color = 'white';
        annualBtn.style.backgroundColor = 'transparent';
        annualBtn.style.color = 'var(--text)';
        
        // Update prices to monthly
        document.getElementById('standard-price').textContent = '10';
        document.getElementById('standard-billing').textContent = 'Billed monthly';
        document.getElementById('pro-price').textContent = '15';
        document.getElementById('pro-billing').textContent = 'Billed monthly';
      } else {
        annualBtn.style.backgroundColor = 'var(--primary)';
        annualBtn.style.color = 'white';
        monthlyBtn.style.backgroundColor = 'transparent';
        monthlyBtn.style.color = 'var(--text)';
        
        // Update prices to annual (25% off)
        document.getElementById('standard-price').textContent = '7.50';
        document.getElementById('standard-billing').textContent = 'Billed annually at $90 / year';
        document.getElementById('pro-price').textContent = '11.25';
        document.getElementById('pro-billing').textContent = 'Billed annually at $135 / year';
      }
    };
    
    // Handle subscription
    window.handleSubscribe = function(plan) {
      console.log('Subscribing to plan:', plan);
      
      // Check if user is logged in
      if (!uid || uid.startsWith('guest_')) {
        updateStatus('Please sign up or log in to subscribe');
        showAuthModal('signup');
        return;
      }
      
      // In a real implementation, this would integrate with a payment provider
      // For now, just show a message
      alert(`You are subscribing to the ${plan.toUpperCase()} plan.\n\nIn a production environment, this would redirect you to a secure payment page.`);
      updateStatus(`Processing subscription to ${plan} plan...`);
    };
    
    // ===== Admin Dashboard Functions =====
    
    let adminUserPage = 0;
    let adminCurrentTab = 'users';
    const ADMIN_EMAILS = ['admin@tamer.com', 'rajput.karan2907@gmail.com', 'Tamermm2001@gmail.com']; // Add admin emails here
    
    // Show Admin Dashboard
    window.showAdminDashboard = function() {
      console.log('Showing admin dashboard');
      hideAllSections();
      const adminDashboard = document.getElementById('admin-dashboard');
      if (adminDashboard) {
        adminDashboard.classList.remove('hidden');
        loadAdminStats();
        loadAdminUsers(0);
      }
      
      // Close mobile sidebar
      if (window.innerWidth < 1024) {
        toggleSidebar();
      }
    };
    
    // Check if user is admin
    function isAdmin(userEmail) {
      return ADMIN_EMAILS.includes(userEmail);
    }
    
    // Load admin statistics
    async function loadAdminStats() {
      try {
        // In a real implementation, this would query Firebase for actual stats
        // For now, we'll use mock data
        document.getElementById('admin-total-users').textContent = '127';
        document.getElementById('admin-total-templates').textContent = '384';
        document.getElementById('admin-total-views').textContent = '2.5K';
        document.getElementById('admin-active-today').textContent = '42';
      } catch (error) {
        console.error('Error loading admin stats:', error);
      }
    }
    
    // Switch admin tab
    window.switchAdminTab = function(tab) {
      adminCurrentTab = tab;
      
      // Update tab buttons
      ['users', 'templates', 'analytics', 'pricing', 'reports'].forEach(t => {
        const btn = document.getElementById(`admin-tab-${t}`);
        const content = document.getElementById(`admin-content-${t}`);
        
        if (t === tab) {
          btn.style.borderColor = 'var(--primary)';
          btn.style.color = 'var(--primary)';
          if (content) content.classList.remove('hidden');
        } else {
          btn.style.borderColor = 'transparent';
          btn.classList.add('text-muted');
          btn.classList.remove('text-primary');
          if (content) content.classList.add('hidden');
        }
      });
      
      // Load tab-specific data
      if (tab === 'users') loadAdminUsers(0);
      else if (tab === 'templates') loadAdminTemplates();
      else if (tab === 'analytics') loadAdminAnalytics();
      else if (tab === 'pricing') loadAdminPricing();
    };
    
    // Load admin users
    window.loadAdminUsers = async function(page) {
      adminUserPage = page;
      const tbody = document.getElementById('admin-users-table');
      
      try {
        // Mock user data - in real implementation, query Firebase
        const mockUsers = [
          { name: 'John Doe', email: 'john@example.com', templates: 5, joined: '2024-01-15', status: 'Active' },
          { name: 'Jane Smith', email: 'jane@example.com', templates: 12, joined: '2024-02-20', status: 'Active' },
          { name: 'Bob Wilson', email: 'bob@example.com', templates: 3, joined: '2024-03-10', status: 'Inactive' }
        ];
        
        tbody.innerHTML = mockUsers.map(user => `
          <tr class="border-b hover:bg-primary/5 transition-colors" style="border-color: var(--card-border);">
            <td class="p-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold" style="background-color: var(--primary); color: white;">
                  ${user.name.charAt(0)}
                </div>
                <div class="font-bold">${user.name}</div>
              </div>
            </td>
            <td class="p-3 text-sm text-muted">${user.email}</td>
            <td class="p-3 text-sm">${user.templates}</td>
            <td class="p-3 text-sm text-muted">${user.joined}</td>
            <td class="p-3">
              <span class="pill" style="background-color: ${user.status === 'Active' ? 'var(--success)' : 'var(--muted)'}20; color: ${user.status === 'Active' ? 'var(--success)' : 'var(--muted)'}">
                ${user.status}
              </span>
            </td>
            <td class="p-3">
              <div class="flex gap-2">
                <button class="btn btn-ghost btn-sm" title="View Details">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-ghost btn-sm" title="Edit User">
                  <i class="fas fa-edit"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
        
        document.getElementById('admin-users-count').textContent = mockUsers.length;
      } catch (error) {
        console.error('Error loading admin users:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-muted">Error loading users</td></tr>';
      }
    };
    
    // Load admin templates
    async function loadAdminTemplates() {
      const grid = document.getElementById('admin-templates-grid');
      
      try {
        // Mock template data
        const mockTemplates = [
          { type: 'mcq', title: 'Science Quiz', author: 'John Doe', plays: 145, created: '2024-01-15' },
          { type: 'flashcards', title: 'Vocabulary Cards', author: 'Jane Smith', plays: 98, created: '2024-02-01' },
          { type: 'dragdrop', title: 'Match Countries', author: 'Bob Wilson', plays: 67, created: '2024-02-10' }
        ];
        
        grid.innerHTML = mockTemplates.map(tpl => `
          <div class="card hover:shadow-lg transition-all">
            <div class="flex justify-between items-start mb-3">
              <div class="pill">${tpl.type.toUpperCase()}</div>
              <button class="btn btn-ghost btn-sm"><i class="fas fa-ellipsis-v"></i></button>
            </div>
            <h4 class="font-bold mb-2">${tpl.title}</h4>
            <p class="text-sm text-muted mb-3">By ${tpl.author}</p>
            <div class="flex justify-between text-sm">
              <span class="text-muted"><i class="fas fa-play-circle mr-1"></i>${tpl.plays} plays</span>
              <span class="text-muted">${tpl.created}</span>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading admin templates:', error);
      }
    }
    
    // Load admin analytics
    async function loadAdminAnalytics() {
      const popularDiv = document.getElementById('admin-popular-templates');
      
      const mockPopular = [
        { title: 'Science Quiz', plays: 245, avgScore: 85 },
        { title: 'Math Practice', plays: 198, avgScore: 78 },
        { title: 'History Timeline', plays: 156, avgScore: 92 }
      ];
      
      popularDiv.innerHTML = mockPopular.map(tpl => `
        <div class="flex justify-between items-center p-4 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--button-border);">
          <div>
            <div class="font-bold">${tpl.title}</div>
            <div class="text-sm text-muted">${tpl.plays} plays  ${tpl.avgScore}% avg score</div>
          </div>
          <div class="text-2xl font-bold" style="color: var(--primary);">${tpl.plays}</div>
        </div>
      `).join('');
    }
    
    // Filter admin users
    window.filterAdminUsers = function() {
      const search = document.getElementById('admin-user-search').value.toLowerCase();
      const rows = document.querySelectorAll('#admin-users-table tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
      });
    };
    
    // Filter admin templates
    window.filterAdminTemplates = function() {
      const filter = document.getElementById('admin-template-filter').value;
      // Implementation for filtering templates
      loadAdminTemplates();
    };
    
    // Refresh admin users
    window.refreshAdminUsers = function() {
      loadAdminUsers(adminUserPage);
    };
    
    // Generate admin report
    window.generateAdminReport = function(type) {
      alert(`Generating ${type} report...\nThis would download a CSV/PDF file with ${type} data.`);
    };
    
    // Show custom report builder
    window.showCustomReportBuilder = function() {
      alert('Custom Report Builder\nThis would show a modal to configure custom report parameters.');
    };
    
    // ===== Admin Pricing Management Functions =====
    
    // Load admin pricing
    async function loadAdminPricing() {
      console.log('Loading admin pricing');
      
      // Load saved prices from localStorage (or Firebase in production)
      const savedPricing = localStorage.getItem('adminPricing');
      
      if (savedPricing) {
        const pricing = JSON.parse(savedPricing);
        
        // Update form fields
        document.getElementById('admin-standard-monthly').value = pricing.standardMonthly || 10;
        document.getElementById('admin-standard-annual').value = pricing.standardAnnual || 7.50;
        document.getElementById('admin-standard-annual-total').value = pricing.standardAnnualTotal || 90;
        document.getElementById('admin-pro-monthly').value = pricing.proMonthly || 15;
        document.getElementById('admin-pro-annual').value = pricing.proAnnual || 11.25;
        document.getElementById('admin-pro-annual-total').value = pricing.proAnnualTotal || 135;
      }
      
      // Load pricing history
      loadPricingHistory();
    }
    
    // Save Standard plan pricing
    window.saveStandardPricing = function() {
      const monthlyPrice = document.getElementById('admin-standard-monthly').value;
      const annualPrice = document.getElementById('admin-standard-annual').value;
      const annualTotal = document.getElementById('admin-standard-annual-total').value;
      
      // Get current pricing or initialize
      const currentPricing = JSON.parse(localStorage.getItem('adminPricing') || '{}');
      
      // Update Standard pricing
      currentPricing.standardMonthly = monthlyPrice;
      currentPricing.standardAnnual = annualPrice;
      currentPricing.standardAnnualTotal = annualTotal;
      
      // Save to localStorage
      localStorage.setItem('adminPricing', JSON.stringify(currentPricing));
      
      // Update public pricing page
      document.getElementById('standard-price').textContent = monthlyPrice;
      
      // Record change in history
      addPricingHistory('Standard', monthlyPrice, annualPrice, annualTotal);
      
      updateStatus('Standard pricing updated successfully!');
      alert('Standard plan pricing updated!\n\nMonthly: $' + monthlyPrice + '\nAnnual: $' + annualPrice + '/month ($' + annualTotal + '/year)');
    };
    
    // Save Pro plan pricing
    window.saveProPricing = function() {
      const monthlyPrice = document.getElementById('admin-pro-monthly').value;
      const annualPrice = document.getElementById('admin-pro-annual').value;
      const annualTotal = document.getElementById('admin-pro-annual-total').value;
      
      // Get current pricing or initialize
      const currentPricing = JSON.parse(localStorage.getItem('adminPricing') || '{}');
      
      // Update Pro pricing
      currentPricing.proMonthly = monthlyPrice;
      currentPricing.proAnnual = annualPrice;
      currentPricing.proAnnualTotal = annualTotal;
      
      // Save to localStorage
      localStorage.setItem('adminPricing', JSON.stringify(currentPricing));
      
      // Update public pricing page
      document.getElementById('pro-price').textContent = monthlyPrice;
      
      // Record change in history
      addPricingHistory('Pro', monthlyPrice, annualPrice, annualTotal);
      
      updateStatus('Pro pricing updated successfully!');
      alert('Pro plan pricing updated!\n\nMonthly: $' + monthlyPrice + '\nAnnual: $' + annualPrice + '/month ($' + annualTotal + '/year)');
    };
    
    // Add pricing change to history
    function addPricingHistory(plan, monthly, annual, annualTotal) {
      const history = JSON.parse(localStorage.getItem('pricingHistory') || '[]');
      
      history.unshift({
        plan: plan,
        monthly: monthly,
        annual: annual,
        annualTotal: annualTotal,
        timestamp: new Date().toISOString(),
        user: auth.currentUser?.email || 'Admin'
      });
      
      // Keep only last 50 changes
      if (history.length > 50) {
        history.splice(50);
      }
      
      localStorage.setItem('pricingHistory', JSON.stringify(history));
      loadPricingHistory();
    }
    
    // Load pricing history
    function loadPricingHistory() {
      const history = JSON.parse(localStorage.getItem('pricingHistory') || '[]');
      const historyDiv = document.getElementById('admin-pricing-history');
      
      if (history.length === 0) {
        historyDiv.innerHTML = '<div class="text-sm text-muted">No pricing changes recorded yet</div>';
        return;
      }
      
      historyDiv.innerHTML = history.slice(0, 10).map(change => {
        const date = new Date(change.timestamp);
        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        
        return `
          <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: var(--button-bg); border: 1px solid var(--card-border);">
            <div>
              <span class="font-bold">${change.plan} Plan</span>
              <span class="text-muted mx-2"></span>
              <span class="text-sm">Monthly: $${change.monthly}</span>
              <span class="text-muted mx-2"></span>
              <span class="text-sm">Annual: $${change.annual}/mo</span>
            </div>
            <div class="text-xs text-muted">${formattedDate}</div>
          </div>
        `;
      }).join('');
    }
    
    // ===== End Admin Pricing Management Functions =====
    
    // ===== End Admin Dashboard Functions =====
    
    // ===== End Navigation Functions =====
    
    // ===== Sidebar Toggle Functions =====
    
    // Toggle templates section
    window.toggleTemplatesSection = function() {
      console.log('Toggling templates section');
      const templatesList = document.getElementById('templates-list');
      const chevron = document.getElementById('templates-chevron');
      
      if (templatesList.style.display === 'none') {
        templatesList.style.display = 'block';
        chevron.style.transform = 'rotate(0deg)';
      } else {
        templatesList.style.display = 'none';
        chevron.style.transform = 'rotate(-90deg)';
      }
    };
    
    // ===== End Sidebar Toggle Functions =====
    
    // Save activity to Firebase or localStorage
    window.saveActivity = async function() {
      alert('Save button clicked! Saving Game Arena template...');
      console.log('Save button clicked!');
      console.log('Current UID:', uid);
      console.log('Current Template:', currentTemplate);
      console.log('Activity Data:', activityData);
      
      if (!uid) {
        updateStatus('Please wait for authentication...');
        console.log('No UID available');
        return;
      }
      
      if (!activityData) {
        updateStatus('No activity data to save');
        console.log('No activity data available');
        return;
      }
      
      // Debug: Log current template and activity data
      console.log('Saving activity for template:', currentTemplate);
      console.log('Activity data:', activityData);
      
      // Generate a unique template ID based on template type and title
      const templateId = currentTemplate + '_' + Date.now();
      console.log('Generated template ID:', templateId);
      
      // Preserve existing analytics or initialize
      const existingPlays = activityData.analytics?.plays || 0;
      const existingScores = activityData.analytics?.scores || [];
      const existingAvgScore = activityData.analytics?.avgScore || 0;
      
      // Add metadata to the activity data with analytics
      const dataToSave = {
        ...activityData,
        templateId: activityData.templateId || templateId,
        createdAt: activityData.createdAt || new Date().toISOString(),
        lastModified: new Date().toISOString(),
        analytics: {
          plays: existingPlays,
          scores: existingScores,
          avgScore: existingAvgScore,
          lastPlayed: activityData.analytics?.lastPlayed || null
        }
      };
      
      console.log('Data to save:', dataToSave);
      
      try {
        updateStatus('Saving Game Arena template...');
        console.log('Attempting to save data:', dataToSave);
        
        // Check if user is in guest mode (uid starts with 'guest_')
        if (uid.startsWith('guest_')) {
          console.log('Saving to localStorage (guest mode)');
          // Save to localStorage for guest users
          const storageKey = `template_${uid}_${currentTemplate}`;
          console.log('Saving to localStorage with key:', storageKey);
          localStorage.setItem(storageKey, JSON.stringify(dataToSave));
          updateStatus('Game Arena template saved locally!');
          setTimeout(() => {
            updateStatus('All changes saved locally');
          }, 2000);
        } else {
          console.log('Saving to Firebase (authenticated user)');
          // Save to Firebase for authenticated users - user-specific templates
          const ref = firebase.doc(db, 'users', uid, 'templates', currentTemplate);
          console.log('Saving to Firebase:', ref.path);
          await firebase.setDoc(ref, dataToSave, { merge: false });
          
          updateStatus('Game Arena template saved successfully!');
          setTimeout(() => {
            updateStatus('All changes saved');
          }, 2000);
        }
        console.log('Save operation completed successfully');
      } catch (error) {
        console.error('Error saving activity:', error);
        updateStatus('Error saving Game Arena template: ' + error.message);
      }
    };
    
    // Publish template to public gallery
    window.publishToPublicGallery = async function() {
      if (!uid || uid.startsWith('guest_')) {
        alert('You must be logged in to publish templates to the public gallery.');
        return;
      }
      
      if (!activityData) {
        updateStatus('No activity data to publish');
        return;
      }
      
      // Get user info to set as author
      const user = auth.currentUser;
      const author = user?.displayName || user?.email?.split('@')[0] || 'Anonymous';
      
      // Create public template data
      const publicTemplateData = {
        ...activityData,
        author: author,
        authorId: uid,
        createdAt: new Date().toISOString(),
        lastModified: new Date().toISOString(),
        analytics: activityData.analytics || {
          plays: 0,
          scores: [],
          avgScore: 0,
          lastPlayed: null
        },
        thumbnail: activityData.thumbnail || 'fa-graduation-cap',
        isPublic: true
      };
      
      try {
        // Generate a unique ID for the public template
        const templateId = currentTemplate + '_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8);
        
        // Save to public templates collection
        const publicRef = firebase.doc(db, 'public_templates', templateId);
        await firebase.setDoc(publicRef, publicTemplateData);
        
        updateStatus('Template published to public gallery successfully!');
        
        // Ask if user wants to share the template
        if (confirm('Template published successfully! Would you like to share it with others?')) {
          // Copy share link to clipboard
          const shareUrl = window.location.origin + window.location.pathname + `?template=${templateId}`;
          navigator.clipboard.writeText(shareUrl).then(() => {
            alert('Share link copied to clipboard!');
          }).catch(err => {
            console.error('Failed to copy link: ', err);
          });
        }
      } catch (error) {
        console.error('Error publishing template:', error);
        updateStatus('Error publishing template: ' + error.message);
      }
    };
    
    // Load activity from Firebase or localStorage
    window.loadActivity = async function(forceReload = false) {
      console.log('loadActivity called with forceReload:', forceReload);
      console.log('Current UID:', uid);
      console.log('Current Template:', currentTemplate);
      
      // Special handling for gamearena template
      if (currentTemplate === 'gamearena') {
        console.log('Loading Game Arena template');
      }
      
      if (!uid) {
        updateStatus('Please wait for authentication...');
        console.log('No UID available, returning');
        return;
      }
      
      try {
        if (!forceReload) {
          updateStatus('Loading...');
        }
        
        let loaded = false;
        
        // Check if user is in guest mode (uid starts with 'guest_')
        if (uid.startsWith('guest_')) {
          console.log('Loading from localStorage (guest mode)');
          // Load from localStorage for guest users
          const storageKey = `template_${uid}_${currentTemplate}`;
          console.log('Loading from localStorage with key:', storageKey);
          const savedData = localStorage.getItem(storageKey);
          
          if (savedData) {
            const parsedData = JSON.parse(savedData);
            console.log('Parsed data template:', parsedData.template);
            console.log('Current template:', currentTemplate);
            if (parsedData.template === currentTemplate) {
              activityData = parsedData;
              updateStatus('Loaded saved template');
              loaded = true;
              console.log('Loaded from localStorage:', activityData);
            } else {
              console.log('Template mismatch in localStorage');
            }
          } else {
            console.log('No data found in localStorage for key:', storageKey);
          }
        } else {
          console.log('Loading from Firebase (authenticated user)');
          // Load from Firebase for authenticated users
          const ref = firebase.doc(db, 'users', uid, 'templates', currentTemplate);
          console.log('Loading from Firebase:', ref.path);
          const snap = await firebase.getDoc(ref);
          
          if (snap.exists()) {
            const data = snap.data();
            console.log('Firebase data template:', data.template);
            console.log('Current template:', currentTemplate);
            if (data.template === currentTemplate) {
              activityData = data;
              updateStatus('Loaded saved template');
              loaded = true;
              console.log('Loaded from Firebase:', activityData);
            } else {
              console.log('Template mismatch in Firebase');
            }
          } else {
            console.log('No data found in Firebase for template:', currentTemplate);
          }
        }
        
        // If no saved template found, load dummy data
        if (!loaded) {
          console.log('No saved template found, loading dummy data');
          console.log('DUMMIES object:', DUMMIES);
          console.log('Current template in DUMMIES:', DUMMIES[currentTemplate]);
          
          if (DUMMIES[currentTemplate]) {
            activityData = JSON.parse(JSON.stringify(DUMMIES[currentTemplate]));
            if (!forceReload) {
              updateStatus('Loaded default template');
            }
            console.log('Loaded dummy data:', activityData);
          } else {
            console.error('No dummy data found for template:', currentTemplate);
            updateStatus('Error: No template data available');
            return;
          }
        }
        
        updateActivityDisplay();
        if (currentMode === 'play') {
          renderPlayMode();
        } else {
          renderEditMode();
        }
      } catch (error) {
        console.error('Error loading activity:', error);
        updateStatus('Error: ' + error.message);
        // Fallback to dummy data on error
        if (DUMMIES[currentTemplate]) {
          activityData = JSON.parse(JSON.stringify(DUMMIES[currentTemplate]));
          updateActivityDisplay();
          if (currentMode === 'play') {
            renderPlayMode();
          } else {
            renderEditMode();
          }
        }
      }
    };
    
    // Theme toggle function
    window.toggleTheme = function() {
      console.log('Toggling theme');
      const body = document.body;
      const isDark = body.classList.contains('theme-light');
      
      if (isDark) {
        body.classList.remove('theme-light');
        localStorage.setItem('theme', 'dark');
        if (document.getElementById('theme-toggle')) {
          document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-moon"></i>';
        }
      } else {
        body.classList.add('theme-light');
        localStorage.setItem('theme', 'light');
        if (document.getElementById('theme-toggle')) {
          document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-sun"></i>';
        }
      }
    };
    
    // Initialize theme based on saved preference or system preference
    window.initTheme = function() {
      console.log('Initializing theme');
      const savedTheme = localStorage.getItem('theme');
      const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
      
      if (theme === 'light') {
        document.body.classList.add('theme-light');
        if (document.getElementById('theme-toggle')) {
          document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-sun"></i>';
        }
      } else {
        document.body.classList.remove('theme-light');
        if (document.getElementById('theme-toggle')) {
          document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-moon"></i>';
        }
      }
    };
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM Content Loaded');
      // Sidebar toggle for mobile
      const sidebarToggle = document.getElementById('sidebar-toggle');
      if (sidebarToggle) {
        sidebarToggle.addEventListener('click', toggleSidebar);
      }
      
      // Template selector is now sidebar items - no need for dropdown change listener
      
      // Save buttons in sidebar
      if (saveChangesBtn) {
        console.log('Attaching event listener to main save button');
        saveChangesBtn.addEventListener('click', function() {
          console.log('Main save button clicked');
          saveActivity();
        });
      } else {
        console.log('Main save button not found');
      }
      
      // Save button in dashboard
      const saveChangesBtnDashboard = document.getElementById('save-changes-btn-dashboard');
      if (saveChangesBtnDashboard) {
        console.log('Attaching event listener to dashboard save button');
        saveChangesBtnDashboard.addEventListener('click', function() {
          console.log('Dashboard save button clicked');
          saveActivity();
        });
      } else {
        console.log('Dashboard save button not found');
      }
      
      // Activity title input listeners
      if (activityTitle) {
        activityTitle.addEventListener('input', function() {
          updateActivityTitle(this.value);
        });
      }
      
      // Dashboard activity title input listener
      const activityTitleDashboard = document.getElementById('activity-title-dashboard');
      if (activityTitleDashboard) {
        activityTitleDashboard.addEventListener('input', function() {
          updateActivityTitle(this.value);
        });
      }
      
      // Initialize theme
      initTheme();
      
      // Load theme variant
      loadThemeVariant();
    });
  </script>
</body>
</html>